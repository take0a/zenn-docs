---
title: "Envoyå…¥é–€ï¼ˆãã®ï¼“ï¼‰Auth0 èªè¨¼"
emoji: "ðŸ›¡ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["envoy", "docker", "auth0", "webapi", "security"]
published: true
publication_name: "robon"
---

# ã¯ã˜ã‚ã«

ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚„Web APIç•Œéšˆã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åˆ¶å¾¡ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãªãã€ãƒ—ãƒ­ã‚­ã‚·ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ä½¿ã†ã®ã ã¨ã‹ã€‚ãã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰çš„ãªç«‹ã¡ä½ç½®ãªã®ãŒ Envoy ã•ã‚“ã€‚

[ï¼ˆãã®ï¼‘ï¼‰](https://zenn.dev/robon/articles/fc7feab5e77d59)ã¨[ï¼ˆãã®ï¼’ï¼‰](https://zenn.dev/robon/articles/2896faa9bbe72d)ã¯ã€Envoy ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå‚ç…§ã—ã¦ã„ã‚‹ Sandbox ã®ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãªãŒã‚‰å‹•ã‹ã™ã¨ã„ã†ã‚¹ã‚¿ã‚¤ãƒ«ã§ã—ãŸãŒã€ä»Šå›žã¯ã€ã‚ˆã‚Šæœ¬ç•ªã«è¿‘ã„è¨­å®šã‚’ç›®æŒ‡ã—ã¦ã€Auth0 ã¨ Envoy ã‚’çµ„ã¿åˆã‚ã›ã¦ã„ãã¾ã™ã€‚

# ã‚„ã£ã¦ã¿ãŸ
## ç’°å¢ƒæ§‹ç¯‰
### Envoy

ï¼ˆãã®ï¼‘ï¼‰ã¨ï¼ˆãã®ï¼’ï¼‰ã¯ã€Envoy ã•ã‚“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® Sandbox ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ clone ã—ã¦ã€å‹•ã‹ã—ãªãŒã‚‰ã€è¨­å®šã‚’èª­ã¿è§£ã„ã¦ãã¾ã—ãŸãŒã€Auth0 ã®ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“ã®ã§ã€Sandbox ã•ã‚“ã®æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€æ–°ãŸãªãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œã‚Šã¾ã—ãŸã€‚ï¼ˆã¾ã€ãƒ‘ã‚¯ãƒªã§ã™ï¼‰

https://github.com/take0a/envoy-samples

### Auth0

Auth0 ã•ã‚“ã§ã™ã€‚

https://auth0.com/jp

#### Sign up

Sign-up ã¯ã€[ã“ã“](https://auth0.com/signup)ã‹ã‚‰ã‚„ã‚Šã¾ã—ãŸã€‚ä»Šå›žã¯ã€ä¸Šã® GitHub ã«è³‡æã‚’æ®‹ã™ã®ã§ã€`Continue with GitHub` ã—ã¾ã—ãŸãŒã€ãŠå¥½ããªæ–¹æ³•ã§è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚ã“ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã ã¨ Auth0 ã¨ GitHub ã®ç”»é¢ã‚’å¾€å¾©ã—ã¦ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”»é¢ã¸é·ç§»ã—ã¾ã™ã€‚

`Accout Type` ã¯ `Other`ã€‚æ—¥æœ¬ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã—ãŸã‹ã£ãŸã®ã§ã€`I need advanced settings` ã¯ãƒã‚§ãƒƒã‚¯ã§ `Next` ã—ã¦ã€`Tenant Domain` ã‚’ `take0a.jp.auth0.com` ã«ã—ã¦ `Create Account` ã—ã¾ã—ãŸã€‚

#### Set up

Sign in ã—ã¦ã€`Applications` ã® `APIs` ã§ `Create API` ã—ã¾ã™ã€‚

| é …ç›® | å€¤ |
|----|----|
| Name | Auth0 API for Envoy Blog |
| Identifier | https://zenn.dev/take0a |
| JSON Web Token (JWT) Profile | Auth0 |
| JSON Web Token (JWT) Signing Algorithm | RS256 | 

`Create` ã™ã‚‹ã¨ã€API ã®ç”»é¢ã«é·ç§»ã™ã‚‹ã®ã§ã€`Test` ã‚¿ãƒ–ã¸è¡Œã£ãŸ `CURL` ã§å¿…è¦ãªæƒ…å ±ã¯ã€ã ã„ãŸã„æƒã„ã¾ã™ã€‚ï¼ˆ... ã§çœç•¥ã—ã¦ã‚ã‚Šã¾ã™ã€‚è‡ªåˆ†ã®ã§ã‚„ã‚Šã¾ã—ã‚‡ã†ï¼‰

```bash : CURL
curl --request POST \
  --url https://take0a.jp.auth0.com/oauth/token \
  --header 'content-type: application/json' \
  --data '{"client_id":"KEt...Ny","client_secret":"FFl...j_","audience":"https://zenn.dev/take0a","grant_type":"client_credentials"}'
```

```json : Response
{
  "access_token": "eyJ...Kw",
  "token_type": "Bearer"
}
```

ã‚ã¨ã¯ã€è¦‹ã¤ã‘ã«ãã„ã¨ã“ã‚ã§ã€`Applications` ã® `APIs` ã§ã¯ãªãã¦ã€`Applications` ã® `Applications` ã‹ã‚‰ `Settings` ã‚¿ãƒ–ã®ä¸€ç•ªä¸‹ã®æ–¹ã« `Advanced Settings` ã¨ã„ã†ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã§éš ã—ãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã®ã§ã€ãã“ã® `Endpoints` ã‚¿ãƒ–ã¸è¡Œãã¨ã€ã‚ã¨ã§ä½¿ã† `JSON Web Key Set` ã® URL ã‚’ç¢ºèªã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## take0a/envoy-samples/auth0
### ï¼ˆãã®ï¼’ï¼‰ã®å¾©è®

ç’°å¢ƒæ§‹ç¯‰ã®ã¨ã“ã‚ã§ç´¹ä»‹ã—ãŸãƒªãƒã‚¸ãƒˆãƒªã‚’æŒã£ã¦ãã‚‹ã¨ã€ï¼ˆãã®ï¼’ï¼‰ã®å¤–éƒ¨èªè¨¼ãŒãªã„çŠ¶æ…‹ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```bash
$ docker-compose pull
Pulling upstream-service ... done
Pulling front-envoy      ... done

$ docker-compose up --build -d
Creating network "auth0_default" with the default driver
Creating auth0_upstream-service_1 ... done
Creating auth0_front-envoy_1      ... done

$ docker-compose ps
Name                        Command                  State                              Ports                       
------------------------------------------------------------------------------------------------------------------------------
auth0_front-envoy_1        /docker-entrypoint.sh /bin ...   Up             10000/tcp, 0.0.0.0:8000->8000/tcp,:::8000->8000/tcp
auth0_upstream-service_1   python3 /code/service.py         Up (healthy)

$ curl -v localhost:8000/service
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< content-type: text/plain; charset=utf-8
< content-length: 29
< date: Mon, 04 Nov 2024 04:39:45 GMT
< server: envoy
< x-envoy-upstream-service-time: 0
< 
* Connection #0 to host localhost left intact
Hello None from behind Envoy!
```

ã“ã“ã¾ã§ã®èª¬æ˜Žã¯ã€ï¼ˆãã®ï¼’ï¼‰ã¾ã§ã§ã—ã¦ã„ã¾ã™ã®ã§ã€ã¾ã ã®æ–¹ã¯ã€[ï¼ˆãã®ï¼’ï¼‰](https://zenn.dev/robon/articles/2896faa9bbe72d)ã§ã”ç¢ºèªãã ã•ã„ã€‚

### Auth0 èªè¨¼

ï¼ˆãã®ï¼’ï¼‰ã¨åŒã˜ã‚ˆã†ã«ã€`front-envoy` ã® Yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ï¼ˆå‡ºåŠ›ã‚’çœç•¥ã—ãªãŒã‚‰ï¼‰å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
$ docker-compose down
$ FRONT_ENVOY_YAML=config/auth0/v3.yaml docker-compose up --build -d
$ docker-compose ps
```

å…ˆã»ã©ã¨åŒæ§˜ã«å‘¼ã³å‡ºã—ã¾ã™ãŒã€JWT ãŒç„¡ã„ãŸã‚ã€401 ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

```bash
$ curl -v localhost:8000/service
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> 
< HTTP/1.1 401 Unauthorized
< www-authenticate: Bearer realm="http://localhost:8000/service"
< content-length: 14
< content-type: text/plain
< date: Mon, 04 Nov 2024 04:58:41 GMT
< server: envoy
< 
* Connection #0 to host localhost left intact
Jwt is missing
```

ä¸Šã§è¦‹ãŸ Auth0 ã® Test ã‚¿ãƒ–ã® Response ã® `access_token` ã‚’æ¸¡ã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³

```bash
$ curl -v localhost:8000/service --header 'authorization: Bearer eyJ...Ig'
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> authorization: Bearer eyJ...Ig
> 
< HTTP/1.1 200 OK
< content-type: text/plain; charset=utf-8
< content-length: 29
< date: Mon, 04 Nov 2024 05:00:58 GMT
< server: envoy
< x-envoy-upstream-service-time: 0
< 
* Connection #0 to host localhost left intact
Hello None from behind Envoy!
```

ã¨ã„ã†æ„Ÿã˜ã«ã€Auth0 ã‹ã‚‰å¾—ãŸ JWT ã‚’ Auth0 ã«æ¤œè¨¼ã—ã¦ã‚‚ã‚‰ã†è¨­å®šã§ã™ã€‚ã¾ãšã¯ã€`http_filters` ã®è¿½åŠ ç®‡æ‰€

https://github.com/take0a/envoy-samples/blob/master/auth0/config/auth0/v3.yaml#L26-L45

ãã—ã¦ã€Auth0 è¡Œãã®å®›å…ˆã¨ãªã‚‹ `clusters` ã®è¿½åŠ ç®‡æ‰€

https://github.com/take0a/envoy-samples/blob/master/auth0/config/auth0/v3.yaml#L65-L83

ã“ã®ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã§ã€Auth0 ã® JWT ã‚’åˆ©ç”¨ã—ãŸå¤–éƒ¨èªè¨¼ã‚‚å¯èƒ½ã§ã™ã€å½“ç„¶ã§ã™ãŒã€`take0a` ã¨æ›¸ã„ã¦ã‚ã‚‹ç®‡æ‰€ã¯ã€ã”è‡ªåˆ†ã® Auth0 ã®è¨­å®šã«æ›¸ãæ›ãˆãªã„ã¨å‹•ãã¾ã›ã‚“ã®ã§ã€ã”æ³¨æ„ãã ã•ã„ã€‚

# ãŠã‚ã‚Šã«

ãªã‚“ã‹ã€ã™ã‚“ãªã‚Šã€ã§ããŸã£ã½ãæ›¸ãã¾ã—ãŸãŒã€Auth0 ã® Sign-up ã§ãƒ“ãƒ“ã‚Šã€Envoy ã®è¨­å®šã§ã¯ã€`Jwks remote fetch is failed` ã«æ‚©ã¾ã•ã‚Œã¾ã—ãŸã€‚ãƒ“ãƒ“ã£ãŸã®ã¯ã¨ã‚‚ã‹ãã¨ã—ã¦ã€ã‚¨ãƒ©ãƒ¼ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ãƒšãƒ¼ã‚¸ã«åŠ©ã‘ã¦ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚

https://www.emmanuelgautier.com/blog/envoy-jwks-remote-fetch-failed

ç§ã®å ´åˆã¯ã€`dns_lookup_family: V4_ONLY` ã‚’è¨­å®šã—ã¦ã„ãªã‹ã£ãŸã“ã¨ã§ã€Envoy ã¯ã€IPv6 ã‚’å„ªå…ˆã™ã‚‹ãã†ãªã®ã§ã€IPv6 ãŒè‡ªç”±ã«ä½¿ãˆãªã„ç’°å¢ƒã§å®Ÿè¡Œã•ã‚Œã‚‹å ´åˆã¯ã€`V4_ONLY` ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ï¼ˆã†ã¡ã®ä¼šç¤¾ã®å ´åˆã¯ã€è‡ªåˆ†ãŒã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®é–‹ç™ºç’°å¢ƒã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã« IPv6 ã‚’é€šã—ã¦ãªã„ã‹ã‚‰ãªã‚“ã§ã™ãŒï¼‰

ãã‚Œã§ã¯ã€ç¬¬ï¼”å›žãŒã‚ã‚Œã°ï¼ˆç¬‘ï¼‰ã€ç¬¬ï¼”å›žã§ã€‚

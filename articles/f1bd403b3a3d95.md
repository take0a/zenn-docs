---
title: "dbtå…¥é–€"
emoji: "ğŸ› "
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "dbt", "uv", "duckdb"]
published: true
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
å‘¨å›é…ã‚Œã§ã¯ã‚ã‚Šã¾ã™ãŒã€ãƒ¢ãƒ€ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ã‚’å§‹ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚
ãƒ¢ãƒ€ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚¿ãƒƒã‚¯ã®ä¸­ã§ã‚‚ã€ELT ã® T ã®éƒ¨åˆ†ã¯ dbt ä¸€æŠã®ã‚ˆã†ãªã®ã§ã€dbt å…¥é–€ã—ã¦ã¿ã¾ã™ã€‚

# ã‚„ã£ã¦ã¿ã‚‹
åŸºæœ¬ã¯ã€ä»¥ä¸‹ã®æµã‚Œã«ã—ãŸã„ã¨æ€ã„ã¾ã™ãŒã€é–¢é€£ãƒªãƒ³ã‚¯ã‚’é£›ã³ãªãŒã‚‰ã‚„ã‚ã†ã¨æ€ã„ã¾ã™ã€‚

https://docs.getdbt.com/guides/manual-install?step=1

## uv ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹

```
$ uv --version
uv 0.6.10
$ mkdir dbt-tutorial
$ cd dbt-tutorial
$ uv init
Initialized project `dbt-tutorial`
$ uv venv
Using CPython 3.9.20 interpreter at: /usr/bin/python3.9
Creating virtual environment at: .venv
$ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ main.py
â””â”€â”€ pyproject.toml
```

```py: main.py
def main():
    print("Hello from dbt-tutorial!")


if __name__ == "__main__":
    main()
```

```toml: pyroject.toml
[project]
name = "dbt-tutorial"
version = "0.1.0"
description = "Add your description here"
readme = "README.md"
requires-python = ">=3.9"
dependencies = []
```

## dbt Core ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹

DuckDB ã§è©¦ãã†ã¨æ€ã†ã®ã§ã€ä»¥ä¸‹ã‚’å‚è€ƒã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

https://docs.getdbt.com/docs/core/connect-data-platform/duckdb-setup

```
$ uv add dbt-core dbt-duckdb
Resolved 55 packages in 280ms
Installed 52 packages in 83ms
:
 + zipp==3.21.0
$ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ main.py
â”œâ”€â”€ pyproject.toml
â””â”€â”€ uv.lock
```

```diff toml:pyroject.toml
@@ -4,4 +4,7 @@ version = "0.1.0"
 description = "Add your description here"
 readme = "README.md"
 requires-python = ">=3.9"
-dependencies = []
+dependencies = [
+    "dbt-core>=1.9.4",
+    "dbt-duckdb>=1.9.2",
+]
```

## [dbt ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=3)

```
$ uv run dbt --version
/home/ec2-user/work/mds/dbt-tutorial/.venv/lib64/python3.9/site-packages/networkx/utils/backends.py:135: RuntimeWarning: networkx backend defined more than once: nx-loopback
  backends.update(_get_backends("networkx.backends"))
Core:
  - installed: 1.9.4
  - latest:    1.9.4 - Up to date!

Plugins:
  - duckdb: 1.9.2 - Up to date!
```

ã“ã‚“ãªæ„Ÿã˜ã§è­¦å‘ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€Python ã‚’ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã—ã¾ã™ã€‚

https://github.com/networkx/networkx/issues/7101

```
$ uv python pin 3.12
Updated `.python-version` from `3.9` -> `3.12`
$ uv run dbt --version
Using CPython 3.12.9
Removed virtual environment at: .venv
Creating virtual environment at: .venv
Installed 52 packages in 34ms
Core:
  - installed: 1.9.4
  - latest:    1.9.4 - Up to date!

Plugins:
  - duckdb: 1.9.2 - Up to date!
```

### init ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ jaffle_shop ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é–‹å§‹ã—ã¾ã™

```
$ uv run dbt init jaffle_shop
01:18:45  Running with dbt=1.9.4
01:18:45  [ConfigFolderDirectory]: Unable to parse logging event dictionary. Failed to parse dir field: expected string or bytes-like object, got 'PosixPath'.. Dictionary: {'dir': PosixPath('/home/ec2-user/.dbt')}
01:18:45  Creating dbt configuration folder at 
01:18:45  
Your new dbt project "jaffle_shop" was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don't hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!

01:18:45  Setting up your profile.
Which database would you like to use?
[1] duckdb

(Don't see the one you want? https://docs.getdbt.com/docs/available-adapters)

Enter a number: 1
01:19:33  Profile jaffle_shop written to /home/ec2-user/.dbt/profiles.yml using target's sample configuration. Once updated, you'll be able to start developing with dbt.
$ tree
.
â”œâ”€â”€ README.md
â”œâ”€â”€ jaffle_shop
â”‚   â”œâ”€â”€ README.md
â”‚   â”œâ”€â”€ analyses
â”‚   â”œâ”€â”€ dbt_project.yml
â”‚   â”œâ”€â”€ macros
â”‚   â”œâ”€â”€ models
â”‚   â”‚   â””â”€â”€ example
â”‚   â”‚       â”œâ”€â”€ my_first_dbt_model.sql
â”‚   â”‚       â”œâ”€â”€ my_second_dbt_model.sql
â”‚   â”‚       â””â”€â”€ schema.yml
â”‚   â”œâ”€â”€ seeds
â”‚   â”œâ”€â”€ snapshots
â”‚   â””â”€â”€ tests
â”œâ”€â”€ logs
â”‚   â””â”€â”€ dbt.log
â”œâ”€â”€ main.py
â”œâ”€â”€ pyproject.toml
â””â”€â”€ uv.lock
```

```yaml: dbt_project.yml
# Name your project! Project names should contain only lowercase characters
# and underscores. A good package name should reflect your organization's
# name or the intended use of these models
name: 'jaffle_shop'
version: '1.0.0'

# This setting configures which "profile" dbt uses for this project.
profile: 'jaffle_shop'

# These configurations specify where dbt should look for different types of files.
# The `model-paths` config, for example, states that models in this project can be
# found in the "models/" directory. You probably won't need to change these!
model-paths: ["models"]
analysis-paths: ["analyses"]
test-paths: ["tests"]
seed-paths: ["seeds"]
macro-paths: ["macros"]
snapshot-paths: ["snapshots"]

clean-targets:         # directories to be removed by `dbt clean`
  - "target"
  - "dbt_packages"


# Configuring models
# Full documentation: https://docs.getdbt.com/docs/configuring-models

# In this example config, we tell dbt to build all models in the example/
# directory as views. These settings can be overridden in the individual model
# files using the `{{ config(...) }}` macro.
models:
  jaffle_shop:
    # Config indicated by + and applies to all files under models/example/
    example:
      +materialized: view
```

ã‚³ãƒãƒ³ãƒ‰ã®æœ€å¾Œã§ duckdb ã‚’é¸ã‚“ã ã‹ã‚‰ã‹ã€~/.dbt/profiles.yml ãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

```yaml: ~/.dbt/profiles.yml
jaffle_shop:
  outputs:
    dev:
      type: duckdb
      path: dev.duckdb
      threads: 1

    prod:
      type: duckdb
      path: prod.duckdb
      threads: 4

  target: dev
```

## [DuckDB ã«æ¥ç¶šã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=4)

```
$ cd jaffle_shop/
$ uv run dbt debug
01:40:53  Running with dbt=1.9.4
01:40:53  dbt version: 1.9.4
01:40:53  python version: 3.12.9
01:40:53  python path: /home/ec2-user/work/mds/dbt-tutorial/.venv/bin/python
01:40:53  os info: Linux-6.1.128-136.201.amzn2023.x86_64-x86_64-with-glibc2.34
01:40:53  Using profiles dir at /home/ec2-user/.dbt
01:40:53  Using profiles.yml file at /home/ec2-user/.dbt/profiles.yml
01:40:53  Using dbt_project.yml file at /home/ec2-user/work/mds/dbt-tutorial/jaffle_shop/dbt_project.yml
01:40:53  adapter type: duckdb
01:40:53  adapter version: 1.9.2
01:40:53  Configuration:
01:40:53    profiles.yml file [OK found and valid]
01:40:53    dbt_project.yml file [OK found and valid]
01:40:53  Required dependencies:
01:40:53   - git [OK found]

01:40:53  Connection:
01:40:53    database: dev
01:40:53    schema: main
01:40:53    path: dev.duckdb
01:40:53    config_options: None
01:40:53    extensions: None
01:40:53    settings: {}
01:40:53    external_root: .
01:40:53    use_credential_provider: None
01:40:53    attach: None
01:40:53    filesystems: None
01:40:53    remote: None
01:40:53    plugins: None
01:40:53    disable_transactions: False
01:40:53  Registered adapter: duckdb=1.9.2
01:40:53    Connection test: [OK connection ok]

01:40:53  All checks passed!
```

## [æœ€åˆã® dbt run](https://docs.getdbt.com/guides/manual-install?step=5)

```
$ uv run dbt run
01:45:20  Running with dbt=1.9.4
01:45:20  Registered adapter: duckdb=1.9.2
01:45:20  Unable to do partial parsing because saved manifest not found. Starting full parse.
01:45:21  Found 2 models, 4 data tests, 426 macros
01:45:21  
01:45:21  Concurrency: 1 threads (target='dev')
01:45:21  
01:45:21  1 of 2 START sql table model main.my_first_dbt_model ........................... [RUN]
01:45:21  1 of 2 OK created sql table model main.my_first_dbt_model ...................... [OK in 0.05s]
01:45:21  2 of 2 START sql view model main.my_second_dbt_model ........................... [RUN]
01:45:21  2 of 2 OK created sql view model main.my_second_dbt_model ...................... [OK in 0.03s]
01:45:21  
01:45:21  Finished running 1 table model, 1 view model in 0 hours 0 minutes and 0.16 seconds (0.16s).
01:45:21  
01:45:21  Completed successfully
01:45:21  
01:45:21  Done. PASS=2 WARN=0 ERROR=0 SKIP=0 TOTAL=2
```

## [æœ€åˆã®ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=8)

https://docs.getdbt.com/guides/manual-install?step=8

ã“ã“ã¾ã§æ¥ã¦ã€DuckDB ã®ãƒ¢ãƒ‡ãƒ«ãŒç„¡ã‹ã£ãŸorzã€‚ã—ã‹ã‚‚ã€å‹•ã‹ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹ã‚’è¦‹ã‚‹ã‚ˆã†ã«æ›¸ã„ã¦ã‚ã£ãŸã®ã§â€¦

### [DuckDB ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠã](https://duckdb.org/docs/installation)

```bash
$ curl https://install.duckdb.org | sh
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  3270  100  3270    0     0  10085      0 --:--:-- --:--:-- --:--:-- 10092

*** DuckDB Linux/MacOS installation script, version 1.2.1 ***


         .;odxdl,            
       .xXXXXXXXXKc          
       0XXXXXXXXXXXd  cooo:  
      ,XXXXXXXXXXXXK  OXXXXd 
       0XXXXXXXXXXXo  cooo:  
       .xXXXXXXXXKc          
         .;odxdl,  


######################################################################## 100.0%

Successfully installed DuckDB binary to /home/ec2-user/.duckdb/cli/1.2.1/duckdb
  with a link from                      /home/ec2-user/.duckdb/cli/latest/duckdb

Hint: Append the following line to your shell profile:
export PATH='/home/ec2-user/.duckdb/cli/latest':$PATH

Also created a symlink from /home/ec2-user/.local/bin/duckdb 
                         to /home/ec2-user/.duckdb/cli/latest/duckdb

To launch DuckDB now, type
/home/ec2-user/.duckdb/cli/latest/duckdb
```

ã¨ã„ã†ã“ã¨ãªã®ã§ã€ã‚„ã£ã¦ã¿ã‚‹ã€‚ã•ã£ãã® dbt run ã§ dev.duckdb ãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ãã¦ã„ãŸã®ã§

```
$ ~/.duckdb/cli/latest/duckdb 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
D .open dev.duckdb
D .tables
my_first_dbt_model   my_second_dbt_model
D select * from my_first_dbt_model;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚
â”‚ int32 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     1 â”‚
â”‚  NULL â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜
D .exit
```

### ãƒ¢ãƒ‡ãƒ«

DuckDB ã®ã‚±ãƒ¼ã‚¹ã¯ç„¡ã„ã®ã§ã™ãŒã€ä»–ã®ã‚±ãƒ¼ã‚¹ã‚‚ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ã€ã‚‚ã†å°‘ã—æ¢ã™ã¨ã€[ã“ã“](https://github.com/dbt-labs/jaffle_shop_duckdb/)ã‹ã‚‰æŒã£ã¦ãã‚‹ã“ã¨ã‚’æœŸå¾…ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://docs.getdbt.com/guides/duckdb?step=3

ãªã®ã§ã€æŒã£ã¦ãã¾ã™ã€‚ã¾ãšã¯ã€seeds ã®ä¸‹ã®ï¼“ã¤ã® .csv ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€dbt seed ã—ã¾ã™ã€‚ï¼ˆçµå±€ã€ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã¯ã€ã“ã®ï¼“ã¤ã® .csv ã®ã¿ã§ã—ãŸï¼‰

```
$ uv run dbt seed
03:56:21  Running with dbt=1.9.4
03:56:21  Registered adapter: duckdb=1.9.2
03:56:21  Found 3 models, 4 data tests, 3 seeds, 426 macros
03:56:22  
03:56:22  Concurrency: 1 threads (target='dev')
03:56:22  
03:56:22  1 of 3 START seed file main.raw_customers ...................................... [RUN]
03:56:22  1 of 3 OK loaded seed file main.raw_customers .................................. [INSERT 100 in 0.05s]
03:56:22  2 of 3 START seed file main.raw_orders ......................................... [RUN]
03:56:22  2 of 3 OK loaded seed file main.raw_orders ..................................... [INSERT 99 in 0.02s]
03:56:22  3 of 3 START seed file main.raw_payments ....................................... [RUN]
03:56:22  3 of 3 OK loaded seed file main.raw_payments ................................... [INSERT 113 in 0.01s]
03:56:22  
03:56:22  Finished running 3 seeds in 0 hours 0 minutes and 0.16 seconds (0.16s).
03:56:22  
03:56:22  Completed successfully
03:56:22  
03:56:22  Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
```

ãã‚Œã‹ã‚‰ã€models/customers.sql ã‚’ä»¥ä¸‹ã®å†…å®¹ã§ä½œæˆã—ã¾ã™ã€‚

```sql: models/customer.sql
with customers as (

    select
        id as customer_id,
        first_name,
        last_name

    from {{ ref('raw_customers') }}

),

orders as (

    select
        id as order_id,
        user_id as customer_id,
        order_date,
        status

    from {{ ref('raw_orders') }}

),

customer_orders as (

    select
        customer_id,

        min(order_date) as first_order_date,
        max(order_date) as most_recent_order_date,
        count(order_id) as number_of_orders

    from orders

    group by 1

),

final as (

    select
        customers.customer_id,
        customers.first_name,
        customers.last_name,
        customer_orders.first_order_date,
        customer_orders.most_recent_order_date,
        coalesce(customer_orders.number_of_orders, 0) as number_of_orders

    from customers

    left join customer_orders using (customer_id)

)

select * from final
```

ãã—ã¦ã€dbt run ã—ã¾ã™ã€‚

```
$ uv run dbt run
03:59:26  Running with dbt=1.9.4
03:59:26  Registered adapter: duckdb=1.9.2
03:59:26  Found 3 models, 4 data tests, 3 seeds, 426 macros
03:59:26  
03:59:26  Concurrency: 1 threads (target='dev')
03:59:26  
03:59:26  1 of 3 START sql view model main.customers ..................................... [RUN]
03:59:26  1 of 3 OK created sql view model main.customers ................................ [OK in 0.05s]
03:59:26  2 of 3 START sql table model main.my_first_dbt_model ........................... [RUN]
03:59:26  2 of 3 OK created sql table model main.my_first_dbt_model ...................... [OK in 0.04s]
03:59:26  3 of 3 START sql view model main.my_second_dbt_model ........................... [RUN]
03:59:26  3 of 3 OK created sql view model main.my_second_dbt_model ...................... [OK in 0.02s]
03:59:26  
03:59:26  Finished running 1 table model, 2 view models in 0 hours 0 minutes and 0.19 seconds (0.19s).
03:59:26  
03:59:26  Completed successfully
03:59:26  
03:59:26  Done. PASS=3 WARN=0 ERROR=0 SKIP=0 TOTAL=3
```

DuckDB ã§ç¢ºèªã—ã¾ã™ã€‚

```
$ ~/.duckdb/cli/latest/duckdb 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
D .open dev.duckdb
D .tables
customers            my_second_dbt_model  raw_orders         
my_first_dbt_model   raw_customers        raw_payments       
D select * from customers;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id â”‚ first_name â”‚ last_name â”‚ first_order_date â”‚ most_recent_order_date â”‚ number_of_orders â”‚
â”‚    int32    â”‚  varchar   â”‚  varchar  â”‚       date       â”‚          date          â”‚      int64       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           1 â”‚ Michael    â”‚ P.        â”‚ 2018-01-01       â”‚ 2018-02-10             â”‚                2 â”‚
â”‚           2 â”‚ Shawn      â”‚ M.        â”‚ 2018-01-11       â”‚ 2018-01-11             â”‚                1 â”‚
â”‚           3 â”‚ Kathleen   â”‚ P.        â”‚ 2018-01-02       â”‚ 2018-03-11             â”‚                3 â”‚
â”‚           6 â”‚ Sarah      â”‚ R.        â”‚ 2018-02-19       â”‚ 2018-02-19             â”‚                1 â”‚
â”‚           7 â”‚ Martin     â”‚ M.        â”‚ 2018-01-14       â”‚ 2018-01-14             â”‚                1 â”‚
â”‚           8 â”‚ Frank      â”‚ R.        â”‚ 2018-01-29       â”‚ 2018-03-12             â”‚                2 â”‚
â”‚           9 â”‚ Jennifer   â”‚ F.        â”‚ 2018-03-17       â”‚ 2018-03-17             â”‚                1 â”‚
â”‚          11 â”‚ Fred       â”‚ S.        â”‚ 2018-03-23       â”‚ 2018-03-23             â”‚                1 â”‚
â”‚          12 â”‚ Amy        â”‚ D.        â”‚ 2018-03-03       â”‚ 2018-03-03             â”‚                1 â”‚
â”‚          13 â”‚ Kathleen   â”‚ M.        â”‚ 2018-03-07       â”‚ 2018-03-07             â”‚                1 â”‚
â”‚          16 â”‚ Amanda     â”‚ H.        â”‚ 2018-02-02       â”‚ 2018-02-02             â”‚                1 â”‚
â”‚          18 â”‚ Johnny     â”‚ K.        â”‚ 2018-02-27       â”‚ 2018-02-27             â”‚                1 â”‚
â”‚          19 â”‚ Virginia   â”‚ F.        â”‚ 2018-03-16       â”‚ 2018-03-16             â”‚                1 â”‚
â”‚          20 â”‚ Anna       â”‚ A.        â”‚ 2018-01-23       â”‚ 2018-01-23             â”‚                1 â”‚
â”‚          21 â”‚ Willie     â”‚ H.        â”‚ 2018-03-28       â”‚ 2018-03-28             â”‚                1 â”‚
â”‚          22 â”‚ Sean       â”‚ H.        â”‚ 2018-01-26       â”‚ 2018-03-01             â”‚                3 â”‚
â”‚          25 â”‚ Victor     â”‚ H.        â”‚ 2018-01-17       â”‚ 2018-03-20             â”‚                2 â”‚
â”‚          26 â”‚ Aaron      â”‚ R.        â”‚ 2018-02-11       â”‚ 2018-03-08             â”‚                2 â”‚
â”‚          27 â”‚ Benjamin   â”‚ B.        â”‚ 2018-02-21       â”‚ 2018-04-04             â”‚                2 â”‚
â”‚          28 â”‚ Lisa       â”‚ W.        â”‚ 2018-02-04       â”‚ 2018-02-04             â”‚                1 â”‚
â”‚           Â· â”‚  Â·         â”‚ Â·         â”‚  Â·               â”‚  Â·                     â”‚                Â· â”‚
â”‚           Â· â”‚  Â·         â”‚ Â·         â”‚  Â·               â”‚  Â·                     â”‚                Â· â”‚
â”‚           Â· â”‚  Â·         â”‚ Â·         â”‚  Â·               â”‚  Â·                     â”‚                Â· â”‚
â”‚          60 â”‚ Norma      â”‚ W.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          61 â”‚ Timothy    â”‚ R.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          62 â”‚ Elizabeth  â”‚ P.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          65 â”‚ Brenda     â”‚ W.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          67 â”‚ Michael    â”‚ H.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          72 â”‚ Kathryn    â”‚ O.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          73 â”‚ Alan       â”‚ B.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          74 â”‚ Harry      â”‚ A.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          75 â”‚ Andrea     â”‚ H.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          77 â”‚ Anne       â”‚ W.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          78 â”‚ Harry      â”‚ H.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          81 â”‚ Shirley    â”‚ H.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          82 â”‚ Arthur     â”‚ D.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          83 â”‚ Virginia   â”‚ R.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          87 â”‚ Phillip    â”‚ B.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          95 â”‚ Lisa       â”‚ P.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          96 â”‚ Jacqueline â”‚ A.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          97 â”‚ Shirley    â”‚ D.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚          98 â”‚ Nicole     â”‚ M.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”‚         100 â”‚ Jean       â”‚ M.        â”‚ NULL             â”‚ NULL                   â”‚                0 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 100 rows (40 shown)                                                                       6 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select view_name from duckdb_views;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      view_name      â”‚
â”‚       varchar       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ customers           â”‚
â”‚ my_second_dbt_model â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .exit
```

å‰æŒ¯ã‚Šã§ã€customers ãŒ view ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã€æ¬¡ã¸é€²ã¿ã¾ã™ã€‚

## [ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºã®æ–¹æ³•ã‚’å¤‰æ›´ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=9)

```diff yaml:dbt_project.yml
@@ -31,6 +31,7 @@
 # files using the `{{ config(...) }}` macro.
 models:
   jaffle_shop:
+    +materialized: table
     # Config indicated by + and applies to all files under models/example/
     example:
       +materialized: view
```

ã¨ã—ã¦ã€`uv run dbt run` ã™ã‚‹ã¨ã€customers ã¯ã€table ã«ãªã‚Šã€

```diff sql:models/customers.sql
@@ -1,3 +1,9 @@
+{{
+  config(
+    materialized='view'
+  )
+}}
+
 with customers as (
 
     select
```

ã¨ã—ã¦ã€`uv run dbt run` ã™ã‚‹ã¨ã€customers ã¯ã€view ã«ãªã‚Šã¾ã™ã€‚

## [ã‚µãƒ³ãƒ—ãƒ«ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=10)

```
$ rm -rf models/example/
```

```diff yaml:dbt_project.yml
@@ -32,6 +32,3 @@
 models:
   jaffle_shop:
     +materialized: table
-    # Config indicated by + and applies to all files under models/example/
-    example:
-      +materialized: view
```

## [ä»–ã®ãƒ¢ãƒ‡ãƒ«ã®ä¸Šã«ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=11)

ä»¥ä¸‹ã‚’ models/customers.sql ã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä½œæˆã—ã¾ã™ã€‚

```sql: models/stg_customers.sql
select
    id as customer_id,
    first_name,
    last_name

from {{ ref('raw_customers') }}
```

```sql: models/stg_orders.sql
select
    id as order_id,
    user_id as customer_id,
    order_date,
    status

from {{ ref('raw_orders') }}
```

ä¸Šã§åˆ‡ã‚Šå‡ºã—ãŸç®‡æ‰€ã‚’å‚ç…§ã™ã‚‹ã‚ˆã†ã«ã€customers.sql ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```diff sql:models/customers.sql
@@ -1,29 +1,12 @@
-{{
-  config(
-    materialized='view'
-  )
-}}
-
 with customers as (
 
-    select
-        id as customer_id,
-        first_name,
-        last_name
-
-    from {{ ref('raw_customers') }}
+    select * from {{ ref('stg_customers') }}
 
 ),
 
 orders as (
 
-    select
-        id as order_id,
-        user_id as customer_id,
-        order_date,
-        status
-
-    from {{ ref('raw_orders') }}
+    select * from {{ ref('stg_orders') }}
 
 ),
```

`uv run dbt run` ã—ã¦ã€ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚

## [ãƒ¢ãƒ‡ãƒ«ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=12)

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```yaml: models/schema.yml
version: 2

models:
  - name: customers
    columns:
      - name: customer_id
        tests:
          - unique
          - not_null

  - name: stg_customers
    columns:
      - name: customer_id
        tests:
          - unique
          - not_null

  - name: stg_orders
    columns:
      - name: order_id
        tests:
          - unique
          - not_null
      - name: status
        tests:
          - accepted_values:
              values: ['placed', 'shipped', 'completed', 'return_pending', 'returned']
      - name: customer_id
        tests:
          - not_null
          - relationships:
              to: ref('stg_customers')
              field: customer_id
```

`uv run dbt test` ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
$ uv run dbt test
04:50:53  Running with dbt=1.9.4
04:50:53  Registered adapter: duckdb=1.9.2
04:50:53  Found 3 models, 3 seeds, 9 data tests, 426 macros
04:50:53  
04:50:53  Concurrency: 1 threads (target='dev')
04:50:53  
04:50:53  1 of 9 START test accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [RUN]
04:50:54  1 of 9 PASS accepted_values_stg_orders_status__placed__shipped__completed__return_pending__returned  [PASS in 0.03s]
04:50:54  2 of 9 START test not_null_customers_customer_id ............................... [RUN]
04:50:54  2 of 9 PASS not_null_customers_customer_id ..................................... [PASS in 0.01s]
04:50:54  3 of 9 START test not_null_stg_customers_customer_id ........................... [RUN]
04:50:54  3 of 9 PASS not_null_stg_customers_customer_id ................................. [PASS in 0.01s]
04:50:54  4 of 9 START test not_null_stg_orders_customer_id .............................. [RUN]
04:50:54  4 of 9 PASS not_null_stg_orders_customer_id .................................... [PASS in 0.01s]
04:50:54  5 of 9 START test not_null_stg_orders_order_id ................................. [RUN]
04:50:54  5 of 9 PASS not_null_stg_orders_order_id ....................................... [PASS in 0.01s]
04:50:54  6 of 9 START test relationships_stg_orders_customer_id__customer_id__ref_stg_customers_  [RUN]
04:50:54  6 of 9 PASS relationships_stg_orders_customer_id__customer_id__ref_stg_customers_  [PASS in 0.01s]
04:50:54  7 of 9 START test unique_customers_customer_id ................................. [RUN]
04:50:54  7 of 9 PASS unique_customers_customer_id ....................................... [PASS in 0.01s]
04:50:54  8 of 9 START test unique_stg_customers_customer_id ............................. [RUN]
04:50:54  8 of 9 PASS unique_stg_customers_customer_id ................................... [PASS in 0.01s]
04:50:54  9 of 9 START test unique_stg_orders_order_id ................................... [RUN]
04:50:54  9 of 9 PASS unique_stg_orders_order_id ......................................... [PASS in 0.01s]
04:50:54  
04:50:54  Finished running 9 data tests in 0 hours 0 minutes and 0.18 seconds (0.18s).
04:50:54  
04:50:54  Completed successfully
04:50:54  
04:50:54  Done. PASS=9 WARN=0 ERROR=0 SKIP=0 TOTAL=9
```

## [ãƒ¢ãƒ‡ãƒ«ã‚’æ–‡ç« åŒ–ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=13)

ä»¥ä¸‹ã®ã‚ˆã†ã« models/schema.yml ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```diff yaml:models/schema.yml
@@ -2,22 +2,30 @@ version: 2
 
 models:
   - name: customers
+    description: One record per customer
     columns:
       - name: customer_id
+        description: Primary key
         tests:
           - unique
           - not_null
+      - name: first_order_date
+        description: NULL when a customer has not yet placed an order.
 
   - name: stg_customers
+    description: This model cleans up customer data
     columns:
       - name: customer_id
+        description: Primary key
         tests:
           - unique
           - not_null
 
   - name: stg_orders
+    description: This model cleans up order data
     columns:
       - name: order_id
+        description: Primary key
         tests:
           - unique
           - not_null
```

`uv run dbt docs serve` ã—ã¦ç¢ºèªã™ã‚‹ã“ã¨ã«ãªã£ã¦ã„ã¾ã™ãŒã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ€ãƒ³ãƒãƒªã§ã—ãŸã€‚
`uv run dbt docs generate` ã¯ã€ç¢ºèªã§ãã¾ã—ãŸã€‚

```
$ wget localhost:8080
--2025-04-06 05:05:05--  http://localhost:8080/
Resolving localhost (localhost)... 127.0.0.1
Connecting to localhost (localhost)|127.0.0.1|:8080... connected.
HTTP request sent, awaiting response... 
```

:::message
2025/5/13 è¿½è¨˜
`uv run dbt docs serve` ãŒå‹•ã‹ãªã„ä»¶ã€å®Œå…¨ã§ã¯ãªã„ã§ã™ãŒã€ãƒ‡ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§ã€ãƒ›ã‚¹ãƒˆåã«ç©ºæ–‡å­—ã‚’æŒ‡å®šã‚’ã™ã‚‹ã¨å‹•ãã¾ã—ãŸã€‚
```
$ uv run dbt docs serve -d --host ""
08:10:55  Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2217ca180>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff2211e17f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff221135cd0>]}
08:10:55  Running with dbt=1.9.4
08:10:55  running dbt with arguments {'printer_width': '80', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'write_json': 'True', 'partial_parse': 'True', 'cache_selected_only': 'False', 'warn_error': 'None', 'version_check': 'True', 'fail_fast': 'False', 'log_path': '/home/ec2-user/work/mds/dbt-tutorial/jaffle_shop/logs', 'debug': 'True', 'profiles_dir': '/home/ec2-user/.dbt', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'quiet': 'False', 'empty': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt docs serve -d --host ', 'target_path': 'None', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True'}
08:10:55  Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '67b65f16-058c-4ebf-915d-94e234fd7b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff222589d00>]}
08:10:55  Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '67b65f16-058c-4ebf-915d-94e234fd7b47', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x7ff22161ffb0>]}
Serving docs at 8080
To access from your browser, navigate to: http://localhost:8080



Press Ctrl+C to exit.
127.0.0.1 - - [13/May/2025 08:10:56] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [13/May/2025 08:10:57] "GET /manifest.json?cb=1747123857163 HTTP/1.1" 200 -
127.0.0.1 - - [13/May/2025 08:10:57] "GET /catalog.json?cb=1747123857163 HTTP/1.1" 200 -
```
ãŸã ã€æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€`Ctrlï¼‹C` ã§æ­¢ã‚ã¦ã‚‚æ­£å¸¸çµ‚äº†ã—ãªã„ã‚ˆã†ã§ã€Port ãŒé–‹ã„ãŸã¾ã¾ã«ãªã£ãŸã‚Šã—ã¾ã™ã€‚
è‡ªåˆ†ã®ç’°å¢ƒãŒã€Windows ç‰ˆã® VSCode ã‹ã‚‰ Remote Development ã§ EC2 ã® Amazon Linux 2023 ã¨ã„ã†ã“ã¨ã‚‚é–¢ä¿‚ã—ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
:::

## [ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹](https://docs.getdbt.com/guides/manual-install?step=15)

ã“ã¡ã‚‰ã¯ã€dbt Cloud ãŒå¯¾è±¡ã®ã‚ˆã†ãªã®ã§ã€çœç•¥ã—ã¾ã™ã€‚

# ãŠã‚ã‚Šã«

dbt ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è³ªã‚‚é«˜ãã€é‡ã‚‚å¤šãã¦ã€ç´ æ™´ã‚‰ã—ã„ã®ã§ã™ãŒã€ç°¡å˜ã«å§‹ã‚ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒã‚ã‹ã‚Šã«ãã‹ã£ãŸã®ã§ã€DuckDB ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç’°å¢ƒã§è©¦ã™æ‰‹é †ã‚’ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

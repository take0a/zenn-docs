---
title: "GCEã‚‚Mashuã‚‚æ°¸ä¹…ç„¡æ–™æ ã§ã‚¯ãƒªãƒ¼ãƒ³ã«è©•ä¾¡ã™ã‚‹"
emoji: "ğŸ’§"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["mashu", "gce", "ubuntu", "postgresql", "docker"]
published: true
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
å½“ç¤¾ã®æä¾›ã—ã¦ã„ã‚‹Mashuã¨ã„ã†ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚
https://services.robon.co.jp/mashu

Mashuã¯ã€30ãƒ†ãƒ¼ãƒ–ãƒ«ã¾ã§ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ç™»éŒ²ä¸è¦ï¼ˆï¼ç„¡æ–™ï¼‰ãªã®ã§ã€Windows PCä¸€å°ã§ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®RDBMSï¼ˆOracleï¼‰æ¥ç¶šã‚’è©•ä¾¡ã™ã‚‹è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚
https://zenn.dev/robon/articles/df4cea32587479

ã§ã™ãŒã€ä¼šç¤¾ã®PCã«Dockerã¨ã‹Oracleã¨ã‹å…¥ã‚ŒãŸããªã„ã—â€¦ã¨ã„ã†æ–¹ã‚‚ã„ã‚‹ã‹ã‚‚ï¼Ÿã¨ã„ã†ã“ã¨ã§ã€GCEã®ç„¡æ–™æ ã‚’ä½¿ã£ã¦ã€ãã“ã«PostgreSQLã‚‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚Œã°ã€å®Œå…¨ç„¡æ–™ã§ã€ã©ã“ã«ã‚‚å½±éŸ¿ã‚’ä¸ãˆãšã«è©•ä¾¡ã§ãã‚‹ã˜ã‚ƒã‚“ã€‚ã¨ã„ã†è¨˜äº‹ã§ã™ã€‚

# è©•ä¾¡ã—ã‚ˆã†
## Google Compute Engineï¼ˆGCEï¼‰

https://cloud.google.com/free/docs/free-cloud-features?hl=ja#compute

ä¸Šè¨˜ã®ç¯„å›²ã ã¨ç„¡æ–™ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯ã€ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã¯ã‚¢ãƒ¡ãƒªã‚«ã®è¥¿å´ã‚ªãƒ¬ã‚´ãƒ³ï¼ˆus-west1ï¼‰ã«ã—ã¾ã™ã€‚

### Google Cloud Platformã®é–‹å§‹
`https://console.cloud.google.com/`ã‹ã‚‰å§‹ã‚ã¾ã™ã€‚ï¼ˆå¾Œå‡ºã—ãªã‚“ã§ã€åŠ¹ç‡è‰¯ãã‚‚æ›¸ã‘ã¾ã™ãŒã€
![](/images/11d5452efc3a6a/getting-started.png)
ã¾ãã€ã‚ã‚‹ã‚“ã§ã€Compute Engineã‚’é¸ã³ã¾ã™ã‚ˆã­ã€‚ã§ã€è¡Œãã¨
![](/images/11d5452efc3a6a/vm-instance.png)
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ãªã•ã„ã¨è¨€ã‚ã‚Œã‚‹ã®ã§å¾“ã„ã¾ã™ã€‚ï¼ˆã‚¿ãƒ€ã§æ©Ÿæ¢°ã®ä½“ãŒè²°ãˆã‚‹ã¨è¨€ãˆã°
![](/images/11d5452efc3a6a/new-project.png)
ãã—ã¦ã€APIã‚’æœ‰åŠ¹ã«ã™ã‚‹
![](/images/11d5452efc3a6a/product-details.png)
ã«ã¯ã€ãŠé‡‘ãŒå¿…è¦ã¨è¨€ã‚ã‚Œã¾ã™ã€‚
![](/images/11d5452efc3a6a/billing-required.png)
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€APIãŒæœ‰åŠ¹ã«ã§ãã¦ã€
![](/images/11d5452efc3a6a/vm-instance2.png)
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã€ç„¡æ–™ã«ãªã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚
![](/images/11d5452efc3a6a/create-instance1.png)
ã‚ªãƒ¬ã‚´ãƒ³ï¼ˆus-west1ï¼‰ã§ã€ãƒã‚·ãƒ³ã‚’e2-microã«ã—ã¦ã€
![](/images/11d5452efc3a6a/create-instance2.png)
ãƒ–ãƒ¼ãƒˆãƒ‡ã‚£ã‚¹ã‚¯ã‚’æ¨™æº–æ°¸ç¶šãƒ‡ã‚£ã‚¹ã‚¯30GBã«ã—ã¾ã™ã€‚ä»Šå›ã¯Ubuntuã«ã—ã¾ã—ãŸã€‚
![](/images/11d5452efc3a6a/create-instance3.png)
HTTPSã‚’é€šã—ãŸã„ã®ã§ã€ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’è¨±å¯ã—ã¦ãŠãã¾ã™ã€‚VMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä¸€è¦§ã«è¿½åŠ ã•ã‚Œã‚‹ã®ã§ã€ä¸€è¦§å†…ã®SSHãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ãƒ™ãƒ¼ã‚¹ã®SSHã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒä½¿ãˆã¾ã™ã€‚

## Ubuntuã®è¨­å®š
### åˆæœŸåŒ–
é€”ä¸­ã€ç¢ºèªã•ã‚Œã¾ã™ãŒã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯Yã§ã€CUIã¯ã‚¹ãƒšãƒ¼ã‚¹ã§é€²ã¿ã¾ã™ã€‚
```
sudo apt update
sudo apt dist-upgrade
sudo shutdown -r now
```

### Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
https://docs.docker.com/engine/install/ubuntu/
Set up the repository ã® 2.Add Docker's official GPG Key ã‚’ã‚„ã‚Šã¾ã™ã€‚
```
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg
```
3.Use ther following command to setup the repository ã‚‚ã‚„ã‚Šã¾ã™ã€‚
```
echo \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
```
4.Update the apt package index ã‚‚ã‚„ã‚Šã¾ã™ã€‚
```
sudo apt-get update
```
Install Docker Engine ãŒç›®çš„ãªã®ã§ã€ã‚„ã‚Šã¾ã™ã€‚
```
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

### PostgreSQLã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åˆæœŸè¨­å®š
https://www.postgresql.org/download/linux/ubuntu/
```
sudo apt-get install postgresql
```
ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ã§ãã‚‹ã®ã§ã€UNIXèªè¨¼ã§æ¥ç¶šã™ã‚‹ãŸã‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
```
sudo passwd postgres
su - postgres
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åˆ‡ã‚Šæ›¿ãˆãŸçŠ¶æ…‹ã§ã€DBã‚’ä½œã‚Šã¾ã™ã€‚
```
createdb mashu
```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œã‚Šã¾ã™ã€‚`â– â– â– â– ` ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã®ã§ã€è‡ªåˆ†ã§æ±ºã‚ã¦ãã ã•ã„ã€‚
```
$ psql
psql (14.9 (Ubuntu 14.9-0ubuntu0.22.04.1))
Type "help" for help.

postgres=# create role mashu with login password 'â– â– â– â– ';
CREATE ROLE
postgres=# \q
```
æ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚
```
$ psql mashu
psql (14.9 (Ubuntu 14.9-0ubuntu0.22.04.1))
Type "help" for help.

mashu=# grant all on all tables in schema public to mashu;
GRANT
mashu=# \q
```
postgresãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’çµ‚äº†ã—ã¦ã€mashuãƒ¦ãƒ¼ã‚¶ãƒ¼ã§create tableã—ã¦ãŠãã¾ã™ã€‚
```
$ psql -h localhost -U mashu -d mashu
Password for user mashu: 
psql (14.9 (Ubuntu 14.9-0ubuntu0.22.04.1))
SSL connection (protocol: TLSv1.3, cipher: TLS_AES_256_GCM_SHA384, bits: 256, compression: off)
Type "help" for help.

mashu=> \i create_table.sql
```
ä»Šå›ä½¿ã£ãŸSQLã¯ã€ã“ã¡ã‚‰
https://github.com/take0a/go-rest-sample/blob/master/testdata/create_table.sql

## Dockerã§Mashuã‚µãƒ¼ãƒãƒ¼ã‚’å‹•ã‹ã™
ä»Šå›ã¯ã€HTTPSæ¥ç¶šå¯èƒ½ãªMashuã‚µãƒ¼ãƒãƒ¼ã«ã—ã¾ã™ã®ã§ã€Docker Composeã§ã€Nginxã‚’ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·â€•ã§è¨­å®šã—ã¾ã™ã€‚PostgreSQLã¯ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã®æ¥ç¶šã‚’è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€Dockerã‚³ãƒ³ãƒ†ãƒŠã®å†…éƒ¨ã®IPã‚’networkã§æŒ‡å®šã—ã¦ãŠãã¾ã™ã€‚
```yaml: ./docker-compose.yaml
services:
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - 443:443
    volumes:
      - ./config/nginx:/etc/nginx/conf.d
      - ./log:/var/log/nginx

  mashu:
    image: roboninc/mashu:latest
    container_name: mashu
    ports:
      - 3000:3000

networks:
  default:
    ipam:
      config:
        - subnet: 172.18.0.0/24
```
Nginxã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ç”¨æ„ã—ã¾ã™ã€‚`10.138.0.2`ã¯ã€ä»Šå›ä½œã£ãŸGCEã®å†…éƒ¨IPã§ã™ã€‚è¨¼æ˜æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã¨éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’`./config/nginx/ssl`ã«é…ç½®ã—ã¾ã—ãŸã€‚
```nginx: ./config/nginx/nginx.conf
server {
    listen 443 ssl;
    server_name â– â– â– â– ;

    ssl_certificate /etc/nginx/conf.d/ssl/â– â– â– â– .crt;
    ssl_certificate_key /etc/nginx/conf.d/ssl/â– â– â– â– .key;

    location / {
        proxy_pass http://10.138.0.2:3000;
    }

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}
```
PostgreSQLã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¾ã™ã€‚ï¼ˆé•·ã„ã®ã§è¿½åŠ ã—ãŸè¡Œã®ã¿ï¼‰
```conf: /etc/postgresql/14/main/postgresql.conf
listen_addresses = 'localhost,10.138.0.2'   # what IP address(es) to listen on;
```
```conf: /etc/postgresql/14/main/pg_hba.conf
host    all             all             172.18.0.0/24           scram-sha-256
```
Docker Compose ã§å‹•ã‹ã—ã¾ã™ã€‚
```
$ sudo docker compose up -d
[+] Running 20/20
 âœ” mashu 11 layers [â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿â£¿]      0B/0B      Pulled           7.6s 
   âœ” dd5ad9c9c29f Pull complete                                       0.4s 
   âœ” 960043b8858c Pull complete                                       0.5s 
   âœ” b4ca4c215f48 Pull complete                                       1.3s 
   âœ” eebb06941f3e Pull complete                                       1.3s 
   âœ” 02cd68c0cbf6 Pull complete                                       1.3s 
   âœ” d3c894b5b2b0 Pull complete                                       1.4s 
   âœ” b40161cd83fc Pull complete                                       1.4s 
   âœ” 46ba3f23f1d3 Pull complete                                       1.5s 
   âœ” 4fa131a1b726 Pull complete                                       1.6s 
   âœ” 6ac2b5033bfd Pull complete                                       1.6s 
   âœ” dc1525197384 Pull complete                                       5.0s 
 âœ” nginx 7 layers [â£¿â£¿â£¿â£¿â£¿â£¿â£¿]      0B/0B      Pulled                 11.5s 
   âœ” 52d2b7f179e3 Pull complete                                       6.6s 
   âœ” fd9f026c6310 Pull complete                                       8.9s 
   âœ” 055fa98b4363 Pull complete                                       8.9s 
   âœ” 96576293dd29 Pull complete                                       9.0s 
   âœ” a7c4092be904 Pull complete                                       9.0s 
   âœ” e3b6889c8954 Pull complete                                       9.0s 
   âœ” da761d9a302b Pull complete                                       9.0s 
[+] Running 3/3
 âœ” Network docker_default  Created                                    0.3s 
 âœ” Container nginx         Started                                    4.0s 
 âœ” Container mashu         Started                                    4.0s 
```

ä»Šå›ã¯ã€Let's Encryptã®è¨¼æ˜æ›¸ã‚’ç”¨æ„ã—ã¾ã—ãŸãŒã€ã‚ªãƒ¬ã‚ªãƒ¬è¨¼æ˜æ›¸ã§ã‚‚æ¥ç¶šã§ãã‚‹ã¨æ€ã„ã¾ã™ã€‚Let's Encryptã®è¨¼æ˜æ›¸ã®å–å¾—ã¯ã€å…ˆæ—¥ã®è¨˜äº‹ã‚’å‚ç…§ãã ã•ã„ã€‚
https://zenn.dev/robon/articles/3db856390626b0


# ãŠã‚ã‚Šã«
ã©ã¡ã‚‰ã‹ã¨ã„ã†ã¨Mashuã‚µãƒ¼ãƒãƒ¼ã¯ã‚ªãƒã‚±ã¿ãŸã„ã«ãªã£ã¦ã—ã¾ã„ã¾ã—ãŸãŒã€Mashuã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ã†ã®ãŒç°¡å˜ã ã‹ã‚‰ãªã®ã§ã€ã“ã‚Œã¯ã“ã‚Œã§è‰¯ã—ã¨ã—ã¾ã™ã€‚

Mashuã‚µãƒ¼ãƒãƒ¼ã¨PostgreSQLæ¥ç¶šã«ã¤ã„ã¦ã¯ã€Mashuã‚µãƒãƒ¼ãƒˆã‚»ãƒ³ã‚¿ãƒ¼ã«ã‚‚è¨˜äº‹ãŒã‚ã‚Šã¾ã™ã€‚

https://services.robon.co.jp/ja/kb/mashu/source/connect-postgresql

https://services.robon.co.jp/ja/kb/mashu/mashu%E3%82%B5%E3%83%BC%E3%83%90%E3%83%BC%E3%82%AA%E3%83%B3%E3%83%97%E3%83%AC%E3%83%9F%E3%82%B9%E7%94%A8

---
title: "Amazon Lex ã¨ Kendra ã‚’ã¤ãªã"
emoji: "ğŸ¤–"
type: "tech"
topics:
  - "aws"
  - "lambda"
  - "golang"
  - "lex"
  - "kendra"
published: true
published_at: "2023-03-23 19:03"
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
ChatGPTãŒç››ã‚Šä¸ŠãŒã£ã¦ã„ã‚‹ã®ã§ã€AI Chatbotãªã‚‹ã‚‚ã®ã‚’è§¦ã£ã¦ã¿ã‚ˆã†ã¨ã€‚

# ã‚„ã£ãŸã“ã¨
å¼Šç¤¾ã§ã¯ã€AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãŸSaaSé–‹ç™ºã‚’è¡Œã£ã¦ã„ã‚‹ã®ã§ã€AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ã£ãŸAI Chatbotã ã¨ã©ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã®ã‹ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

Chatbotã‚’ä½œã‚‹ã®ã¯Amazon Lexã§ã€Amazon LexãŒä¸Šæ‰‹ã«å›ç­”ã™ã‚‹ãŸã‚ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºæ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã®Amazon Kendraã‚’ã¤ãªã„ã ã‚‰ã„ã„æ„Ÿã˜ã«ãªã‚‹ã‚“ã˜ã‚ƒãªã„ï¼Ÿ

ã¨æ€ã£ã¦æ¤œç´¢ã—ãŸã‚‰ã€ã‚ã‚Šã¾ã—ãŸã€‚

https://aws.amazon.com/jp/blogs/news/integrate-amazon-kendra-and-amazon-lex-using-a-search-intent/

## Amazon Kendraã¨Amazon LexãŒçµ±åˆã§ããªã„ï¼Ÿ
Amazon Kendraã¯ã€2023å¹´2æœˆã‹ã‚‰æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚åˆ©ç”¨å¯èƒ½ã«ãªã£ã¦ã„ãŸã®ã§ã€å½“ç„¶ãªãŒã‚‰æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§æ—¥æœ¬èªã§è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

Kendraã®Indexã‚’ä½œã‚‹ã¨ã“ã‚ã¾ã§ã¯å•é¡Œãªã‹ã£ãŸã®ã§ã™ãŒã€Lexã®Botã«çµ„ã¿è¾¼ã¿ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã®AMAZON.KendraSearchIntentã‚’è¨­å®šã™ã‚‹ç®‡æ‰€ã§å€™è£œã«ã§ã¦ã“ãªã„ã®ã§ã™ã€‚

å®Ÿã¯ã€AMAZON.KendraSearchIntentã¯ã€ã“ã®è¨˜äº‹ã‚’æ›¸ã„ã¦ã„ã‚‹æ™‚ç‚¹ï¼ˆ2023/3/23ï¼‰ã§ã¯ã€en-USãƒ­ã‚±ãƒ¼ãƒ«ã€ãŠã‚ˆã³ç±³å›½æ±éƒ¨ï¼ˆãƒãƒ¼ã‚¸ãƒ‹ã‚¢åŒ—éƒ¨ï¼‰ã€ç±³å›½è¥¿éƒ¨ï¼ˆã‚ªãƒ¬ã‚´ãƒ³ï¼‰ã€æ¬§å·ï¼ˆã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰ï¼‰ã®ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚ã¨ã„ã†ã“ã¨ã§ã—ãŸã€‚

ãƒ€ãƒ¡ã˜ã‚ƒã‚“ã€‚ã¨ã„ã†ã“ã¨ã§ã€ã‚‚ã†ä¸€åº¦æ¤œç´¢ã—ãŸã‚‰ã€ã‚ã‚Šã¾ã—ãŸã€‚ï¼ˆã‚ã‚ŠãŒã¨ã†ã€‚ä¸­ã®äººï¼‰

https://github.com/aws-samples/simple-lex-kendra-jp

ã“ã‚Œã‚’ãã®ã¾ã¾å‹•ã‹ã™ã¨ã€ã†ã¡ã§ã¯ã€Invalid PhysicalResourceIdã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ã€ç„¡äº‹å‹•ã‹ã™ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

```diff ts:data-source.ts
@@ -42,7 +42,7 @@ export class DataSource extends Construct {
 
     this.resource = new cdk.CustomResource(
       this,
-      `CustomResourceDataSource${id}`,
+      'CustomResourceDataSource',
       {
         serviceToken: customResourceHandler.functionArn,
         resourceType: 'Custom::DataSource',
```

## golangã§Lexã®Lambdaæ›¸ã‘ãªã„ï¼Ÿ
AMAZON.KendraSearchIntentãŒä½¿ãˆãªãã¦ã‚‚ã€Lambdaã§ã‚„ã‚Œã°ã„ã„ã‚“ã ã­ã€‚

å¼Šç¤¾ã¯Lambdaé–‹ç™ºã®æ¨™æº–è¨€èªã¯golangãªã®ã§ã€ã„ã‚ã„ã‚ã„ã˜ã‚‹ãªã‚‰golangã§æ›¸ã„ã¦ã¿ã‚ˆã†ã¨ã„ã†ã“ã¨ã§ã€ã¾ãšã¯ã€ã“ã“ã‹ã‚‰ã€‚

https://github.com/aws/aws-lambda-go/blob/main/events/README_Lex.md

ã“ã‚“ãªæ„Ÿã˜ã®ã‚’å‹•ã‹ã—ã¦ã¿ãŸã‚‰ã€

```
runtime error: invalid memory address or nil pointer dereference: errorString
```

ã“ã‚Œã£ã¦ã€Lex V1ã‹ãªï¼Ÿ

https://github.com/aws/aws-lambda-go/blob/main/events/lex.go

...ã¨ã„ã†ã“ã¨ã§ã€Lex V2 ã®æ§‹é€ ä½“ã‹ã‚‰æ›¸ã‹ãªã„ã¨ã„ã‘ãªã„ã®ã§ã—ãŸã€‚

:::details ã¡ã‚‡ã£ã¨é•·ã„ã®ã§è¦‹ãŸã„æ–¹ã ã‘ã©ã†ã
```go: lex-lambda-types.go
package main

// LexV2Event ã¯ã€Lambda é–¢æ•°ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
// https://docs.aws.amazon.com/lexv2/latest/dg/lambda.html
// @types/aws-lambda/triggrt/lex-v2.ts
type LexV2Event struct {
	MessageVersion      string                `json:"messageVersion"`
	InvocationSource    string                `json:"invocationSource"`
	InputMode           string                `json:"inputMode"`
	ResponseContentType string                `json:"responseContentType"`
	SessionID           string                `json:"sessionId"`
	InputTranscript     string                `json:"inputTranscript"`
	Bot                 LexV2Bot              `json:"bot"`
	Interpretations     []LexV2Interpretation `json:"interpretations"`
	ProposedNextState   struct {
		DialogAction LexV2DialogAction `json:"dialogAction"`
		Intent       LexV2Intent       `json:"intent"`
	} `json:"proposedNextState"`
	RequestAttributes map[string]string    `json:"requestAttributes"`
	SessionState      *LexV2SessionState   `json:"sessionState"`
	Transcriptions    []LexV2Transcription `json:"transcriptions"`
}

// LexV2Bot ã¯ã€Lamabda ã‚’èµ·å‹•ã—ãŸãƒœãƒƒãƒˆ
type LexV2Bot struct {
	ID        string `json:"id"`
	Name      string `json:"name"`
	AliasID   string `json:"aliasId"`
	AliasName string `json:"aliasName"`
	LocaleID  string `json:"localeId"`
	Version   string `json:"version"`
}

// LexV2Interpretation ã¯ã€Lex ãŒè¡Œã£ãŸä¼šè©±ã®è§£é‡ˆ
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Interpretation.html
type LexV2Interpretation struct {
	Intent            LexV2Intent            `json:"intent"`
	NluConfidence     float64                `json:"nluConfidence"`
	SentimentResponse LexV2SentimentResponse `json:"sentimentResponse"`
}

// LexV2Intent ã¯ã€Lex ãŒè§£é‡ˆã—ãŸæ„å›³
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Intent.html
type LexV2Intent struct {
	ConfirmationState string               `json:"confirmationState"`
	Name              string               `json:"name"`
	Slots             map[string]LexV2Slot `json:"slots"`
	State             string               `json:"state"`
	KendraResponse    interface{}          `json:"kendraResponse"`
}

// LexV2SentimentResponse ã¯ã€Comprehend ãŒè§£é‡ˆã—ãŸå¿œç­”ã®æ„Ÿæƒ…
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_SentimentResponse.html
type LexV2SentimentResponse struct {
	Sentiment      string              `json:"sentiment"`
	SentimentScore LexV2SentimentScore `json:"sentimentScore"`
}

// LexV2SentimentScore ã¯ã€ï¼”ã¤ã®æ„Ÿæƒ…ã‚’ç¤ºã™
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_SentimentScore.html
type LexV2SentimentScore struct {
	Mixed    float64 `json:"mixed"`
	Negative float64 `json:"negative"`
	Neutral  float64 `json:"neutral"`
	Positive float64 `json:"positive"`
}

// LexV2SessionState ã¯ã€Lex ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_SessionState.html
type LexV2SessionState struct {
	ActiveContexts       []LexV2ActiveContext `json:"activeContexts,omitempty"`
	SessionAttributes    map[string]string    `json:"sessionAttributes,omitempty"`
	DialogAction         LexV2DialogAction    `json:"dialogAction,omitempty"`
	Intent               LexV2Intent          `json:"intent"`
	OriginatingRequestID string               `json:"originatingRequestId"`
}

// LexV2ActiveContext ã¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ–‡è„ˆ
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_ActiveContext.html
type LexV2ActiveContext struct {
	Name              string            `json:"name"`
	ContextAttributes map[string]string `json:"contextAttributes"`
	TimeToLive        struct {
		TimeToLiveInSeconds int `json:"timeToLiveInSeconds"`
		TurnsToLive         int `json:"turnsToLive"`
	} `json:"timeToLive"`
}

// LexV2DialogAction ã¯ã€ä¼šè©±ã®æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_DialogAction.html
type LexV2DialogAction struct {
	Type                 string `json:"type"`
	SlotToElicit         string `json:"slotToElicit"`
	SlotElicitationStyle string `json:"slotElicitationStyle,omitempty"`
}

// LexV2Result ã¯ã€Lambda é–¢æ•°ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹
// https://docs.aws.amazon.com/lexv2/latest/dg/lambda.html#lambda-response-format
type LexV2Result struct {
	SessionState *LexV2SessionState `json:"sessionState"`
	Messages     []*LexV2Message    `json:"messages"`
}

// LexV2Message ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã•ã‚Œã‚‹å›ç­”æ–‡ã®å…¥ã‚Œç‰©
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Message.html
type LexV2Message struct {
	ContentType       string                  `json:"contentType"`
	Content           string                  `json:"content,omitempty"`
	ImageResponseCard *LexV2ImageResponseCard `json:"imageResponseCard,omitempty"`
}

// LexV2ImageResponseCard ã¯ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ—ãƒ©ãƒƒãƒˆãƒ›ãƒ¼ãƒ ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_ImageResponseCard.html
type LexV2ImageResponseCard struct {
	Title    string         `json:"title"`
	Subtitle string         `json:"subtitle,omitempty"`
	ImageURL string         `json:"imageUrl,omitempty"`
	Buttons  []*LexV2Button `json:"buttons,omitempty"`
}

// LexV2Button ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰ä¸Šã®ãƒœã‚¿ãƒ³
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Button.html
type LexV2Button struct {
	Text  string `json:"text"`
	Value string `json:"value"`
}

// LexV2Slot ã¯ã€Lex ãŒã‚¤ãƒ³ãƒ†ãƒ³ãƒˆã‚’æº€ãŸã™ãŸã‚ã«ä½¿ç”¨ã™ã‚‹å€¤
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Slot.html
type LexV2Slot struct {
	Shape  string         `json:"shape"`
	Value  LexV2SlotValue `json:"value"`
	Values []LexV2Slot    `json:"values,omitempty"`
}

// LexV2SlotValue ã¯ã€ã‚¹ãƒ­ãƒƒãƒˆã®å€¤
// https://docs.aws.amazon.com/lexv2/latest/dg/API_runtime_Value.html
type LexV2SlotValue struct {
	InterpretedValue string   `json:"interpretedValue,omitempty"`
	OriginalValue    string   `json:"originalValue"`
	ResolvedValues   []string `json:"resolvedValues"`
}

// LexV2Transcription ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³å£°ç™ºè©±ã«å¯¾å¿œã™ã‚‹æ›¸ãèµ·ã“ã—
// https://docs.aws.amazon.com/lexv2/latest/dg/using-transcript-confidence-scores.html
type LexV2Transcription struct {
	Transcription           string  `json:"transcription"`
	TranscriptionConfidence float64 `json:"transcriptionConfidence"`
	ResolvedContext         struct {
		Intent string `json:"intent"`
	} `json:"resolvedContext"`
	ResolvedSlots map[string]LexV2Slot `json:"resolvedSlots"`
}
```
:::

# ã¾ã¨ã‚
* ã¨ã„ã†ã“ã¨ã§ã€ç¾æ™‚ç‚¹ï¼ˆ2023/3/23ï¼‰ã§ã‚‚æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§Amazon Lexã¨Kendraã‚’çµ„ã¿åˆã‚ã›ãŸæ—¥æœ¬èªã®ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¯å‹•ä½œå¯èƒ½ã§ã—ãŸã€‚
* AMAZON.KendraSearchIntentãŒæ—¥æœ¬èªã§æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½¿ãˆã‚‹ãªã‚‰ã€ä¼šç¤¾ä¸­ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®å†…å®¹ã‚’çŸ¥ã£ã¦ã„ã‚‹å„ªç§€ãªãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆãŒç°¡å˜ã«ã§ããã†ãªã®ã§ã€æœŸå¾…ã—ãŸã„ã§ã™ã€‚
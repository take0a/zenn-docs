---
title: "Superset入門"
emoji: "♾️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "superset", "uv", "postgresql", "redis"]
published: false
publication_name: "robon"
---

# はじめに
モダンデータスタックを構成するツール群を勉強しているのですが、折角、データ連携しても、「で、どうすんの？」が必要かなと思いました。
といっても、いわゆる BI ツールはお高いので、お高くないもので探したところ、ありました。（笑）

https://superset.apache.org/

ということで、やってみましょう。

# やってみる
## 方針
開発用には、docker-compose を、実運用には、Kubernetes を進めているようで、実際、docker-compose であれば簡単に動きます。
ただ、「本番では、docker-compose するな」と何度も書いてあり、また、「お高くないもの」もテーマなので、仮想環境ではなく、実環境にインストールしてみることにします。

## 環境
今回は、以下の EC2 環境に導入することにします。

| 項目 | 値 | 備考 | 
|-----|-----|-----|
| インスタンスタイプ | t3a.large | USD 0.0979 / 時間 ＠東京 |
| ボリュームタイプ | gp3 | USD 0.096/GB 月 ＠東京 |
| ボリュームサイズ | 8 GiB | USD 0.768 / 月 ＠東京 |
| OS | Amazon Linux 2023 | Amazon Linux 2023.7.20250331 |

これを平日の 10:00-20:00 の稼働にすると、月額20ドル強という感じです。

## 事前導入（Superset 以外）

https://superset.apache.org/docs/installation/pypi

### git
構成管理に git を導入します。

```
$ sudo dnf install git
:
Installed:
  git-2.47.1-1.amzn2023.0.2.x86_64
  git-core-2.47.1-1.amzn2023.0.2.x86_64
  git-core-doc-2.47.1-1.amzn2023.0.2.noarch
  perl-Error-1:0.17029-5.amzn2023.0.2.noarch
  perl-File-Find-1.37-477.amzn2023.0.6.noarch
  perl-Git-2.47.1-1.amzn2023.0.2.noarch
  perl-TermReadKey-2.38-9.amzn2023.0.2.x86_64
  perl-lib-0.65-477.amzn2023.0.6.x86_64

Complete!

$ git --version
git version 2.47.1
```

### PostgreSQL
Superset のメタデータデータベースは、PostgreSQL か MySSQL なので、PostgreSQL を導入します。あとで、サンプルデータベースとしても使います。
（devel を入れておかないと、後で、psycopg2 の導入で失敗するので入れておきましょう）

```
$ sudo dnf install postgresql17 postgresql17-server postgresql17-server-devel
:
Installed:
  clang-15.0.7-3.amzn2023.0.2.x86_64
  clang-devel-15.0.7-3.amzn2023.0.2.x86_64
  clang-libs-15.0.7-3.amzn2023.0.2.x86_64
  clang-resource-filesystem-15.0.7-3.amzn2023.0.2.x86_64
  clang-tools-extra-15.0.7-3.amzn2023.0.2.x86_64
  cmake-filesystem-3.22.2-1.amzn2023.0.4.x86_64
  compiler-rt-15.0.7-3.amzn2023.0.1.x86_64
  cpp14-14.2.1-7.amzn2023.0.1.x86_64
  emacs-filesystem-1:28.2-3.amzn2023.0.10.noarch
  gc-8.0.4-5.amzn2023.0.2.x86_64
  gcc14-14.2.1-7.amzn2023.0.1.x86_64
  gcc14-c++-14.2.1-7.amzn2023.0.1.x86_64
  gcc14-libstdc++-devel-14.2.1-7.amzn2023.0.1.x86_64
  glibc-devel-2.34-117.amzn2023.0.1.x86_64
  glibc-headers-x86-2.34-117.amzn2023.0.1.noarch
  guile22-2.2.7-2.amzn2023.0.3.x86_64
  kernel-headers-6.12.20-23.97.amzn2023.x86_64
  keyutils-libs-devel-1.6.3-1.amzn2023.0.2.x86_64
  krb5-devel-1.21.3-1.amzn2023.0.1.x86_64
  libatomic-14.2.1-7.amzn2023.0.1.x86_64
  libcom_err-devel-1.46.5-2.amzn2023.0.2.x86_64
  libedit-devel-3.1-38.20210714cvs.amzn2023.0.2.x86_64
  libicu-67.1-7.amzn2023.0.3.x86_64
  libicu-devel-67.1-7.amzn2023.0.3.x86_64
  libkadm5-1.21.3-1.amzn2023.0.1.x86_64
  libmpc-1.2.1-2.amzn2023.0.2.x86_64
  libomp-15.0.7-5.amzn2023.0.1.x86_64
  libomp-devel-15.0.7-5.amzn2023.0.1.x86_64
  libselinux-devel-3.4-5.amzn2023.0.2.x86_64
  libsepol-devel-3.4-3.amzn2023.0.3.x86_64
  libtool-ltdl-2.4.7-1.amzn2023.0.3.x86_64
  libverto-devel-0.3.2-1.amzn2023.0.2.x86_64
  libxcrypt-devel-4.4.33-7.amzn2023.x86_64
  llvm-15.0.7-3.amzn2023.0.1.x86_64
  llvm-devel-15.0.7-3.amzn2023.0.1.x86_64
  llvm-libs-15.0.7-3.amzn2023.0.1.x86_64
  llvm-static-15.0.7-3.amzn2023.0.1.x86_64
  llvm-test-15.0.7-3.amzn2023.0.1.x86_64
  make-1:4.3-5.amzn2023.0.2.x86_64
  ncurses-c++-libs-6.2-4.20200222.amzn2023.0.6.x86_64
  ncurses-devel-6.2-4.20200222.amzn2023.0.6.x86_64
  openssl-devel-1:3.2.2-1.amzn2023.0.1.x86_64
  pcre2-devel-10.40-1.amzn2023.0.3.x86_64
  pcre2-utf16-10.40-1.amzn2023.0.3.x86_64
  pcre2-utf32-10.40-1.amzn2023.0.3.x86_64
  postgresql17-17.4-1.amzn2023.0.1.x86_64
  postgresql17-private-devel-17.4-1.amzn2023.0.1.x86_64
  postgresql17-private-libs-17.4-1.amzn2023.0.1.x86_64
  postgresql17-server-17.4-1.amzn2023.0.1.x86_64
  postgresql17-server-devel-17.4-1.amzn2023.0.1.x86_64

Complete!

$ sudo postgresql-setup --initdb
 * Initializing database in '/var/lib/pgsql/data'
 * Initialized, logs are in /var/lib/pgsql/initdb_postgresql.log

$ sudo systemctl enable postgresql
Created symlink /etc/systemd/system/multi-user.target.wants/postgresql.service → /usr/lib/systemd/system/postgresql.service.

$ sudo systemctl start postgresql
$ sudo systemctl status postgresql
● postgresql.service - PostgreSQL database server
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; preset: disabled)
     Active: active (running) since Sun 2025-04-13 05:07:53 UTC; 15s ago
    Process: 34117 ExecStartPre=/usr/libexec/postgresql-check-db-dir postgresql (code=exited, sta>
   Main PID: 34119 (postgres)
      Tasks: 7 (limit: 9372)
     Memory: 17.5M
        CPU: 64ms
     CGroup: /system.slice/postgresql.service
             ├─34119 /usr/bin/postgres -D /var/lib/pgsql/data
             ├─34120 "postgres: logger "
             ├─34121 "postgres: checkpointer "
             ├─34122 "postgres: background writer "
             ├─34124 "postgres: walwriter "
             ├─34125 "postgres: autovacuum launcher "
             └─34126 "postgres: logical replication launcher "
```

Superset 用にデータベースとユーザーを作成します。

```
$ sudo -u postgres psql
psql (17.4)
Type "help" for help.

postgres=# create database superset owner postgres;
CREATE DATABASE
postgres=# create user superset with password 'superset';
CREATE ROLE
postgres=# grant all privileges on database superset to superset;
GRANT
postgres=# \c superset postgres
You are now connected to database "superset" as user "postgres".
postgres=# grant all privileges on schema public to superset;
GRANT
postgres=# grant all privileges on all tables in schema public to superset;
GRANT
postgres=# grant all privileges on all sequences in schema public to superset;
GRANT
postgres=# \q
```

Superset を OS のユーザーでなく、PostgreSQL のユーザーで接続するので、設定変更します。

```diff conf:/var/lib/pgsql/data/pg_hba.conf
115c115
< host    all             all             127.0.0.1/32            ident
---
> host    all             all             127.0.0.1/32            password
```

### Redis
Superset のキャッシュと非同期実行用に Redis を導入します。

```
$ sudo dnf install redis6
:
Installed:
  redis6-6.2.14-2.amzn2023.0.2.x86_64

Complete!

$ sudo systemctl enable redis6
Created symlink /etc/systemd/system/multi-user.target.wants/redis6.service → /usr/lib/systemd/system/redis6.service.

$ sudo systemctl start redis6
$ sudo systemctl status redis6
● redis6.service - Redis persistent key-value database
     Loaded: loaded (/usr/lib/systemd/system/redis6.service; enabled; preset: disabled)
    Drop-In: /etc/systemd/system/redis6.service.d
             └─limit.conf
     Active: active (running) since Sun 2025-04-13 05:23:49 UTC; 8s ago
   Main PID: 37269 (redis6-server)
     Status: "Ready to accept connections"
      Tasks: 5 (limit: 9372)
     Memory: 2.3M
        CPU: 28ms
     CGroup: /system.slice/redis6.service
             └─37269 "/usr/bin/redis6-server 127.0.0.1:6379"
```

### その他
後で叱られるものを予め入れておきます。（numpy のインストールでエラーになります）

```
$ sudo dnf install gcc gcc-c++ libffi-devel
:
Installed:
  annobin-docs-12.69-1.amzn2023.0.1.noarch
  annobin-plugin-gcc-12.69-1.amzn2023.0.1.x86_64
  cpp-11.5.0-5.amzn2023.0.3.x86_64
  gcc-11.5.0-5.amzn2023.0.3.x86_64
  gcc-c++-11.5.0-5.amzn2023.0.3.x86_64
  gcc-plugin-annobin-11.5.0-5.amzn2023.0.3.x86_64
  libffi-devel-3.4.4-1.amzn2023.0.1.x86_64
  libstdc++-devel-11.5.0-5.amzn2023.0.3.x86_64

Complete!
```

### uv
最近、取り憑かれたように使ている uv を入れておきます。pip ではなく uv でやります。

```
$ curl -LsSf https://astral.sh/uv/install.sh | sh
downloading uv 0.6.14 x86_64-unknown-linux-gnu
no checksums to verify
installing to /home/ec2-user/.local/bin
  uv
  uvx
everything's installed!
```

### Python
Superset のサポート範囲が 3.11 までなので、3.11 をインストールします（numpy が）

```
$ uv python install 3.11
Installed Python 3.11.12 in 2.88s
 + cpython-3.11.12-linux-x86_64-gnu
```

## Superset の導入
uv プロジェクトの仮想環境に導入します。
Superset には、４種類のコンポーネントが存在しますが、まずは、必須の２つから。
1. Superset アプリケーション自体
1. メタデータ データベース
1. キャッシュ レイヤー (オプションですが、一部の機能には必要です)
1. ワーカーとビート (オプションですが、一部の機能には必要です)

```
$ uv init superset
Initialized project `superset` at `/home/ec2-user/superset`

$ cd superset
$ uv venv
Using CPython 3.11.12
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate

$ uv add apache-superset
Resolved 149 packages in 9.97s
      Built apache-superset==4.1.2
      Built func-timeout==4.3.5
      Built python-geohash==0.8.5
      Built wtforms-json==0.3.5
      Built pgsanity==0.2.9
      Built shortid==0.1.2
Prepared 145 packages in 32.27s
Installed 145 packages in 346ms
 + alembic==1.15.2
:
 + zstandard==0.23.0
```

### 環境変数と設定ファイル
SUPERSET_CONFIG_PATH 環境変数を上記のプロジェクトにします。

```bash: ~/.bash_profile
# User specific environment and startup programs
export SUPERSET_CONFIG_PATH=~/superset/superset_config.py
```

上記の superset_config.py に DB の URL と SECRET_KEY を設定します。（まずは）

```py: ~/superset/superset_conig.py
SQLALCHEMY_DATABASE_URI="postgresql://superset:superset@localhost:5432/superset"
SECRET_KEY="yK7IX6WlirS/hez7DUjZvKLtS4/KAwJXrSYv4ZjX79whINlgFVD9ithQ"

LANGUAGES = {
    "ja": {"flag": "jp", "name": "Japanese"},
    "en": {"flag": "us", "name": "English"},
}
```

SECRET_KEY は、以下のように作成しておきましょう。

```
$ openssl rand -base64 42
yK7IX6WlirS/hez7DUjZvKLtS4/KAwJXrSYv4ZjX79whINlgFVD9ithQ
```

FLASK_APP 環境変数は、このプロジェクト用のものを ~/superset/.flaskenv に設定する。

```env: ~/superset/.flaskenv
FLASK_APP=superset
```

### その他の Python パッケージ
後で叱られたり、ログにエラー出力されるものを入れておきます。

```
$ uv add pip setuptools
Resolved 151 packages in 141ms
Prepared 2 packages in 316ms
Installed 2 packages in 47ms
 + pip==25.0.1
 + setuptools==78.1.0
```

メタデータベースを PostgreSQL にするので、psycopg2 を入れます。

```
$ uv add psycopg2
Resolved 152 packages in 104ms
      Built psycopg2==2.9.10
Prepared 1 package in 12.78s
Installed 1 package in 2ms
 + psycopg2==2.9.10
```

### メタデータベースを初期化して動かすまで



# おわりに

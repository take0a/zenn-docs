---
title: "Golangã§RESTï¼ˆãã®ï¼‘ï¼‰"
emoji: "ğŸƒâ€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["golang", "rest", "postgresql", "gochi"]
published: false
publication_name: "robon"
---

# ã¯ã˜ã‚ã«

NestJSã€FastAPIã«ç¶šã„ã¦ã€Golangã§ã‚‚RESTã‚µãƒ¼ãƒãƒ¼ã‚’é–‹ç™ºã—ã¾ã—ãŸã¨ã„ã†è¨˜äº‹ã§ã™ã€‚éå»ã®è¨˜äº‹ã¯ã€ä»¥ä¸‹ã‹ã‚‰å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/robon/articles/76d4ec767b72ae

https://zenn.dev/robon/articles/aa7ba513b3bdb3

# è¨­è¨ˆ
## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯

NestJSã‚„FastAPIã«ã¤ã„ã¦ã¯ã€ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚ã‚Šãã§å®Ÿè£…ã—ã¦ãã¾ã—ãŸãŒã€Golangã®å ´åˆã¯ã€ã¾ãšã¯ã€ã§ãã‚‹ã ã‘æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã„ããŸã‹ã£ãŸã®ã§ã™ãŒã€å®Ÿè£…ã—ã¦ã¿ã¦ã€ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®æ§‹æˆã‚’è‡ªåŠ›ã§ã‚„ã‚‹ã®ã¯ã€ãªã‹ãªã‹å¤§å¤‰ãã†ã«æ„Ÿã˜ãŸã®ã§ã€go-chiã ã‘ã¯ä½¿ã‚ã›ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚

https://github.com/go-chi/chi

ã¾ãŸã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚‚ä¸Šè¨˜ã®NestJSã€FastAPIã®éš›ã¨åŒã˜PostgeSQLã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## æ§‹é€ 

Golangã«ã¯Classã¯ç„¡ã„ã®ã§ã€Classå›³ã¨ã„ã†ã®ã‚‚å¤‰ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€NestJSã«å½±éŸ¿ã•ã‚Œã¦ï¼ˆç¬‘ï¼‰ã€ä¸Šè¨˜ã®NestJSã‚„FastAPIã®å®Ÿè£…ã«è¿‘ã„æ§‹é€ ã«ã—ã¾ã—ãŸã€‚RESTãƒªã‚½ãƒ¼ã‚¹å˜ä½ã«ä»¥ä¸‹ã®ã‚»ãƒƒãƒˆã‚’è¿½åŠ ã—ã¦ã„ãã“ã¨ã«ã—ã¾ã™ã€‚

```mermaid
classDiagram
    Router "1" --> "1" Controller
    class Router {
        Get(string, http.HandlerFunc)
        Post(string, http.HandlerFunc)
        Put(string, http.HandlerFunc)
        Delete(string, http.HandlerFunc)
    }
    Controller "1" *-- "1" Service
    Controller "1" *-- "1" DB
    class Controller {
        Get(http.ResponseWriter, *http.Request)
        Post(http.ResponseWriter, *http.Request)
        Put(http.ResponseWriter, *http.Request)
        Delete(http.ResponseWriter, *http.Request)
    }
    class DB {
       BeginTx(context.Context, *TxOptions) (*Tx, error)
    }
    Service "1" *-- "*" Dao
    class Service {
        Create(context.Context, *sql.Tx, *Dto) (*Dto, error)
        Read(context.Context, *sql.Tx, *Key) (*Dto, error)
        Update(context.Context, *sql.Tx, *Dto) (*Dto, error)
        Delete(context.Context, *sql.Tx, *Key) error
    }
    class Dao {
        Insert(context.Context, *sql.Tx, *Entity) (*Entity, error)
        Select(context.Context, *sql.Tx, *Key) (*Entity, error)
        Update(context.Context, *sql.Tx, *Entity) (*Entity, error)
        Delete(context.Context, *sql.Tx, *Key) error
    }
```

# å®Ÿè£…
## ç’°å¢ƒ

åˆ¥ä»¶ã§ä½¿ç”¨ä¸­ã®ç’°å¢ƒã§å®Ÿè£…ã—ã¾ã—ãŸã€‚

```bash
$ go version
go version go1.18.6 linux/amd64
```

```go-mod: go.mod
module github.com/take0a/go-rest-sample

go 1.18

require (
	github.com/go-chi/chi/v5 v5.0.8
	github.com/go-chi/render v1.0.2
	github.com/lib/pq v1.10.7
)

require github.com/ajg/form v1.5.1 // indirect
```

## ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

RESTãƒªã‚½ãƒ¼ã‚¹ã‚’JSONã§å…¥å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ã€DTOï¼ˆData Transfer Objectï¼‰ã¨ã„ã†å‘½åè¦å‰‡ã«ã—ã¾ã—ãŸã€‚DTOã«ã¯JSONã‚¿ã‚°ã‚’ä»˜ä¸ã—ã¾ã™ã€‚ã¾ãŸã€è¤‡åˆã‚­ãƒ¼ã®ã‚±ãƒ¼ã‚¹ã‚‚æƒ³å®šã—ã¦ä¸»ã‚­ãƒ¼ã‚‚æ§‹é€ ä½“ã«ã—ã¾ã—ãŸã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨å…¥å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¯ã€Entityã¨ã„ã†å‘½åè¦å‰‡ã«ã—ã¾ã—ãŸã€‚ä»Šå›ã®å ´åˆã¯ã€åŸºæœ¬çš„ã«ã»ã¼åŒã˜å‹ã«ãªã‚‹ã®ã§ã™ãŒã€ç›¸äº’ã«å¤‰æ›ã™ã‚‹ãŸã‚ã®å‡¦ç†ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```go: module/customers/dto.go
package customers

// Key ã¯ã€é¡§å®¢ãƒªã‚½ãƒ¼ã‚¹ã®ä¸»ã‚­ãƒ¼
type Key struct {
	CustomerID int
}

// Dto ã¯ã€é¡§å®¢ãƒªã‚½ãƒ¼ã‚¹
type Dto struct {
	CustomerID int    `json:"customerId"`
	Name       string `json:"name"`
	Address    string `json:"address"`
}

// NewDto ã¯ã€Customer ã‹ã‚‰ CustomerDto ã‚’ç”Ÿæˆã™ã‚‹
func NewDto(customer *Entity) *Dto {
	return &Dto{
		CustomerID: customer.CustomerID,
		Name:       customer.Name,
		Address:    customer.Address,
	}
}

// Key ã¯ã€Dto ã® Key ã‚’ç”Ÿæˆã™ã‚‹ã€‚
func (c *Dto) Key() *Key {
	return &Key{
		CustomerID: c.CustomerID,
	}
}
```

```go: module/customers/entity.go
package customers

// Entity ã¯ã€CUSTOMER ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾å¿œã™ã‚‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
type Entity struct {
	CustomerID int
	Name       string
	Address    string
}

// NewEntity ã¯ã€Dto ã‹ã‚‰ Entity ã‚’ç”Ÿæˆã™ã‚‹
func NewEntity(dto *Dto) *Entity {
	return &Entity{
		CustomerID: dto.CustomerID,
		Name:       dto.Name,
		Address:    dto.Address,
	}
}
```

åå‰ãŒã‚ã£ã•ã‚Šã—ã¦ã„ã‚‹ã®ã¯ã€Golangã®å ´åˆã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åï¼‹è¦ç´ ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ãŒå¤šã„ã“ã¨ã‚‚ã‚ã£ã¦ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸åã‚’å«ã‚ãŸåå‰ã‚’å…¬é–‹ã™ã‚‹ã¨linterã«æ³¨æ„ã•ã‚ŒãŸã‚Šã—ã¾ã™ã—ã€çŸ­ã„å˜èªã‚’ä½¿ã†ã®ãŒGolangã‚‰ã—ã„ã‹ãªã¨ã„ã†ã“ã¨ã§ã€Golangã«é¦´æŸ“ã¿ã®ãªã„æ–¹ã‹ã‚‰ã™ã‚‹ã¨é•å’Œæ„Ÿæº€è¼‰ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

ã¾ãŸã€è­˜åˆ¥å­ã®å¤šããŒå¤§æ–‡å­—ã§å§‹ã¾ã£ã¦ã„ã¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸å¤–ã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã¯ã€ã„ã‚ã„ã‚ã¨è©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ã‚‹é€”ä¸­ã®æ®µéšã§ã‚‚ã‚ã‚Šã€æœ€é©ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

## DAOï¼ˆData Access Objectï¼‰

DTOã¨ã„ã„ã€Javaã®é¦™ã‚ŠãŒã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã‚Œã¯ã€ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã®ã ã€‚ã¨è¨€ã£ã¦ã‚‚DAOã®æ–¹ãŒé€šã‚ŠãŒè‰¯ã„ã‚ˆã†ãªæ°—ãŒã—ãŸã®ã§ã€DAOã«ã—ã¾ã™ã€‚

https://www.martinfowler.com/eaaCatalog/tableDataGateway.html

```go: module/customers/dao.go
package customers

import (
	"context"
	"database/sql"
	"log"

	"github.com/lib/pq"
	"github.com/take0a/go-rest-sample/utils"
)

// SQLæ–‡
const (
	Insert = `
INSERT INTO CUSTOMER (
CUSTOMER_ID, NAME, ADDRESS
) VALUES (
$1, $2, $3
)`
	Select = `
SELECT
CUSTOMER_ID, NAME, ADDRESS
FROM CUSTOMER
WHERE CUSTOMER_ID = $1`
	Update = `
UPDATE CUSTOMER SET
CUSTOMER_ID = $1, 
NAME = $2,
ADDRESS = $3
WHERE CUSTOMER_ID = $1`
	Delete = `
DELETE FROM CUSTOMER
WHERE CUSTOMER_ID = $1`
)

// Dao ã¯ã€Customer ã® Table Data Gateway
type Dao struct{}

// Insert ã¯ã€æŒ‡å®šã•ã‚ŒãŸ Customer ã‚’ç™»éŒ²ã™ã‚‹ã€‚
func (d *Dao) Insert(ctx context.Context, tx *sql.Tx, entity *Entity) (*Entity, error) {
	_, err := tx.ExecContext(ctx, Insert,
		entity.CustomerID,
		entity.Name,
		entity.Address,
	)
	if err != nil {
		if pqErr, ok := err.(*pq.Error); ok {
			if pqErr.Code == "23505" { // unique_violation
				return nil, utils.ErrConflict
			}
		}
		log.Printf("%s %s\n", Insert, err)
		return nil, err
	}
	return entity, nil
}

// Select ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã® Customer ã‚’å–å¾—ã™ã‚‹ã€‚
func (d *Dao) Select(ctx context.Context, tx *sql.Tx, key *Key) (*Entity, error) {
	var entity Entity
	err := tx.QueryRowContext(ctx, Select,
		key.CustomerID,
	).Scan(
		&entity.CustomerID,
		&entity.Name,
		&entity.Address,
	)
	if err != nil {
		// ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã€sql.ErrNoRows
		log.Printf("%s Query %s\n", Select, err)
		return nil, err
	}
	return &entity, nil
}

// Update ã¯ã€æŒ‡å®šã•ã‚ŒãŸ Customer ã‚’æ›´æ–°ã™ã‚‹ã€‚
func (d *Dao) Update(ctx context.Context, tx *sql.Tx, entity *Entity) (*Entity, error) {
	result, err := tx.ExecContext(ctx, Update,
		entity.CustomerID,
		entity.Name,
		entity.Address,
	)
	if err != nil {
		log.Printf("%s Exec %s\n", Update, err)
		return nil, err
	}
	num, err := result.RowsAffected()
	if err != nil {
		log.Printf("%s RowsAffected %s\n", Update, err)
		return nil, err
	}
	if num == 0 {
		log.Printf("Not Found %#v", entity)
		return nil, sql.ErrNoRows
	}
	return entity, nil
}

// Delete ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã® Customer ã‚’å‰Šé™¤ã™ã‚‹ã€‚
func (d *Dao) Delete(ctx context.Context, tx *sql.Tx, key *Key) error {
	result, err := tx.ExecContext(ctx, Delete,
		key.CustomerID,
	)
	if err != nil {
		log.Printf("%s %s\n", Delete, err)
		return err
	}
	num, err := result.RowsAffected()
	if err != nil {
		log.Printf("%s RowsAffected %s\n", Delete, err)
		return err
	}
	if num == 0 {
		log.Printf("Not Found %#v", key)
		return sql.ErrNoRows
	}
	return nil
}
```

ã¨ã„ã†æ„Ÿã˜ã§ã€ä¸Šä½ã§ä½œã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆcontext.Contextï¼‰ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆsql.Txï¼‰ä¸Šã§SQLæ–‡ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

# æ¬¡å›ã¯

Daoã‚’å‘¼ã³å‡ºã™Serviceã‹ã‚‰å‘¼ã³å‡ºã—å…ƒã¸å‘ã‘ã¦ç¶šã‘ã¾ã™ã€‚

https://zenn.dev/robon/articles/a81cc526cac283

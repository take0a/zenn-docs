---
title: "NestJSã§RESTï¼ˆãã®ï¼“ï¼‰"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nestjs", "rest", "postgresql", "nodejs", "typescript"]
published: false
publication_name: "robon"
---

# å‰å›ã¾ã§

https://zenn.dev/robon/articles/32bf49163826ca

TypeORMã¨Postgresã®è¨­å®šãŒã§ãã¾ã—ãŸã€‚ğŸ‘

# TypeORMã‚’ä½¿ã£ã¦ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å®Œæˆã•ã›ã‚‹
NestJSã¯ã€DIãªã®ã§ä¾å­˜é–¢ä¿‚ã¯ã†ã‚‹ã•ããªã„ã®ã§ã™ãŒã€ä¸‹ã‹ã‚‰ã‚„ã‚Šã¾ã™ã€‚ï¼ˆå®Ÿã¯ã€ORMã ã‘ã˜ã‚ƒãªãã¦DIã‚‚å«Œã„ã§ã™ã€‚ï¼‰

## service
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‘¼ã³å‡ºã—ã¯TypeORMãŒã‚„ã£ã¦ãã‚Œã‚‹ï¼ˆã¯ãšãªï¼‰ã®ã§ã€serviceã¯ã€TypeORMå‘¼ã³å‡ºã—ã‚’ã‚„ã‚Šã¾ã™ã€‚

```diff ts:src/customers/customers.service.ts
@@ -1,26 +1,70 @@
-import { Injectable } from '@nestjs/common';
+import {
+  Injectable,
+  NotFoundException,
+  InternalServerErrorException,
+} from '@nestjs/common';
+import { InjectRepository } from '@nestjs/typeorm';
+import { DeleteResult, Repository } from 'typeorm';
 import { CreateCustomerDto } from './dto/create-customer.dto';
 import { UpdateCustomerDto } from './dto/update-customer.dto';
+import { Customer } from './entities/customer.entity';
 
 @Injectable()
 export class CustomersService {
-  create(createCustomerDto: CreateCustomerDto) {
-    return 'This action adds a new customer';
+  constructor(
+    @InjectRepository(Customer)
+    private customersRepository: Repository<Customer>,
+  ) {}
+
+  async create(createCustomerDto: CreateCustomerDto): Promise<Customer> {
+    return await this.customersRepository.save(createCustomerDto).catch((e) => {
+      throw new InternalServerErrorException(e.message);
+    });
   }
 
-  findAll() {
-    return `This action returns all customers`;
+  async findAll(): Promise<Customer[]> {
+    return await this.customersRepository.find().catch((e) => {
+      throw new InternalServerErrorException(e.message);
+    });
   }
 
-  findOne(id: number) {
-    return `This action returns a #${id} customer`;
+  async findOne(id: number): Promise<Customer> {
+    const customer = await this.customersRepository.findOneBy({
+      customerId: id,
+    });
+    if (!customer) {
+      throw new NotFoundException(`Customer not found (${id})`);
+    }
+    return customer;
   }
 
-  update(id: number, updateCustomerDto: UpdateCustomerDto) {
-    return `This action updates a #${id} customer`;
+  async update(
+    id: number,
+    updateCustomerDto: UpdateCustomerDto,
+  ): Promise<Customer> {
+    await this.customersRepository
+      .update({ customerId: id }, updateCustomerDto)
+      .catch((e) => {
+        throw new InternalServerErrorException(e.message);
+      });
+    const customer = await this.customersRepository.findOneBy({
+      customerId: id,
+    });
+    if (!customer) {
+      throw new NotFoundException(`Customer not found (${id})`);
+    }
+    return customer;
   }
 
-  remove(id: number) {
-    return `This action removes a #${id} customer`;
+  async remove(id: number): Promise<DeleteResult> {
+    const result = await this.customersRepository
+      .delete({ customerId: id })
+      .catch((e) => {
+        throw new InternalServerErrorException(e.message);
+      });
+    if (!result.affected) {
+      throw new NotFoundException(`Customer not found (${id})`);
+    }
+    return result;
   }
 }
```

é•·ã„ã®ã§ã™ãŒã€ä¸Šã‹ã‚‰ã€constructorã§Repositoryã‚’ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã—ã¾ã™ã€‚

ãã—ã¦ã€create ä»¥ä¸‹ã®å…¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’asyncã«ã—ã¦ã€æˆ»ã‚Šã‚’Promiseã«ã—ã¾ã™ã€‚
ã“ã‚Œã¯ã€TypeORMã®Repositoryã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒPromiseã‚’è¿”ã—ã¦ãã‚Œã‚‹éåŒæœŸã®ãƒ¡ã‚½ãƒƒãƒ‰ãªã®ã§ã€awaitã§éåŒæœŸé–¢æ•°å†…ã§åŒæœŸã—ã¾ã™ã€‚ï¼ˆNode.jsãŒé«˜é€Ÿãªã®ã¯éåŒæœŸã®ãŠã‹ã’ã ã¨æ€ã†ã®ã§ã€éåŒæœŸãŒé›£ã—ãã¦ã‚‚é ‘å¼µã£ã¦ã¤ã„ã¦ã„ãã¾ã—ã‚‡ã†ï¼‰

ã‚ã¨ã¯ã€è¿”ã—ãŸã„StatusCodeã«å¯¾å¿œã™ã‚‹ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã¾ã™ã€‚

## controller
controllerã¯ã€serviceã‚’å‘¼ã³å‡ºã—ã¾ã™ãŒã€serviceã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒéåŒæœŸã«ãªã£ãŸã®ã§ã€controllerã‚‚éåŒæœŸã«ã—ã¾ã™ã€‚

```diff ts:src/customers/customers.controller.ts
@@ -1,34 +1,49 @@
-import { Controller, Get, Post, Body, Patch, Param, Delete } from '@nestjs/common';
+import {
+  Controller,
+  Get,
+  Post,
+  Body,
+  Put,
+  Param,
+  Delete,
+} from '@nestjs/common';
+import { DeleteResult } from 'typeorm';
 import { CustomersService } from './customers.service';
 import { CreateCustomerDto } from './dto/create-customer.dto';
 import { UpdateCustomerDto } from './dto/update-customer.dto';
+import { Customer } from './entities/customer.entity';
 
 @Controller('customers')
 export class CustomersController {
   constructor(private readonly customersService: CustomersService) {}
 
   @Post()
-  create(@Body() createCustomerDto: CreateCustomerDto) {
-    return this.customersService.create(createCustomerDto);
+  async create(
+    @Body() createCustomerDto: CreateCustomerDto,
+  ): Promise<Customer> {
+    return await this.customersService.create(createCustomerDto);
   }
 
   @Get()
-  findAll() {
-    return this.customersService.findAll();
+  async findAll(): Promise<Customer[]> {
+    return await this.customersService.findAll();
   }
 
   @Get(':id')
-  findOne(@Param('id') id: string) {
-    return this.customersService.findOne(+id);
+  async findOne(@Param('id') id: string): Promise<Customer> {
+    return await this.customersService.findOne(+id);
   }
 
-  @Patch(':id')
-  update(@Param('id') id: string, @Body() updateCustomerDto: UpdateCustomerDto) {
-    return this.customersService.update(+id, updateCustomerDto);
+  @Put(':id')
+  async update(
+    @Param('id') id: string,
+    @Body() updateCustomerDto: UpdateCustomerDto,
+  ): Promise<Customer> {
+    return await this.customersService.update(+id, updateCustomerDto);
   }
 
   @Delete(':id')
-  remove(@Param('id') id: string) {
-    return this.customersService.remove(+id);
+  async remove(@Param('id') id: string): Promise<DeleteResult> {
+    return await this.customersService.remove(+id);
   }
 }
```

ã‚ã¨ã¯ã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã¯updateã®HTTPãƒ¡ã‚½ãƒƒãƒ‰ãŒPatchã ã£ãŸã®ã§ã™ãŒã€Putã«ã—ã¡ã‚ƒã„ã¾ã—ãŸã€‚

## module
TypeORMã®Customerã®æ©Ÿèƒ½ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

```diff ts:src/customers/customers.module.ts
@@ -1,9 +1,12 @@
 import { Module } from '@nestjs/common';
+import { TypeOrmModule } from '@nestjs/typeorm';
 import { CustomersService } from './customers.service';
 import { CustomersController } from './customers.controller';
+import { Customer } from './entities/customer.entity';
 
 @Module({
+  imports: [TypeOrmModule.forFeature([Customer])],
   controllers: [CustomersController],
-  providers: [CustomersService]
+  providers: [CustomersService],
 })
 export class CustomersModule {}
```

# æ¬¡å›ã¯

æœ€åˆã«ã€Œã‚„ã‚ŠãŸã„ã“ã¨ã€ã§æ›¸ã„ãŸå…¨ä½“ã‚’ä»•ä¸Šã’ã¦ã€é€”ä¸­ã§æ›¸ã„ãŸã€Œè¨­å®šãŒä¸¸è¦‹ãˆãªã®ã€ã‚’ãªã‚“ã¨ã‹ã—ã¦ã€å…¨ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚‚å…¬é–‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

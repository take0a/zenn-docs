---
title: "SQLMeshã§Sushi"
emoji: "ğŸ•¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["sqlmesh", "dbt", "python", "duckdb", "uv"]
published: false
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
å°‘ã—å‰ã®ã€Œ[SQLMeshå…¥é–€](https://zenn.dev/robon/articles/c8928f88f62218)ã€ã®ã€ŒãŠã‚ã‚Šã«ã€ã§ã“ã‚“ãªã“ã¨ã‚’æ›¸ãã¾ã—ãŸã€‚
> å…¬å¼ã‚µã‚¤ãƒˆã‚’å«ã‚ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã®æ•™æãŒå°‘ãªãã€ä½œè€…ã®æ„å›³ãŒã‚ã‹ã‚Šã«ãã„ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚

ã„ã‚ã„ã‚æ¢ã—ãŸçµæœã€å…¬å¼ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã€Œã“ã‚Œâ†“ã€ãŒã€ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼Ÿã¨ã„ã†ã“ã¨ã§ç´¹ä»‹ã—ã¦ã¿ã¾ã™ã€‚

https://github.com/TobikoData/sqlmesh-examples

# ã‚„ã£ã¦ã¿ãŸ
ã¾ãšã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã®èƒŒæ™¯ã§ã™ãŒã€å¯¿å¸ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã™ã‚‹ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚Tobiko ç¤¾ã®åå‰ã¯å¯¿å¸ãƒã‚¿ã®ãƒˆãƒ“ã‚³ã¨ã®ã“ã¨ã§ã™ã€‚

## å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«
æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ä»¥ä¸‹ã®ï¼•ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã€Œrawã€ã‚¹ã‚­ãƒ¼ãƒã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚

```mermaid
erDiagram
    marketing |o--o| demographics : "åŒä¸€é¡§å®¢"
    demographics ||--o{ order : "æ³¨æ–‡ã™ã‚‹"
    order ||--|{ order_items : "æ§‹æˆã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    marketing {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        status TEXT "é¡§å®¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
    }
    demographics {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        zip TEXT "é¡§å®¢ã®éƒµä¾¿ç•ªå·"
    }
    order {
        id INT "å›ºæœ‰ã®ID"
        customer_id INT "é¡§å®¢ID"
        waiter_id INT "ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ID"
        start_ts INT "æ³¨æ–‡é–‹å§‹æ™‚åˆ»"
        end_ts INT "æ³¨æ–‡çµ‚äº†æ™‚åˆ»"
        ds TEXT "æ—¥ä»˜"
    }
    order_items {
        id INT "å›ºæœ‰ID"
        order_id INT "æ³¨æ–‡ID"
        item_id INT "å•†å“ID"
        quantity INT "å•†å“æ•°é‡"
        ds TEXT "æ—¥ä»˜"
    }
    items {
        id INT "å›ºæœ‰ID"
        name TEXT "å•†å“å"
        price DOUBLE "å•†å“ä¾¡æ ¼"
        ds TEXT "æ—¥ä»˜"
    }
```

é¡§å®¢ã¯ï¼’ã¤ã«åˆ†ã‹ã‚Œã¦ã¾ã™ã‘ã©ã€æ¥åº—ã—ãŸã‚‰ status ãŒ ACTIVE ã«ãªã£ãŸã‚Šã€å¼•ã£è¶Šã—ãŸã‚‰ zip ãŒå¤‰ã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒé•ã†ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
order ã¨ order_item ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã®ã§ã€æ—¥ã€…è¿½åŠ ã•ã‚Œã¦ã„ãã¾ã™ã€‚
ãŠå¯¿å¸ã®ãƒã‚¿ãªã®ã§ã€items ã¯ã€æ™‚ä¾¡ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚‚æ—¥ã€…è¿½åŠ ã•ã‚Œã¦ã„ãã¨ã„ã†ã‚·ãƒŠãƒªã‚ªãªã®ã§ã—ã‚‡ã†ã€‚

ã“ã‚Œã‚‰ã¯å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«ãªã®ã§ã€`external_models.yaml` ã§ãƒ†ãƒ¼ãƒ–ãƒ«åã€ã‚«ãƒ©ãƒ åã€ãƒ‡ãƒ¼ã‚¿å‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```yaml: external_models.yaml
- name: raw.demographics
  columns:
    id: INT
    customer_id: INT
    zip: TEXT
- name: raw.items
  columns:
    id: INT
    name: TEXT
    price: DOUBLE
    ds: TEXT
- name: raw.marketing
  columns:
    id: INT
    customer_id: INT
    status: TEXT
- name: raw.order_items
  columns:
    id: INT
    order_id: INT
    item_id: INT
    quantity: INT
    ds: TEXT
- name: raw.orders
  columns:
    id: INT
    customer_id: INT
    waiter_id: INT
    start_ts: INT
    end_ts: INT
    ds: TEXT
```

## ãƒ¢ãƒ‡ãƒ«
### waiter_names
order.waiter_id ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ SEED ã®ã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã¾ã™ã€‚

```sql: models/waiter_names.sql
-- Seed data containing water names.
MODEL (
  name sushisimple.waiter_names,
  kind SEED (
    path '../seeds/waiter_names.csv'
  ),
  columns (
    id INT,
    name TEXT
  ),
  grain id
)
```
```csv: seeds/waiter_names.csv
id,name
0,Toby
1,Tyson
2,Ryan
3,George
4,Chris
5,Max
6,Vincent
7,Iaroslav
8,Emma
9,Maia
```

### customers
ã‚„ã¯ã‚Š customer ãŒå‰²ã‚Œã¦ã„ã‚‹ã®ã¯ã‚¤ãƒã‚¤ãƒãªã®ã§ã€orders ã—ã¦ãã‚ŒãŸé¡§å®¢ã‚’ VIEW ã§ç”¨æ„ã—ã¾ã™ã€‚

```sql: models/customer.sql
-- View of customer data.
MODEL (
  name sushisimple.customers,
  kind VIEW,
  cron '@daily',
  grain customer_id,
);

SELECT DISTINCT
  o.customer_id::INT AS customer_id,
  COALESCE(m.status, 'UNKNOWN')::TEXT AS status,
  d.zip::TEXT as zip
FROM raw.orders AS o
LEFT JOIN raw.marketing AS m
    ON o.customer_id = m.customer_id
LEFT JOIN raw.demographics AS d
    ON o.customer_id = d.customer_id
```

### customer_revenue_by_day
é¡§å®¢ã‚ãŸã‚Šã€æ—¥åˆ¥ã®å£²ã‚Šä¸Šã’ã‚’ VIEW ã§æ±‚ã‚ã¾ã™ã€‚CTE ã§ order_total ã‚’æ±‚ã‚ã¦ã‹ã‚‰ã€æ—¥åˆ¥ã€é¡§å®¢åˆ¥ã®åˆè¨ˆã‚’ä½œã‚Šã¾ã™ã€‚

```sql: models/customer_revenue_by_day.sql
-- View of revenue from customers by day.
MODEL (
  name sushisimple.customer_revenue_by_day,
  kind VIEW,
  cron '@daily',
  grain (customer_id, ds),
);

WITH order_total AS (
  SELECT
    oi.order_id AS order_id,
    SUM(oi.quantity * i.price) AS total,
    oi.ds AS ds
  FROM raw.order_items AS oi
  LEFT JOIN raw.items AS i
    ON oi.item_id = i.id AND oi.ds = i.ds
  GROUP BY
    oi.order_id,
    oi.ds
)
SELECT
  o.customer_id::INT AS customer_id, /* Customer id */
  SUM(ot.total)::DOUBLE AS revenue, /* Revenue from orders made by this customer */
  o.ds::TEXT AS ds /* Date */
FROM raw.orders AS o
LEFT JOIN order_total AS ot
  ON o.id = ot.order_id AND o.ds = ot.ds
GROUP BY
  o.customer_id,
  o.ds
```

### waiter_revenue_by_day
ã“ã¡ã‚‰ã¯ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ã•ã‚“ã‚ãŸã‚Šã§ã™ãŒã€CTE ãªã—ã§ã™ã€‚ã•ã£ãã®ã¯ã€CTE ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã‚ŠãŸã‹ã£ãŸã®ã§ã—ã‚‡ã†ã€‚

```sql: models/water_revenue_by_day.sql
-- View of revenue generated by each waiter by day.
MODEL (
  name sushisimple.waiter_revenue_by_day,
  kind VIEW,
  cron '@daily',
  grain (waiter_id, ds)
);

SELECT
  o.waiter_id::INT AS waiter_id, -- Waiter id
  SUM(oi.quantity * i.price)::DOUBLE AS revenue, -- Revenue from orders taken by this waiter
  o.ds::TEXT AS ds -- Order date
FROM raw.orders AS o
LEFT JOIN raw.order_items AS oi
  ON o.id = oi.order_id AND o.ds = oi.ds
LEFT JOIN raw.items AS i
  ON oi.item_id = i.id AND oi.ds = i.ds
GROUP BY
  o.waiter_id,
  o.ds
```

### top_waiters
ç›´è¿‘ã®æ—¥ä»˜ã®ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼åˆ¥å£²ã‚Šä¸Šã’ãƒˆãƒƒãƒ—10ã§ã™ã€‚

```sql: models/top_waiters.sql
-- View of 10 waiters with highest revenue on most recent day of data.
MODEL (
  name sushisimple.top_waiters,
  kind VIEW,
  cron '@daily',
  grain waiter_id
);

SELECT
  waiter_id::INT AS waiter_id,
  name::TEXT AS waiter_name,
  revenue::DOUBLE AS revenue
FROM sushisimple.waiter_revenue_by_day as r
LEFT JOIN sushisimple.waiter_names AS n
  ON r.waiter_id = n.id
WHERE
  ds = (
    SELECT
      MAX(ds)
    FROM sushisimple.waiter_revenue_by_day
  )
ORDER BY
  revenue DESC
LIMIT 10
```

### ERD
```mermaid
erDiagram
    order ||--|{ order_items : "æ§‹æˆã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    marketing {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        status TEXT "é¡§å®¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
    }
    demographics {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        zip TEXT "é¡§å®¢ã®éƒµä¾¿ç•ªå·"
    }
    order {
        id INT "å›ºæœ‰ã®ID"
        customer_id INT "é¡§å®¢ID"
        waiter_id INT "ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ID"
        start_ts INT "æ³¨æ–‡é–‹å§‹æ™‚åˆ»"
        end_ts INT "æ³¨æ–‡çµ‚äº†æ™‚åˆ»"
        ds TEXT "æ—¥ä»˜"
    }
    order_items {
        id INT "å›ºæœ‰ID"
        order_id INT "æ³¨æ–‡ID"
        item_id INT "å•†å“ID"
        quantity INT "å•†å“æ•°é‡"
        ds TEXT "æ—¥ä»˜"
    }
    items {
        id INT "å›ºæœ‰ID"
        name TEXT "å•†å“å"
        price DOUBLE "å•†å“ä¾¡æ ¼"
        ds TEXT "æ—¥ä»˜"
    }
    waiter_name {
        id INT
        name TEXT
    }
    customers ||--|{ orders : "æ³¨æ–‡ã™ã‚‹"
    customers ||--|| demosraphics : "å±æ€§"
    customers ||--o| marketings : "å±æ€§"
    customers {
        customer_id INT
        status TEXT
        zip TEXT
    }
    customer_revenue_by_day {
        customer_id INT "Customer id"
        revenue DOUBLE "Revenue from orders made by this customer"
        ds TEXT "Date"
    }
```


# ãŠã‚ã‚Šã«


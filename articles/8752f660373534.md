---
title: "SQLMeshã§Sushi"
emoji: "ğŸ•¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["sqlmesh", "dbt", "python", "duckdb", "uv"]
published: false
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
å°‘ã—å‰ã®ã€Œ[SQLMeshå…¥é–€](https://zenn.dev/robon/articles/c8928f88f62218)ã€ã®ã€ŒãŠã‚ã‚Šã«ã€ã§ã“ã‚“ãªã“ã¨ã‚’æ›¸ãã¾ã—ãŸã€‚
> å…¬å¼ã‚µã‚¤ãƒˆã‚’å«ã‚ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã®æ•™æãŒå°‘ãªãã€ä½œè€…ã®æ„å›³ãŒã‚ã‹ã‚Šã«ãã„ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚

ã„ã‚ã„ã‚æ¢ã—ãŸçµæœã€å…¬å¼ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã€Œã“ã‚Œâ†“ã€ãŒã€ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼Ÿ
ã¨ã„ã†ã“ã¨ã§ç´¹ä»‹ã—ã¦ã¿ã¾ã™ã€‚

https://github.com/TobikoData/sqlmesh-examples

# ã‚„ã£ã¦ã¿ãŸï¼ˆ001_shushi/1_simpleï¼‰
ã¾ãšã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã®èƒŒæ™¯ã§ã™ãŒã€å¯¿å¸ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã™ã‚‹ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚Tobiko ç¤¾ã®åå‰ã¯å¯¿å¸ãƒã‚¿ã®ãƒˆãƒ“ã‚³ã¨ã®ã“ã¨ã§ã™ã€‚

## å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«
æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ä»¥ä¸‹ã®ï¼•ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã€Œrawã€ã‚¹ã‚­ãƒ¼ãƒã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚

```mermaid
erDiagram
    marketing |o--o| demographics : "åŒä¸€é¡§å®¢"
    demographics ||--o{ orders: "æ³¨æ–‡ã™ã‚‹"
    orders||--|{ order_items : "æ§‹æˆã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    marketing {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        status TEXT "é¡§å®¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
    }
    demographics {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        zip TEXT "é¡§å®¢ã®éƒµä¾¿ç•ªå·"
    }
    orders{
        id INT "å›ºæœ‰ã®ID"
        customer_id INT "é¡§å®¢ID"
        waiter_id INT "ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ID"
        start_ts INT "æ³¨æ–‡é–‹å§‹æ™‚åˆ»"
        end_ts INT "æ³¨æ–‡çµ‚äº†æ™‚åˆ»"
        ds TEXT "æ—¥ä»˜"
    }
    order_items {
        id INT "å›ºæœ‰ID"
        order_id INT "æ³¨æ–‡ID"
        item_id INT "å•†å“ID"
        quantity INT "å•†å“æ•°é‡"
        ds TEXT "æ—¥ä»˜"
    }
    items {
        id INT "å›ºæœ‰ID"
        name TEXT "å•†å“å"
        price DOUBLE "å•†å“ä¾¡æ ¼"
        ds TEXT "æ—¥ä»˜"
    }
```

é¡§å®¢ã¯ï¼’ã¤ã«åˆ†ã‹ã‚Œã¦ã¾ã™ã‘ã©ã€æ¥åº—ã—ãŸã‚‰ `status` ãŒ `ACTIVE` ã«ãªã£ãŸã‚Šã€å¼•ã£è¶Šã—ãŸã‚‰ `zip` ãŒå¤‰ã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒé•ã†ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
`orders` ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ `order_item` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã®ã§ã€æ¥­å‹™ã§ã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ã€DWH ã«ã¯ä¸€å®šé–“éš”ã§è¿½åŠ ã•ã‚Œã¦ã„ãã¨è€ƒãˆã¦ã‚ˆã•ãã†ã§ã™ã€‚
ãŠå¯¿å¸ã®ãƒã‚¿ãªã®ã§ã€`items` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `price` ã®å€¤ã¯ã€æ™‚ä¾¡ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚‚æ—¥ã€…è¿½åŠ ã•ã‚Œã¦ã„ãã¨ã„ã†ã‚·ãƒŠãƒªã‚ªãªã®ã§ã—ã‚‡ã†ã€‚

ã“ã‚Œã‚‰ã¯å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«ãªã®ã§ã€`external_models.yaml` ã§ãƒ†ãƒ¼ãƒ–ãƒ«åã€ã‚«ãƒ©ãƒ åã€ãƒ‡ãƒ¼ã‚¿å‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€[sushi-overview.ipynb](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/sushi-overview.ipynb) ã®ã‚‚ã®ã‚’æ„è¨³ã—ã¾ã—ãŸã€‚

```yaml: external_models.yaml
- name: raw.demographics
  columns:
    id: INT
    customer_id: INT
    zip: TEXT
- name: raw.items
  columns:
    id: INT
    name: TEXT
    price: DOUBLE
    ds: TEXT
- name: raw.marketing
  columns:
    id: INT
    customer_id: INT
    status: TEXT
- name: raw.order_items
  columns:
    id: INT
    order_id: INT
    item_id: INT
    quantity: INT
    ds: TEXT
- name: raw.orders
  columns:
    id: INT
    customer_id: INT
    waiter_id: INT
    start_ts: INT
    end_ts: INT
    ds: TEXT
```

## ãƒ¢ãƒ‡ãƒ«
### waiter_names
`order.waiter_id` ã¨ã—ã¦ï¼ˆãŠãã‚‰ãæ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ä¸Šã¯ç¤¾å“¡ãƒã‚¹ã‚¿ãƒ¼ã®ã‚‚ã®ãŒï¼‰å‚ç…§ã•ã‚Œã¦ã„ã¾ã™ãŒã€ã“ã¡ã‚‰ã¯ï¼ˆé™å®šã•ã‚ŒãŸã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ã•ã‚“ã ã‘ãŒå¯¾è±¡ã¨ã„ã†ã“ã¨ã‹ï¼‰ SEED ã®ã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã¾ã™ã€‚

```sql: models/waiter_names.sql
-- Seed data containing water names.
MODEL (
  name sushisimple.waiter_names,
  kind SEED (
    path '../seeds/waiter_names.csv'
  ),
  columns (
    id INT,
    name TEXT
  ),
  grain id
)
```
```csv: seeds/waiter_names.csv
id,name
0,Toby
1,Tyson
2,Ryan
3,George
4,Chris
5,Max
6,Vincent
7,Iaroslav
8,Emma
9,Maia
```

### customers
ã‚„ã¯ã‚Š `customers` ãŒå‰²ã‚Œã¦ã„ã‚‹ã®ã¯ã‚¤ãƒã‚¤ãƒãªã®ã§ã€`orders` ã—ã¦ãã‚ŒãŸé¡§å®¢ã‚’ VIEW ã§ç”¨æ„ã—ã¦ã„ã¾ã™ã€‚

```sql: models/customer.sql
-- View of customer data.
MODEL (
  name sushisimple.customers,
  kind VIEW,
  cron '@daily',
  grain customer_id,
);

SELECT DISTINCT
  o.customer_id::INT AS customer_id,
  COALESCE(m.status, 'UNKNOWN')::TEXT AS status,
  d.zip::TEXT as zip
FROM raw.orders AS o
LEFT JOIN raw.marketing AS m
    ON o.customer_id = m.customer_id
LEFT JOIN raw.demographics AS d
    ON o.customer_id = d.customer_id
```

### customer_revenue_by_day
é¡§å®¢ã‚ãŸã‚Šã€æ—¥åˆ¥ã®å£²ã‚Šä¸Šã’ã‚’ VIEW ã§æ±‚ã‚ã¾ã™ã€‚CTE ã§ `order_total` ã‚’æ±‚ã‚ã¦ã‹ã‚‰ã€æ—¥åˆ¥ã€é¡§å®¢åˆ¥ã®åˆè¨ˆã‚’ä½œã‚Šã¾ã™ã€‚

```sql: models/customer_revenue_by_day.sql
-- View of revenue from customers by day.
MODEL (
  name sushisimple.customer_revenue_by_day,
  kind VIEW,
  cron '@daily',
  grain (customer_id, ds),
);

WITH order_total AS (
  SELECT
    oi.order_id AS order_id,
    SUM(oi.quantity * i.price) AS total,
    oi.ds AS ds
  FROM raw.order_items AS oi
  LEFT JOIN raw.items AS i
    ON oi.item_id = i.id AND oi.ds = i.ds
  GROUP BY
    oi.order_id,
    oi.ds
)
SELECT
  o.customer_id::INT AS customer_id, /* Customer id */
  SUM(ot.total)::DOUBLE AS revenue, /* Revenue from orders made by this customer */
  o.ds::TEXT AS ds /* Date */
FROM raw.orders AS o
LEFT JOIN order_total AS ot
  ON o.id = ot.order_id AND o.ds = ot.ds
GROUP BY
  o.customer_id,
  o.ds
```

### waiter_revenue_by_day
ã“ã¡ã‚‰ã¯ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ã•ã‚“ã‚ãŸã‚Šã®å£²ã‚Šä¸Šã’ã§ã™ãŒã€CTE ãªã—ã§ã™ã€‚ã•ã£ãã®ã¯ã€é¡§å®¢ãŒå¤šã„ã¨ã„ã†æƒ³å®šã‹ã€CTE ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’ä½œã‚ŠãŸã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã­ã€‚å†åˆ©ç”¨ã™ã‚‹ãªã‚‰ `order_total` ã‚‚ VIEW ã§ãƒ¢ãƒ‡ãƒ«ã«ã—ã¦ãŠãã®ã‚‚ã‚ã‚Šã§ã—ã‚‡ã†ã€‚

```sql: models/water_revenue_by_day.sql
-- View of revenue generated by each waiter by day.
MODEL (
  name sushisimple.waiter_revenue_by_day,
  kind VIEW,
  cron '@daily',
  grain (waiter_id, ds)
);

SELECT
  o.waiter_id::INT AS waiter_id, -- Waiter id
  SUM(oi.quantity * i.price)::DOUBLE AS revenue, -- Revenue from orders taken by this waiter
  o.ds::TEXT AS ds -- Order date
FROM raw.orders AS o
LEFT JOIN raw.order_items AS oi
  ON o.id = oi.order_id AND o.ds = oi.ds
LEFT JOIN raw.items AS i
  ON oi.item_id = i.id AND oi.ds = i.ds
GROUP BY
  o.waiter_id,
  o.ds
```

### top_waiters
ç›´è¿‘ã®æ—¥ä»˜ã®ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼åˆ¥å£²ã‚Šä¸Šã’ãƒˆãƒƒãƒ—10ã§ã™ã€‚

```sql: models/top_waiters.sql
-- View of 10 waiters with highest revenue on most recent day of data.
MODEL (
  name sushisimple.top_waiters,
  kind VIEW,
  cron '@daily',
  grain waiter_id
);

SELECT
  waiter_id::INT AS waiter_id,
  name::TEXT AS waiter_name,
  revenue::DOUBLE AS revenue
FROM sushisimple.waiter_revenue_by_day as r
LEFT JOIN sushisimple.waiter_names AS n
  ON r.waiter_id = n.id
WHERE
  ds = (
    SELECT
      MAX(ds)
    FROM sushisimple.waiter_revenue_by_day
  )
ORDER BY
  revenue DESC
LIMIT 10
```

### ERD
ã¾ãã€ç©ã¿é‡ã­ãŸ VIEW ãªã®ã§ã€ãªã‚“ã¡ã‚ƒã£ã¦ ER å›³ã§ã™ãŒã€‚

```mermaid
erDiagram
    orders||--|{ order_items : "æ§‹æˆã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    marketing {
    }
    demographics {
    }
    orders{
    }
    order_items {
    }
    items {
    }
    waiter_name {
        id INT
        name TEXT
    }
    customers ||--|{ orders: "æ³¨æ–‡ã™ã‚‹"
    customers ||--|| demographics : "å±æ€§"
    customers ||--o| marketing : "å±æ€§"
    customers {
        customer_id INT
        status TEXT
        zip TEXT
    }
    customer_revenue_by_day |o--|| customers : "å¯¾è±¡é¡§å®¢"
    customer_revenue_by_day ||--|{ orders: "é›†è¨ˆå¯¾è±¡"
    customer_revenue_by_day {
        customer_id INT
        revenue DOUBLE
        ds TEXT
    }
    waiter_revenue_by_day |o--|| waiter_name : "å¯¾è±¡ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼"
    waiter_revenue_by_day ||--|{ orders: "é›†è¨ˆå¯¾è±¡"
    waiter_revenue_by_day {
        waiter_id INT
        revenue DOUBLE
        ds TEXT
    }
    top_waiters |o--|| waiter_name : "å¯¾è±¡ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼"
    top_waiters |o--|| waiter_revenue_by_day : "æŠ½å‡ºå…ƒ"
    top_waiters {
        waiter_id INT
        waiter_name TEXT
        revenue DOUBLE
    }
```

## å‹•ã‹ã™å‰ã«
### Setup
[README.md](https://github.com/TobikoData/sqlmesh-examples/blob/main/README.md) ã® `Setup` ã®ã‚ˆã†ã«ã‚„ã£ã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€æœ€è¿‘ã¯ã€ã™ã£ã‹ã‚Š `uv` æ´¾ãªã®ã§ã€`uv` å‰æã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

```
cd sqlmesh-examples
uv init --bare
uv venv
uv add sqlmesh
```

### DuckDB
ã¾ã•ã«ã€å‹•ã‹ã™å‰ã«ã€DuckDB ã®ä¸­èº«ã‚’ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚
```
$ duckdb 001_sushi/1_simple/db/sushi-example.db 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D select database_name  from duckdb_databases() where internal = false;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ database_name â”‚
â”‚    varchar    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sushi-example â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select schema_name from duckdb_schemas() where database_name = 'sushi-example';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ schema_name â”‚
â”‚   varchar   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ main        â”‚
â”‚ raw         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select table_name from duckdb_tables() where schema_name = 'raw';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  table_name  â”‚
â”‚   varchar    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ demographics â”‚
â”‚ items        â”‚
â”‚ marketing    â”‚
â”‚ orders       â”‚
â”‚ order_items  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select view_name from duckdb_views() where schema_name = 'raw';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ view_name â”‚
â”‚  varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  0 rows   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select table_name, column_name, comment, data_type from duckdb_columns() where schema_name = 'raw';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  table_name  â”‚ column_name â”‚ comment â”‚ data_type â”‚
â”‚   varchar    â”‚   varchar   â”‚ varchar â”‚  varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ demographics â”‚ id          â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ demographics â”‚ customer_id â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ demographics â”‚ zip         â”‚ NULL    â”‚ VARCHAR   â”‚
â”‚ items        â”‚ id          â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ items        â”‚ name        â”‚ NULL    â”‚ VARCHAR   â”‚
â”‚ items        â”‚ price       â”‚ NULL    â”‚ DOUBLE    â”‚
â”‚ items        â”‚ ds          â”‚ NULL    â”‚ DATE      â”‚
â”‚ marketing    â”‚ id          â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ marketing    â”‚ customer_id â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ marketing    â”‚ status      â”‚ NULL    â”‚ VARCHAR   â”‚
â”‚ orders       â”‚ id          â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ orders       â”‚ customer_id â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ orders       â”‚ waiter_id   â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ orders       â”‚ start_ts    â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ orders       â”‚ end_ts      â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ orders       â”‚ ds          â”‚ NULL    â”‚ DATE      â”‚
â”‚ order_items  â”‚ id          â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ order_items  â”‚ order_id    â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ order_items  â”‚ item_id     â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ order_items  â”‚ quantity    â”‚ NULL    â”‚ INTEGER   â”‚
â”‚ order_items  â”‚ ds          â”‚ NULL    â”‚ DATE      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 21 rows                                4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .q
```

## å‹•ã‹ã™
### sqlmesh plan
`config.yaml` ã®ã‚ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¸ç§»å‹•ã—ã¦ã€`sqlmesh plan` ã—ã¾ã™ã€‚

```
$ cd 001_sushi/1_simple/
$ uv run sqlmesh plan
Initializing new project state...

`prod` environment will be initialized

Models:
â””â”€â”€ Added:
    â”œâ”€â”€ raw.demographics
    â”œâ”€â”€ raw.items
    â”œâ”€â”€ raw.marketing
    â”œâ”€â”€ raw.order_items
    â”œâ”€â”€ raw.orders
    â”œâ”€â”€ sushisimple.customer_revenue_by_day
    â”œâ”€â”€ sushisimple.customers
    â”œâ”€â”€ sushisimple.top_waiters
    â”œâ”€â”€ sushisimple.waiter_names
    â””â”€â”€ sushisimple.waiter_revenue_by_day
Models needing backfill:
â”œâ”€â”€ sushisimple.customer_revenue_by_day: [recreate view]
â”œâ”€â”€ sushisimple.customers: [recreate view]
â”œâ”€â”€ sushisimple.top_waiters: [recreate view]
â”œâ”€â”€ sushisimple.waiter_names: [full refresh]
â””â”€â”€ sushisimple.waiter_revenue_by_day: [recreate view]
Apply - Backfill Tables [y/n]: y
[1/1] sushisimple.customer_revenue_by_day   [recreate view]                               0.04s   
[1/1] sushisimple.customers                 [recreate view]                               0.03s   
[1/1] sushisimple.waiter_names              [insert seed file]                            0.04s   
[1/1] sushisimple.waiter_revenue_by_day     [recreate view]                               0.04s   
[1/1] sushisimple.top_waiters               [recreate view]                               0.03s   
Executing model batches â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100.0% â€¢ 5/5 â€¢ 0:00:00                                                           
                                                                                                                                                  
âœ” Model batches executed

Updating virtual layer  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100.0% â€¢ 5/5 â€¢ 0:00:00

âœ” Virtual layer updated

```

### DuckDB
ã€Œå‹•ã‹ã™å‰ã«ã€ã¨åŒæ§˜ã«ä¸Šã‹ã‚‰
```
$ duckdb db/sushi-example.db 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D select schema_name from duckdb_schemas() where database_name = 'sushi-example';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     schema_name      â”‚
â”‚       varchar        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ main                 â”‚
â”‚ raw                  â”‚
â”‚ sqlmesh              â”‚
â”‚ sqlmesh__sushisimple â”‚
â”‚ sushisimple          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select schema_name, table_name from duckdb_tables() where schema_name <> 'main';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     schema_name      â”‚              table_name               â”‚
â”‚       varchar        â”‚                varchar                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ raw                  â”‚ demographics                          â”‚
â”‚ raw                  â”‚ items                                 â”‚
â”‚ raw                  â”‚ marketing                             â”‚
â”‚ raw                  â”‚ orders                                â”‚
â”‚ raw                  â”‚ order_items                           â”‚
â”‚ sqlmesh              â”‚ _auto_restatements                    â”‚
â”‚ sqlmesh              â”‚ _environments                         â”‚
â”‚ sqlmesh              â”‚ _environment_statements               â”‚
â”‚ sqlmesh              â”‚ _intervals                            â”‚
â”‚ sqlmesh              â”‚ _snapshots                            â”‚
â”‚ sqlmesh              â”‚ _versions                             â”‚
â”‚ sqlmesh__sushisimple â”‚ sushisimple__waiter_names__3510154461 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 12 rows                                            2 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select schema_name, view_name from duckdb_views() where database_name = 'sushi-example' and schema_name <> 'main';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     schema_name      â”‚                    view_name                     â”‚
â”‚       varchar        â”‚                     varchar                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sqlmesh__sushisimple â”‚ sushisimple__customers__417166203                â”‚
â”‚ sqlmesh__sushisimple â”‚ sushisimple__customer_revenue_by_day__1188378195 â”‚
â”‚ sqlmesh__sushisimple â”‚ sushisimple__top_waiters__381189255              â”‚
â”‚ sqlmesh__sushisimple â”‚ sushisimple__waiter_revenue_by_day__157094348    â”‚
â”‚ sushisimple          â”‚ customers                                        â”‚
â”‚ sushisimple          â”‚ customer_revenue_by_day                          â”‚
â”‚ sushisimple          â”‚ top_waiters                                      â”‚
â”‚ sushisimple          â”‚ waiter_names                                     â”‚
â”‚ sushisimple          â”‚ waiter_revenue_by_day                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select table_name, column_name, comment, data_type from duckdb_columns() where schema_name = 'sqlmesh__sushisimple';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    table_name                    â”‚ column_name â”‚                  comment                  â”‚ data_type â”‚
â”‚                     varchar                      â”‚   varchar   â”‚                  varchar                  â”‚  varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sushisimple__customers__417166203                â”‚ customer_id â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ sushisimple__customers__417166203                â”‚ status      â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ sushisimple__customers__417166203                â”‚ zip         â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ sushisimple__customer_revenue_by_day__1188378195 â”‚ customer_id â”‚ Customer id                               â”‚ INTEGER   â”‚
â”‚ sushisimple__customer_revenue_by_day__1188378195 â”‚ revenue     â”‚ Revenue from orders made by this customer â”‚ DOUBLE    â”‚
â”‚ sushisimple__customer_revenue_by_day__1188378195 â”‚ ds          â”‚ Date                                      â”‚ VARCHAR   â”‚
â”‚ sushisimple__top_waiters__381189255              â”‚ waiter_id   â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ sushisimple__top_waiters__381189255              â”‚ waiter_name â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ sushisimple__top_waiters__381189255              â”‚ revenue     â”‚ NULL                                      â”‚ DOUBLE    â”‚
â”‚ sushisimple__waiter_names__3510154461            â”‚ id          â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ sushisimple__waiter_names__3510154461            â”‚ name        â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ sushisimple__waiter_revenue_by_day__157094348    â”‚ waiter_id   â”‚ Waiter id                                 â”‚ INTEGER   â”‚
â”‚ sushisimple__waiter_revenue_by_day__157094348    â”‚ revenue     â”‚ Revenue from orders taken by this waiter  â”‚ DOUBLE    â”‚
â”‚ sushisimple__waiter_revenue_by_day__157094348    â”‚ ds          â”‚ Order date                                â”‚ VARCHAR   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 14 rows                                                                                                      4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select table_name, column_name, comment, data_type from duckdb_columns() where schema_name = 'sushisimple';
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       table_name        â”‚ column_name â”‚                  comment                  â”‚ data_type â”‚
â”‚         varchar         â”‚   varchar   â”‚                  varchar                  â”‚  varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ customers               â”‚ customer_id â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ customers               â”‚ status      â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ customers               â”‚ zip         â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ customer_revenue_by_day â”‚ customer_id â”‚ Customer id                               â”‚ INTEGER   â”‚
â”‚ customer_revenue_by_day â”‚ revenue     â”‚ Revenue from orders made by this customer â”‚ DOUBLE    â”‚
â”‚ customer_revenue_by_day â”‚ ds          â”‚ Date                                      â”‚ VARCHAR   â”‚
â”‚ top_waiters             â”‚ waiter_id   â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ top_waiters             â”‚ waiter_name â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ top_waiters             â”‚ revenue     â”‚ NULL                                      â”‚ DOUBLE    â”‚
â”‚ waiter_names            â”‚ id          â”‚ NULL                                      â”‚ INTEGER   â”‚
â”‚ waiter_names            â”‚ name        â”‚ NULL                                      â”‚ VARCHAR   â”‚
â”‚ waiter_revenue_by_day   â”‚ waiter_id   â”‚ Waiter id                                 â”‚ INTEGER   â”‚
â”‚ waiter_revenue_by_day   â”‚ revenue     â”‚ Revenue from orders taken by this waiter  â”‚ DOUBLE    â”‚
â”‚ waiter_revenue_by_day   â”‚ ds          â”‚ Order date                                â”‚ VARCHAR   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 14 rows                                                                             4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .q
```

ä¸Šã‹ã‚‰é †ã«ã€
ã‚¹ã‚­ãƒ¼ãƒã¯ï¼“ã¤è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
- `sqlmesh` ã¯ã€sqlmesh ã®çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã™ã€‚
- `sqlmesh__sushisimple` ã¯ã€`sushisimple` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç‰©ç†ãƒ¬ã‚¤ãƒ¤ã§ã™ã€‚
- `suchisimple` ã¯ã€`prod` ç’°å¢ƒã®è«–ç†ãƒ¬ã‚¤ãƒ¤ã§ã™ã€‚

ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã€çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ï¼–ã¤ã€ç‰©ç†ãƒ¬ã‚¤ãƒ¤ã« SEED ã® `waiter_names` ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ãŒï¼‘ã¤è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã€å¾Œã‹ã‚‰ã€è©³ç´°ã‚’ã¿ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

ãƒ“ãƒ¥ãƒ¼ã¯ã€ãã‚Œãã‚Œãƒ¢ãƒ‡ãƒ«ã«ç›¸å½“ã™ã‚‹ã‚‚ã®ãŒã€ç‰©ç†ãƒ¬ã‚¤ãƒ¤ã«ï¼”ã¤ã€è«–ç†ãƒ¬ã‚¤ãƒ¤ã«ï¼•ã¤è¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚ç‰©ç†ãƒ¬ã‚¤ãƒ¤ãŒï¼‘ã¤å°‘ãªã„ã®ã¯ã€ï¼‘ã¤ãŒ SEED ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãªã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

æ¬¡ã«ã€ç‰©ç†ãƒ¬ã‚¤ãƒ¤ã®ã‚«ãƒ©ãƒ ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ãƒ¢ãƒ‡ãƒ«ã®ã¨ãŠã‚Šã§ã™ã€‚ãƒ¢ãƒ‡ãƒ«ã®ã‚«ãƒ©ãƒ ã«ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã§ã‚³ãƒ¡ãƒ³ãƒˆã•ã‚Œã¦ã„ãŸå†…å®¹ãŒã€DuckDB ã®ã‚«ãƒ©ãƒ ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚‚æ®‹ã•ã‚Œã¦ã„ã¾ã™ã€‚

æœ€å¾Œã¯ã€è«–ç†ãƒ¬ã‚¤ãƒ¤ã®ã‚«ãƒ©ãƒ ã§ã™ãŒã€ç‰©ç†ãƒ¬ã‚¤ãƒ¤ã®åˆ¥åã®é–¢ä¿‚ã«ãªã‚Šã¾ã™ã®ã§ã€ã‚³ãƒ¡ãƒ³ãƒˆã‚’å«ã‚ã¦åŒã˜ã§ã™ã€‚

### çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ï¼–ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

#### _auto_restatements
ã“ã®æ™‚ç‚¹ã§ã¯ç©ºã§ã—ãŸã€‚
```
D select * from sqlmesh._auto_restatements;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ snapshot_name â”‚ snapshot_version â”‚ next_auto_restatement_ts â”‚
â”‚    varchar    â”‚     varchar      â”‚          int64           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           0 rows                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### _environments
1ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€15ã‚«ãƒ©ãƒ ã‚ã‚‹ã®ã§ã€CSV ã« export ã—ã¦ã€è»¢ç½®ã—ã¾ã™ã€‚export ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚„ã‚Šã¾ã™ã€‚
```
D copy sqlmesh._environments to '_environments.csv' (header, delimiter ',');
```

| é …ç›® | å€¤ |
|---|---|
| name | prod |
| snapshots | é•·ã„ JSON æ–‡å­—åˆ—ãªã®ã§ã€ä¸‹è¨˜ã¸ |
| start_at | 2025-10-07 00:00:00 |
| end_at |  |
| plan_id | 0d2e4bf9844c4407a00230429f4a47c2 |
| previous_plan_id |  |
| expiration_ts |  |
| finalized_ts | 1759890044886 |
| promoted_snapshot_ids |  |
| suffix_target | schema |
| catalog_name_override |  |
| previous_finalized_snapshots | [] |
| normalize_name | true |
| requirements | {} |
| gateway_managed | false |

```json: _environments.snapshots
[
  {
    "name": "\"sushi-example\".\"sushisimple\".\"customers\"",
    "dev_version": "417166203",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "3649155621",
      "metadata_hash": "54374572",
      "parent_data_hash": "3540115527",
      "parent_metadata_hash": "36623728"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "417166203",
    "physical_schema": "sqlmesh__sushisimple",
    "parents": [
      {
        "name": "\"sushi-example\".\"raw\".\"demographics\"",
        "identifier": "1112628036"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"orders\"",
        "identifier": "4177358286"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"marketing\"",
        "identifier": "951266748"
      }
    ],
    "kind_name": "VIEW",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"sushisimple\".\"waiter_revenue_by_day\"",
    "dev_version": "157094348",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "1974234594",
      "metadata_hash": "338732671",
      "parent_data_hash": "2615392153",
      "parent_metadata_hash": "36623728"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "157094348",
    "physical_schema": "sqlmesh__sushisimple",
    "parents": [
      {
        "name": "\"sushi-example\".\"raw\".\"orders\"",
        "identifier": "4177358286"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"items\"",
        "identifier": "4057945501"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"order_items\"",
        "identifier": "2963435990"
      }
    ],
    "kind_name": "VIEW",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"sushisimple\".\"waiter_names\"",
    "dev_version": "3510154461",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "4220286235",
      "metadata_hash": "1646615025",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "3510154461",
    "physical_schema": "sqlmesh__sushisimple",
    "parents": [],
    "kind_name": "SEED",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"sushisimple\".\"customer_revenue_by_day\"",
    "dev_version": "1188378195",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "1699790014",
      "metadata_hash": "3913364503",
      "parent_data_hash": "2615392153",
      "parent_metadata_hash": "36623728"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "1188378195",
    "physical_schema": "sqlmesh__sushisimple",
    "parents": [
      {
        "name": "\"sushi-example\".\"raw\".\"orders\"",
        "identifier": "4177358286"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"items\"",
        "identifier": "4057945501"
      },
      {
        "name": "\"sushi-example\".\"raw\".\"order_items\"",
        "identifier": "2963435990"
      }
    ],
    "kind_name": "VIEW",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"sushisimple\".\"top_waiters\"",
    "dev_version": "381189255",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "2591817560",
      "metadata_hash": "460664824",
      "parent_data_hash": "1999905133",
      "parent_metadata_hash": "737318949"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "381189255",
    "physical_schema": "sqlmesh__sushisimple",
    "parents": [
      {
        "name": "\"sushi-example\".\"sushisimple\".\"waiter_revenue_by_day\"",
        "identifier": "2200766198"
      },
      {
        "name": "\"sushi-example\".\"sushisimple\".\"waiter_names\"",
        "identifier": "1509510622"
      }
    ],
    "kind_name": "VIEW",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"raw\".\"demographics\"",
    "dev_version": "3906394976",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "2544791803",
      "metadata_hash": "1551791906",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "3906394976",
    "physical_schema": "sqlmesh__raw",
    "parents": [],
    "kind_name": "EXTERNAL",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"raw\".\"items\"",
    "dev_version": "3791312541",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "1248473033",
      "metadata_hash": "1551791906",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "3791312541",
    "physical_schema": "sqlmesh__raw",
    "parents": [],
    "kind_name": "EXTERNAL",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"raw\".\"marketing\"",
    "dev_version": "1833826140",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "3084179100",
      "metadata_hash": "1551791906",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "1833826140",
    "physical_schema": "sqlmesh__raw",
    "parents": [],
    "kind_name": "EXTERNAL",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"raw\".\"order_items\"",
    "dev_version": "490972095",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "1013284553",
      "metadata_hash": "1551791906",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "490972095",
    "physical_schema": "sqlmesh__raw",
    "parents": [],
    "kind_name": "EXTERNAL",
    "node_type": "model",
    "virtual_environment_mode": "full"
  },
  {
    "name": "\"sushi-example\".\"raw\".\"orders\"",
    "dev_version": "3608433385",
    "change_category": 1,
    "fingerprint": {
      "data_hash": "2091497075",
      "metadata_hash": "1551791906",
      "parent_data_hash": "0",
      "parent_metadata_hash": "0"
    },
    "previous_versions": [],
    "dev_table_suffix": "dev",
    "table_naming_convention": "schema_and_table",
    "forward_only": false,
    "version": "3608433385",
    "physical_schema": "sqlmesh__raw",
    "parents": [],
    "kind_name": "EXTERNAL",
    "node_type": "model",
    "virtual_environment_mode": "full"
  }
]
```

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ä¸Šã¯ã€[environment.py](https://github.com/TobikoData/sqlmesh/blob/main/sqlmesh/core/environment.py) ã§ã€ã„ã‚ã‚†ã‚‹ SQLMesh ã®ç’°å¢ƒã§ã€ç‰©ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã‚’ä¿æœ‰ã™ã‚‹ç›®çš„ã®ã‚ˆã†ã§ã™ã€‚

ä¸Šè¨˜ã® `snapshots` ã‚’å«ã‚ã€æ§‹é€ ã®ã‚ã‚‹é …ç›®ã®èª¬æ˜ã¯ä»¥ä¸‹ã®ã¨ãŠã‚Šã§ã™ã€‚
- `snapshots`: ã“ã®ç’°å¢ƒã«å«ã¾ã‚Œã‚‹ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€‚
- `promoted_snapshot_ids`: ã“ã®ç’°å¢ƒã§ãƒ—ãƒ­ãƒ¢ãƒ¼ãƒˆã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®IDï¼ˆã¤ã¾ã‚Šã€ãƒ“ãƒ¥ãƒ¼ãŒä½œæˆã•ã‚ŒãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ã€‚
æŒ‡å®šã—ãªã„å ´åˆã¯ã€ã™ã¹ã¦ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆãŒãƒ—ãƒ­ãƒ¢ãƒ¼ãƒˆã•ã‚Œã¾ã™ã€‚
- `previous_finalized_snapshots`: ã“ã®ç’°å¢ƒãŒæœ€å¾Œã«ãƒ•ã‚¡ã‚¤ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸéš›ã«å«ã¾ã‚Œã¦ã„ãŸã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€‚
- `requirements`: ã“ã®ç’°å¢ƒå†…ã®ã™ã¹ã¦ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã€‚

#### _environment_statements
ã“ã®æ™‚ç‚¹ã§ã¯ç©ºã§ã—ãŸã€‚
```
D select * from sqlmesh._environment_statements;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ environment_name â”‚ plan_id â”‚ environment_statements â”‚
â”‚     varchar      â”‚ varchar â”‚        varchar         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       0 rows                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### _intervals
5ãƒ¬ã‚³ãƒ¼ãƒ‰ã€13ã‚«ãƒ©ãƒ ã‚ã‚‹ã®ã§ã€CSV ã« export ã—ã¦ã€è»¢ç½®ã—ã¾ã™ã€‚

| é …ç›® | ãƒ¬ã‚³ãƒ¼ãƒ‰1 | ãƒ¬ã‚³ãƒ¼ãƒ‰2 | ãƒ¬ã‚³ãƒ¼ãƒ‰3 | ãƒ¬ã‚³ãƒ¼ãƒ‰4 | ãƒ¬ã‚³ãƒ¼ãƒ‰5 | 
|---|---|---|---|---|---|
| id | 48043f05d82f4bbb8c48a128ef0b7ef4 | 172d7f9fdbde4fbfbb9c6a6ba9760647 | 88e57515c68b4a2e8fef78a7852cb9b7 | 8e301b2f6b3143bb97967873c5f8d0f4 | d2000416fb474fd8aaafa85f8b09626e |
| created_ts | 1759890044619 | 1759890044653 | 1759890044697 | 1759890044737 | 1759890044769 |
| name | "sushi-example".<br>"sushisimple".<br>"customer_revenue_by_day" | "sushi-example".<br>"sushisimple".<br>"customers" | "sushi-example".<br>"sushisimple".<br>"waiter_names" | "sushi-example".<br>"sushisimple".<br>"waiter_revenue_by_day" | "sushi-example".<br>"sushisimple".<br>"top_waiters" |
| identifier | 1954947422 | 3508720648 | 1509510622 | 2200766198 | 2818951582 |
| version | 1188378195 | 417166203 | 3510154461 | 157094348 | 381189255 |
| start_ts | 1759795200000 | 1759795200000 | 1759795200000 | 1759795200000 | 1759795200000 |
| end_ts | 1759881600000 | 1759881600000 | 1759881600000 | 1759881600000 | 1759881600000 |
| is_dev | false | false | false | false | false |
| is_removed | false | false | false | false | false |
| is_compacted | false | false | false | false | false |
| is_pending_restatement | false | false | false | false | false |
| dev_version | 1188378195 | 417166203 | 3510154461 | 157094348 | 381189255 |
| last_altered_ts | 1759890044618 | 1759890044653 | 1759890044697 | 1759890044736 | 1759890044769 |

ãƒ¬ã‚³ãƒ¼ãƒ‰1 ã® UNIX Timestamp ã‚‰ã—ãå€¤ã‚’å¤‰æ›ã™ã‚‹ã¨ã€GMT ã§ã¯

- `created_ts`: 2025å¹´10æœˆ8æ—¥ Wednesday 02:20:44.619
- `start_ts`: 2025å¹´10æœˆ7æ—¥ Tuesday 00:00:00
- `end_ts`: 2025å¹´10æœˆ8æ—¥ Wednesday 00:00:00
- `last_altered_ts`: 2025å¹´10æœˆ8æ—¥ Wednesday 02:20:44.618

ã¨ãªã£ã¦ã€ä»Šå›ã®ãƒ¢ãƒ‡ãƒ«ã¯ã€å…¨ã¦ `cron '@daily'` ãªã®ã§ã€å®Ÿéš›ã«å‹•ã‹ã—ãŸæ—¥æœ¬æ™‚é–“ã® 10/8 11:20 ã‹ã‚‰å„å€¤ã‚’ç®—å‡ºã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

#### _snapshots
10ãƒ¬ã‚³ãƒ¼ãƒ‰ã€12ã‚«ãƒ©ãƒ ã‚ã‚‹ã®ã§ã€CSV ã« export ã—ã¦ã€è»¢ç½®ã—ã¦ã€æŠ˜ã‚Šè¿”ã—ã¾ã™ã€‚

| é …ç›® | ãƒ¬ã‚³ãƒ¼ãƒ‰1 | ãƒ¬ã‚³ãƒ¼ãƒ‰2 | ãƒ¬ã‚³ãƒ¼ãƒ‰3 | ãƒ¬ã‚³ãƒ¼ãƒ‰4 | ãƒ¬ã‚³ãƒ¼ãƒ‰5 | 
|---|---|---|---|---|---| 
| name | "sushi-example".<br>"sushisimple".<br>"customers" | "sushi-example".<br>"sushisimple".<br>"waiter_revenue_by_day" | "sushi-example".<br>"sushisimple".<br>"waiter_names" | "sushi-example".<br>"sushisimple".<br>"customer_revenue_by_day" | "sushi-example".<br>"sushisimple".<br>"top_waiters" |
| identifier | 3508720648 | 2200766198 | 1509510622 | 1954947422 | 2818951582 |
| version | 417166203 | 157094348 | 3510154461 | 1188378195 | 381189255 |
| snapshot | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON |
| kind_name | VIEW | VIEW | SEED | VIEW | VIEW |
| updated_ts | 1759890044799 | 1759890044799 | 1759890044799 | 1759890044799 | 1759890044799 |
| unpaused_ts | 1759889880000 | 1759889880000 | 1759889880000 | 1759889880000 | 1759889880000 |
| ttl_ms | 604800000 | 604800000 | 604800000 | 604800000 | 604800000 |
| unrestorable | false | false | false | false | false |
| forward_only | false | false | false | false | false |
| dev_version | 417166203 | 157094348 | 3510154461 | 1188378195 | 381189255 |
| fingerprint | JSON | JSON | JSON | JSON | JSON |

| é …ç›® | ãƒ¬ã‚³ãƒ¼ãƒ‰6 | ãƒ¬ã‚³ãƒ¼ãƒ‰7 | ãƒ¬ã‚³ãƒ¼ãƒ‰8 | ãƒ¬ã‚³ãƒ¼ãƒ‰9 | ãƒ¬ã‚³ãƒ¼ãƒ‰10 | 
|---|---|---|---|---|---|
| name | "sushi-example"<br>."raw".<br>"demographics" | "sushi-example".<br>"raw".<br>"items" | "sushi-example".<br>"raw".<br>"marketing" | "sushi-example".<br>"raw".<br>"order_items" | "sushi-example".<br>"raw".<br>"orders" |
| identifier | 1112628036 | 4057945501 | 951266748 | 2963435990 | 4177358286 |
| version | 3906394976 | 3791312541 | 1833826140 | 490972095 | 3608433385 |
| snapshot | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON | é•·ã„JSON |
| kind_name | EXTERNAL | EXTERNAL | EXTERNAL | EXTERNAL | EXTERNAL |
| updated_ts | 1759890044799 | 1759890044799 | 1759890044799 | 1759890044799 | 1759890044799 |
| unpaused_ts | 1759889880000 | 1759889880000 | 1759889880000 | 1759889880000 | 1759889880000 |
| ttl_ms | 604800000 | 604800000 | 604800000 | 604800000 | 604800000 |
| unrestorable | false | false | false | false | false |
| forward_only | false | false | false | false | false |
| dev_version | 3906394976 | 3791312541 | 1833826140 | 490972095 | 3608433385 |
| fingerprint | JSON | JSON | JSON | JSON | JSON |


```json: ãƒ¬ã‚³ãƒ¼ãƒ‰1.snapshot
{
  "name": "\"sushi-example\".\"sushisimple\".\"customers\"",
  "dev_version": "417166203",
  "change_category": 1,
  "fingerprint": {
    "data_hash": "3649155621",
    "metadata_hash": "54374572",
    "parent_data_hash": "3540115527",
    "parent_metadata_hash": "36623728"
  },
  "previous_versions": [],
  "dev_table_suffix": "dev",
  "table_naming_convention": "schema_and_table",
  "node": {
    "name": "sushisimple.customers",
    "project": "",
    "description": "View of customer data.",
    "cron": "@daily",
    "tags": [],
    "dialect": "duckdb",
    "kind": {
      "name": "VIEW",
      "materialized": false
    },
    "partitioned_by": [],
    "clustered_by": [],
    "default_catalog": "sushi-example",
    "audits": [],
    "grains": [
      "customer_id"
    ],
    "references": [],
    "allow_partials": false,
    "signals": [],
    "enabled": true,
    "virtual_environment_mode": "full",
    "python_env": {},
    "jinja_macros": {
      "packages": {},
      "root_macros": {},
      "global_objs": {},
      "create_builtins_module": "sqlmesh.utils.jinja",
      "top_level_packages": []
    },
    "audit_definitions": {},
    "mapping_schema": {
      "\"sushi-example\"": {
        "\"raw\"": {
          "\"orders\"": {
            "id": "INT",
            "customer_id": "INT",
            "waiter_id": "INT",
            "start_ts": "INT",
            "end_ts": "INT",
            "ds": "TEXT"
          },
          "\"marketing\"": {
            "id": "INT",
            "customer_id": "INT",
            "status": "TEXT"
          },
          "\"demographics\"": {
            "id": "INT",
            "customer_id": "INT",
            "zip": "TEXT"
          }
        }
      }
    },
    "extract_dependencies_from_query": true,
    "pre_statements": [],
    "post_statements": [],
    "on_virtual_update": [],
    "query": {
      "sql": "SELECT DISTINCT\n  o.customer_id::INT AS customer_id,\n  COALESCE(m.status, 'UNKNOWN')::TEXT AS status,\n  d.zip::TEXT as zip\nFROM raw.orders AS o\nLEFT JOIN raw.marketing AS m\n    ON o.customer_id = m.customer_id\nLEFT JOIN raw.demographics AS d\n    ON o.customer_id = d.customer_id"
    },
    "source_type": "sql"
  },
  "parents": [
    {
      "name": "\"sushi-example\".\"raw\".\"demographics\"",
      "identifier": "1112628036"
    },
    {
      "name": "\"sushi-example\".\"raw\".\"orders\"",
      "identifier": "4177358286"
    },
    {
      "name": "\"sushi-example\".\"raw\".\"marketing\"",
      "identifier": "951266748"
    }
  ],
  "created_ts": 1759889917417,
  "ttl": "in 1 week",
  "version": "417166203",
  "migrated": false
}
```

`_environments.snapshot` ã¨é€”ä¸­ã¾ã§åŒã˜ã§ã™ãŒã€`node` ä»¥é™ã¯ç•°ãªã‚Šã¾ã™ã€‚ã“ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã¯ã€SQLæ–‡ã®ã‚³ãƒ¡ãƒ³ãƒˆã¾ã§å…¥ã£ã¦ã„ãŸã®ã§ã€å„ãƒ¢ãƒ‡ãƒ«ã®å®Œå…¨å†ç¾ãŒã§ãã‚‹æƒ…å ±ã¨è€ƒãˆã‚‰ã‚Œã¾ã™ã€‚

```json: ãƒ¬ã‚³ãƒ¼ãƒ‰1.fingerprint
{
  "data_hash": "3649155621",
  "metadata_hash": "54374572",
  "parent_data_hash": "3540115527",
  "parent_metadata_hash": "36623728"
}
```

ã“ã® `fingerprint` ã¯ã€ä¸Šã® `snapshot.fingerprint` ã¨ã¨ã‚‚ã€`_enviroments.snapshot.fingerprint` ã¨ã‚‚åŒã˜ã§ã™ã€‚

#### _versions
ã“ã‚Œã¯ã€SQLMesh è‡ªä½“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã¨æ€ã„ã¾ã™ã€‚
```
D select * from sqlmesh._versions;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ schema_version â”‚ sqlglot_version â”‚ sqlmesh_version â”‚
â”‚     int32      â”‚     varchar     â”‚     varchar     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       99       â”‚ 27.19.0         â”‚ 0.224.0         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ™‚é–“ã‚’é€²ã‚ã‚‹
ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã¯ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒä»˜ã„ã¦ã„ã‚‹ã®ã§ã€[sushi-overview.ipynb](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/sushi-overview.ipynb) ã«å¾“ã£ã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã€‚

### é€²ã‚ã‚‹å‰ã«
ä¸Šã®ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã‚ˆã†ã«ã€raw ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã¦ãŠãã¾ã™ã€‚

```
$ duckdb db/sushi-example.db 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D .maxrows 10
D SELECT * FROM raw.marketing;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚ customer_id â”‚  status  â”‚
â”‚ int32 â”‚    int32    â”‚ varchar  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     0 â”‚           0 â”‚ INACTIVE â”‚
â”‚     1 â”‚           1 â”‚ ACTIVE   â”‚
â”‚     2 â”‚           2 â”‚ ACTIVE   â”‚
â”‚     3 â”‚           3 â”‚ ACTIVE   â”‚
â”‚     4 â”‚           4 â”‚ ACTIVE   â”‚
â”‚     Â· â”‚           Â· â”‚   Â·      â”‚
â”‚     Â· â”‚           Â· â”‚   Â·      â”‚
â”‚     Â· â”‚           Â· â”‚   Â·      â”‚
â”‚    95 â”‚          95 â”‚ INACTIVE â”‚
â”‚    96 â”‚          96 â”‚ ACTIVE   â”‚
â”‚    97 â”‚          97 â”‚ ACTIVE   â”‚
â”‚    98 â”‚          98 â”‚ ACTIVE   â”‚
â”‚    99 â”‚          99 â”‚ ACTIVE   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 100 rows (10 shown)  3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D SELECT * FROM raw.demographics;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚ customer_id â”‚   zip   â”‚
â”‚ int32 â”‚    int32    â”‚ varchar â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     0 â”‚           0 â”‚ 10645   â”‚
â”‚     1 â”‚           1 â”‚ 10343   â”‚
â”‚     2 â”‚           2 â”‚ 10865   â”‚
â”‚     3 â”‚           3 â”‚ 10194   â”‚
â”‚     4 â”‚           4 â”‚ 10248   â”‚
â”‚     Â· â”‚           Â· â”‚   Â·     â”‚
â”‚     Â· â”‚           Â· â”‚   Â·     â”‚
â”‚     Â· â”‚           Â· â”‚   Â·     â”‚
â”‚    95 â”‚          95 â”‚ 10059   â”‚
â”‚    96 â”‚          96 â”‚ 10807   â”‚
â”‚    97 â”‚          97 â”‚ 10692   â”‚
â”‚    98 â”‚          98 â”‚ 10162   â”‚
â”‚    99 â”‚          99 â”‚ 10997   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      100 rows (10 shown)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D SELECT * FROM raw.items;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚   name    â”‚ price  â”‚     ds     â”‚
â”‚ int32 â”‚  varchar  â”‚ double â”‚    date    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     0 â”‚ Hotate    â”‚   7.59 â”‚ 2023-10-01 â”‚
â”‚     1 â”‚ Tsubugai  â”‚   6.33 â”‚ 2023-10-01 â”‚
â”‚     2 â”‚ Ahi       â”‚    9.0 â”‚ 2023-10-01 â”‚
â”‚     3 â”‚ Sake Toro â”‚   6.98 â”‚ 2023-10-01 â”‚
â”‚     4 â”‚ Ikura     â”‚   3.98 â”‚ 2023-10-01 â”‚
â”‚     Â· â”‚   Â·       â”‚     Â·  â”‚     Â·      â”‚
â”‚     Â· â”‚   Â·       â”‚     Â·  â”‚     Â·      â”‚
â”‚     Â· â”‚   Â·       â”‚     Â·  â”‚     Â·      â”‚
â”‚    21 â”‚ Maguro    â”‚   7.89 â”‚ 2023-10-05 â”‚
â”‚    22 â”‚ Katsuo    â”‚   8.64 â”‚ 2023-10-05 â”‚
â”‚    23 â”‚ Hotate    â”‚   9.75 â”‚ 2023-10-05 â”‚
â”‚    24 â”‚ Hamachi   â”‚   7.09 â”‚ 2023-10-05 â”‚
â”‚    25 â”‚ Iwashi    â”‚   6.46 â”‚ 2023-10-05 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 135 rows (10 shown)           4 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D SELECT * FROM raw.orders;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚ customer_id â”‚ waiter_id â”‚  start_ts  â”‚   end_ts   â”‚     ds     â”‚
â”‚ int32 â”‚    int32    â”‚   int32   â”‚   int32    â”‚   int32    â”‚    date    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     1 â”‚          30 â”‚         5 â”‚ 1696145535 â”‚ 1696145999 â”‚ 2023-10-01 â”‚
â”‚     2 â”‚          24 â”‚         3 â”‚ 1696120330 â”‚ 1696120878 â”‚ 2023-10-01 â”‚
â”‚     3 â”‚          53 â”‚         7 â”‚ 1696181564 â”‚ 1696181617 â”‚ 2023-10-01 â”‚
â”‚     4 â”‚          92 â”‚         5 â”‚ 1696128237 â”‚ 1696130039 â”‚ 2023-10-01 â”‚
â”‚     5 â”‚          47 â”‚         0 â”‚ 1696137970 â”‚ 1696139066 â”‚ 2023-10-01 â”‚
â”‚     Â· â”‚           Â· â”‚         Â· â”‚      Â·     â”‚      Â·     â”‚     Â·      â”‚
â”‚     Â· â”‚           Â· â”‚         Â· â”‚      Â·     â”‚      Â·     â”‚     Â·      â”‚
â”‚     Â· â”‚           Â· â”‚         Â· â”‚      Â·     â”‚      Â·     â”‚     Â·      â”‚
â”‚    22 â”‚          89 â”‚         8 â”‚ 1696487497 â”‚ 1696487828 â”‚ 2023-10-05 â”‚
â”‚    23 â”‚          82 â”‚         0 â”‚ 1696538377 â”‚ 1696540659 â”‚ 2023-10-05 â”‚
â”‚    24 â”‚          64 â”‚         2 â”‚ 1696483088 â”‚ 1696483726 â”‚ 2023-10-05 â”‚
â”‚    25 â”‚          44 â”‚         9 â”‚ 1696499488 â”‚ 1696500502 â”‚ 2023-10-05 â”‚
â”‚    26 â”‚          98 â”‚         5 â”‚ 1696531975 â”‚ 1696534401 â”‚ 2023-10-05 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 135 rows (10 shown)                                          6 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D SELECT * FROM raw.order_items;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  id   â”‚ order_id â”‚ item_id â”‚ quantity â”‚     ds     â”‚
â”‚ int32 â”‚  int32   â”‚  int32  â”‚  int32   â”‚    date    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚     1 â”‚        1 â”‚      15 â”‚        3 â”‚ 2023-10-01 â”‚
â”‚     2 â”‚        1 â”‚       0 â”‚        4 â”‚ 2023-10-01 â”‚
â”‚     3 â”‚        1 â”‚       6 â”‚        6 â”‚ 2023-10-01 â”‚
â”‚     4 â”‚        1 â”‚      22 â”‚        4 â”‚ 2023-10-01 â”‚
â”‚     5 â”‚        1 â”‚       8 â”‚        9 â”‚ 2023-10-01 â”‚
â”‚     Â· â”‚        Â· â”‚       Â· â”‚        Â· â”‚     Â·      â”‚
â”‚     Â· â”‚        Â· â”‚       Â· â”‚        Â· â”‚     Â·      â”‚
â”‚     Â· â”‚        Â· â”‚       Â· â”‚        Â· â”‚     Â·      â”‚
â”‚    71 â”‚       25 â”‚       4 â”‚        5 â”‚ 2023-10-05 â”‚
â”‚    72 â”‚       25 â”‚       2 â”‚        5 â”‚ 2023-10-05 â”‚
â”‚    73 â”‚       25 â”‚      11 â”‚        8 â”‚ 2023-10-05 â”‚
â”‚    74 â”‚       26 â”‚      12 â”‚        2 â”‚ 2023-10-05 â”‚
â”‚    75 â”‚       26 â”‚      23 â”‚        5 â”‚ 2023-10-05 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 350 rows (10 shown)                      5 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D SELECT MAX(ds) as last_date FROM raw.orders;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ last_date  â”‚
â”‚    date    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2023-10-05 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .q
```

### é€²ã‚ã‚‹
ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã«æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚Šã€åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯ 2023/10/5 ã¾ã§ãªã®ã§ã€ãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã®ã¨ãŠã‚Šã€2023/10/6 ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã™ã€‚

```
$ uv run addsushidata.py --start 2023-10-06 --end 2023-10-06
$ duckdb db/sushi-example.db 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D SELECT MAX(ds) as last_date FROM raw.orders;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ last_date  â”‚
â”‚    date    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2023-10-06 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .q
```

### å‹•ã‹ã™
```
$ uv run sqlmesh run
No models are ready to run. Please wait until a model `cron` interval has elapsed.

Next run will be ready at 2025-10-09 12:00AM UTC.
```
ã¨ã„ã†ã“ã¨ã§ã€æ˜æ—¥ã«ã—ã¾ã™ğŸ˜…

ç¿Œæ—¥

```
$ uv run sqlmesh run
[1/1] sushisimple.customer_revenue_by_day   [recreate view]                            0.05s   
[1/1] sushisimple.customers                 [recreate view]                            0.03s   
[1/1] sushisimple.waiter_revenue_by_day     [recreate view]                            0.04s   
[1/1] sushisimple.top_waiters               [recreate view]                            0.03s   
Executing model batches â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” 100.0% â€¢ 4/4 â€¢ 0:00:00                                                                                    
                                                                                                                                                                           
âœ” Model batches executed

Run finished for environment 'prod'

```

 `cron '@daily'` ã®ã‚ˆã†ãªå„ãƒ¢ãƒ‡ãƒ«ã®ã‚µã‚¤ã‚¯ãƒ«ã®æŒ‡å®šã¨å®Ÿéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã™ã‚‹ã“ã¨ã§å®šæœŸçš„ãªå®Ÿè¡ŒãŒã§ããã†ã§ã™ã€‚

ä¸€å¿œã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚‚è¦‹ã¦ãŠãã¾ã™ã€‚ã„ãã¤ã‹ 10/6 ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚

```
$ duckdb db/sushi-example.db 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D .maxrows 10
D select * from sushisimple.customer_revenue_by_day;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id â”‚      revenue       â”‚     ds     â”‚
â”‚    int32    â”‚       double       â”‚  varchar   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           1 â”‚               57.1 â”‚ 2023-10-04 â”‚
â”‚           1 â”‚              57.93 â”‚ 2023-10-06 â”‚
â”‚           3 â”‚ 47.459999999999994 â”‚ 2023-10-05 â”‚
â”‚           4 â”‚              18.76 â”‚ 2023-10-03 â”‚
â”‚           5 â”‚             108.59 â”‚ 2023-10-05 â”‚
â”‚           Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚           Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚           Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚          97 â”‚              179.4 â”‚ 2023-10-06 â”‚
â”‚          98 â”‚             115.53 â”‚ 2023-10-04 â”‚
â”‚          98 â”‚              62.43 â”‚ 2023-10-05 â”‚
â”‚          98 â”‚             100.96 â”‚ 2023-10-06 â”‚
â”‚          99 â”‚              19.44 â”‚ 2023-10-04 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 142 rows (10 shown)                 3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select * from sushisimple.customers;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ customer_id â”‚  status  â”‚   zip   â”‚
â”‚    int32    â”‚ varchar  â”‚ varchar â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           1 â”‚ ACTIVE   â”‚ 10343   â”‚
â”‚           3 â”‚ ACTIVE   â”‚ 10194   â”‚
â”‚           5 â”‚ ACTIVE   â”‚ 10016   â”‚
â”‚          11 â”‚ ACTIVE   â”‚ 10380   â”‚
â”‚          16 â”‚ INACTIVE â”‚ 10835   â”‚
â”‚           Â· â”‚   Â·      â”‚   Â·     â”‚
â”‚           Â· â”‚   Â·      â”‚   Â·     â”‚
â”‚           Â· â”‚   Â·      â”‚   Â·     â”‚
â”‚          96 â”‚ ACTIVE   â”‚ 10807   â”‚
â”‚          98 â”‚ ACTIVE   â”‚ 10162   â”‚
â”‚          99 â”‚ ACTIVE   â”‚ 10997   â”‚
â”‚          29 â”‚ INACTIVE â”‚ 10958   â”‚
â”‚          59 â”‚ ACTIVE   â”‚ 10695   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 87 rows (10 shown)     3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select * from sushisimple.waiter_revenue_by_day;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ waiter_id â”‚      revenue       â”‚     ds     â”‚
â”‚   int32   â”‚       double       â”‚  varchar   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         0 â”‚             132.27 â”‚ 2023-10-01 â”‚
â”‚         0 â”‚              60.05 â”‚ 2023-10-03 â”‚
â”‚         0 â”‚             290.16 â”‚ 2023-10-04 â”‚
â”‚         0 â”‚  408.7900000000001 â”‚ 2023-10-05 â”‚
â”‚         0 â”‚              35.68 â”‚ 2023-10-06 â”‚
â”‚         Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚         Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚         Â· â”‚                Â·   â”‚     Â·      â”‚
â”‚         9 â”‚              32.24 â”‚ 2023-10-02 â”‚
â”‚         9 â”‚             357.92 â”‚ 2023-10-03 â”‚
â”‚         9 â”‚               41.4 â”‚ 2023-10-04 â”‚
â”‚         9 â”‚             321.75 â”‚ 2023-10-05 â”‚
â”‚         9 â”‚ 324.96999999999997 â”‚ 2023-10-06 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 56 rows (10 shown)                3 columns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D select * from sushisimple.top_waiters;
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ waiter_id â”‚ waiter_name â”‚      revenue       â”‚
â”‚   int32   â”‚   varchar   â”‚       double       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         6 â”‚ Vincent     â”‚  552.6300000000001 â”‚
â”‚         9 â”‚ Maia        â”‚ 324.96999999999997 â”‚
â”‚         5 â”‚ Max         â”‚             242.94 â”‚
â”‚         4 â”‚ Chris       â”‚             228.86 â”‚
â”‚         7 â”‚ Iaroslav    â”‚ 199.85999999999999 â”‚
â”‚         3 â”‚ George      â”‚ 183.32000000000002 â”‚
â”‚         8 â”‚ Emma        â”‚              162.7 â”‚
â”‚         2 â”‚ Ryan        â”‚  75.14999999999999 â”‚
â”‚         0 â”‚ Toby        â”‚              35.68 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
D .q
```

`revenue` ãŒ `double` ã§ç«¯æ•°ãŒã§ã¦ã„ã‚‹ã®ã§ã€Œã ã‹ã‚‰é‡‘é¡ã‚’æµ®å‹•å°æ•°ç‚¹æ•°ã§è¡¨ç¾ã™ã‚‹ãªã¨è¨€ã£ãŸã ã‚ã€ã¨åå¿œã—ãŸæ–¹ã¯ã€Œè·æ¥­ç—…ã€ã§ã™ã€‚æ°—ã‚’ä»˜ã‘ã¾ã—ã‚‡ã†ã€‚ã‚»ãƒ³ãƒˆã®ã‚ã‚‹å›½ã®ã‚µãƒ³ãƒ—ãƒ«ãªã®ã§å¤šã‚ã«è¦‹ã¦ã‚ã’ã¾ã—ã‚‡ã†ã€‚

# ã‚„ã£ã¦ã¿ãŸï¼ˆ001_shushi/2_moderateï¼‰
ä½œè€…ã®æ„å›³ã¨ã¯é•ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€`1_simple` ã‹ã‚‰ `2_moderate` ã¸å¤‰æ›´ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
`2_moderate` ã®ãƒ¢ãƒ‡ãƒ«ã¯ `sushimoderate` ã‚¹ã‚­ãƒ¼ãƒã«ãªã£ã¦ã„ã¾ã™ãŒã€ã“ã®ã‚¹ã‚­ãƒ¼ãƒåã®ã¿ `sushisimple` ã®ã¾ã¾ã€ä¸Šæ›¸ãã™ã‚‹å½¢ã§ã€ã‚ˆã‚Šå®Ÿè·µçš„ã«ãªã‚‹ã‚ˆã†ã«ãƒ¢ãƒ‡ãƒ«ã‚’æ›´æ–°ã—ã¦åæ˜ ã—ã¦ã¿ã¾ã™ã€‚
ä»¥ä¸‹ã€ã‚¹ã‚­ãƒ¼ãƒåã®å¤‰æ›´ã«ã¤ã„ã¦ã¯èª¬æ˜ã‚’ç¹°ã‚Šè¿”ã—ã¾ã›ã‚“ã€‚

## ãƒ¢ãƒ‡ãƒ«ã®æ›´æ–°
### models/customer_revenue_by_day.sql
ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff sql: models/customer_revenue_by_day.sql
diff --git a/001_sushi/1_simple/models/customer_revenue_by_day.sql b/001_sushi/1_simple/models/customer_revenue_by_day.sql
index b77027e..26a2f3e 100644
--- a/001_sushi/1_simple/models/customer_revenue_by_day.sql
+++ b/001_sushi/1_simple/models/customer_revenue_by_day.sql
@@ -1,9 +1,14 @@
--- View of revenue from customers by day.
+/*
+  Incremental table of revenue from customers by day.
+*/
 MODEL (
   name sushisimple.customer_revenue_by_day,
-  kind VIEW,
-  cron '@daily',
-  grain (customer_id, ds),
+  kind INCREMENTAL_BY_TIME_RANGE (
+    time_column (ds, 'YYYY-MM-dd'),
+  ),
+  start "2023-01-01",
+  cron "@daily",
+  grains [customer_id, ds],
 );
 
 WITH order_total AS (
@@ -11,20 +16,24 @@ WITH order_total AS (
     oi.order_id AS order_id,
     SUM(oi.quantity * i.price) AS total,
     oi.ds AS ds
-  FROM raw.order_items AS oi
-  LEFT JOIN raw.items AS i
+  FROM sushisimple.order_items AS oi
+  LEFT JOIN sushisimple.items AS i
     ON oi.item_id = i.id AND oi.ds = i.ds
+  WHERE
+    oi.ds BETWEEN @start_ds AND @end_ds
   GROUP BY
     oi.order_id,
     oi.ds
 )
 SELECT
-  o.customer_id::INT AS customer_id, /* Customer id */
+  o.customer_id::INT AS customer_id, /* Customer ID */
   SUM(ot.total)::DOUBLE AS revenue, /* Revenue from orders made by this customer */
   o.ds::TEXT AS ds /* Date */
-FROM raw.orders AS o
+FROM sushisimple.orders AS o
 LEFT JOIN order_total AS ot
   ON o.id = ot.order_id AND o.ds = ot.ds
+WHERE
+  o.ds BETWEEN @start_ds AND @end_ds
 GROUP BY
   o.customer_id,
-  o.ds
+  o.ds;
```

### models/customer_revenue_lifetime.sql
[models/customer_revenue_lifetime.sql](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/2_moderate/models/customer_revenue_lifetime.sql) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦è¿½åŠ ã—ã¾ã™ã€‚

### models/customers.sql
ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff sql: models/customers.sql
diff --git a/001_sushi/1_simple/models/customers.sql b/001_sushi/1_simple/models/customers.sql
index bc3d4eb..cb07343 100644
--- a/001_sushi/1_simple/models/customers.sql
+++ b/001_sushi/1_simple/models/customers.sql
@@ -1,17 +1,23 @@
--- View of customer data.
+/*
+  Table of customer data for customers who have ever placed an order.
+*/
 MODEL (
   name sushisimple.customers,
-  kind VIEW,
+  kind FULL,
   cron '@daily',
   grain customer_id,
+  audits (
+        not_null(columns=[customer_id]),
+        unique_values(columns=[customer_id])
+    ),
 );
 
 SELECT DISTINCT
-  o.customer_id::INT AS customer_id,
-  COALESCE(m.status, 'UNKNOWN')::TEXT AS status,
-  d.zip::TEXT as zip
-FROM raw.orders AS o
+  o.customer_id::INT AS customer_id, /* Customer ID */
+  COALESCE(m.status, 'UNKNOWN')::TEXT AS status, /* Customer marketing status */
+  d.zip::TEXT as zip /* Customer ZIP code */
+FROM sushisimple.orders AS o
 LEFT JOIN raw.marketing AS m
     ON o.customer_id = m.customer_id
 LEFT JOIN raw.demographics AS d
-    ON o.customer_id = d.customer_id
+    ON o.customer_id = d.customer_id;
```

### models/items.sql
[models/items.sql](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/2_moderate/models/items.sql) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦è¿½åŠ ã—ã¾ã™ã€‚

### models/order_items.sql
[models/order_items.sql](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/2_moderate/models/order_items.sql) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦è¿½åŠ ã—ã¾ã™ã€‚

### models/order.sql
[models/order.sql](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/2_moderate/models/orders.sql) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦è¿½åŠ ã—ã¾ã™ã€‚

### models/top_waiters.sql
ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff sql: models/top_waiters.sql
diff --git a/001_sushi/1_simple/models/top_waiters.sql b/001_sushi/1_simple/models/top_waiters.sql
index 31c8509..fbdfacb 100644
--- a/001_sushi/1_simple/models/top_waiters.sql
+++ b/001_sushi/1_simple/models/top_waiters.sql
@@ -1,15 +1,20 @@
--- View of 10 waiters with highest revenue on most recent day of data.
+/*
+  View of 10 waiters with highest revenue on most recent day of data.
+*/
 MODEL (
   name sushisimple.top_waiters,
   kind VIEW,
   cron '@daily',
-  grain waiter_id
+  grain waiter_id,
+  audits (
+    unique_values(columns=[waiter_id])
+  ),
 );
 
 SELECT
-  waiter_id::INT AS waiter_id,
-  name::TEXT AS waiter_name,
-  revenue::DOUBLE AS revenue
+  waiter_id::INT AS waiter_id, /* Waiter ID */
+  name::TEXT AS waiter_name, /* Waiter name */
+  revenue::DOUBLE AS revenue /* Waiter revenue on most recent day of data */
 FROM sushisimple.waiter_revenue_by_day as r
 LEFT JOIN sushisimple.waiter_names AS n
   ON r.waiter_id = n.id
@@ -21,4 +26,4 @@ WHERE
   )
 ORDER BY
   revenue DESC
-LIMIT 10
+LIMIT 10;
```
### models/waiter_names.sql
ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff sql: models/waiter_names.sql
diff --git a/001_sushi/1_simple/models/waiter_names.sql b/001_sushi/1_simple/models/waiter_names.sql
index 341201f..570f908 100644
--- a/001_sushi/1_simple/models/waiter_names.sql
+++ b/001_sushi/1_simple/models/waiter_names.sql
@@ -1,4 +1,6 @@
--- Seed data containing water names.
+/*
+  Seed data containing water names.
+*/
 MODEL (
   name sushisimple.waiter_names,
   kind SEED (
@@ -8,5 +10,5 @@ MODEL (
     id INT,
     name TEXT
   ),
-  grain id
-)
+  grain "id as waiter_id"
+);
```

### models/waiter_revenue_by_day.sql
ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff sql: models/waiter_revenue_by_day.sql
diff --git a/001_sushi/1_simple/models/waiter_revenue_by_day.sql b/001_sushi/1_simple/models/waiter_revenue_by_day.sql
index 19ddd2c..0d958a4 100644
--- a/001_sushi/1_simple/models/waiter_revenue_by_day.sql
+++ b/001_sushi/1_simple/models/waiter_revenue_by_day.sql
@@ -1,20 +1,30 @@
--- View of revenue generated by each waiter by day.
+/*
+  Incremental table of revenue generated by each waiter by day.
+*/
 MODEL (
   name sushisimple.waiter_revenue_by_day,
-  kind VIEW,
+  kind INCREMENTAL_BY_TIME_RANGE (
+    time_column (ds, '%Y-%m-%d'),
+  ),
   cron '@daily',
-  grain (waiter_id, ds)
+  start '2023-01-01',
+  grains [waiter_id, ds],
+  audits (
+    NUMBER_OF_ROWS(threshold=0)
+  ),
 );
 
 SELECT
-  o.waiter_id::INT AS waiter_id, -- Waiter id
-  SUM(oi.quantity * i.price)::DOUBLE AS revenue, -- Revenue from orders taken by this waiter
-  o.ds::TEXT AS ds -- Order date
-FROM raw.orders AS o
-LEFT JOIN raw.order_items AS oi
+  o.waiter_id::INT AS waiter_id, /* Waiter id */
+  SUM(oi.quantity * i.price)::DOUBLE AS revenue, /* Revenue from orders taken by waiter on day */
+  o.ds::TEXT AS ds /* Order date */
+FROM sushisimple.orders AS o
+LEFT JOIN sushisimple.order_items AS oi
   ON o.id = oi.order_id AND o.ds = oi.ds
-LEFT JOIN raw.items AS i
+LEFT JOIN sushisimple.items AS i
   ON oi.item_id = i.id AND oi.ds = i.ds
+WHERE
+  o.ds BETWEEN @start_ds AND @end_ds
 GROUP BY
   o.waiter_id,
-  o.ds
+  o.ds;
```

### ERD ã¨å¤‰æ›´ã®ã¾ã¨ã‚
```mermaid
erDiagram
    "raw.orders" ||--|{ "raw.order_items" : "æ§‹æˆã™ã‚‹"
    "raw.order_items" }o--|| "raw.items" : "æ³¨æ–‡å¯¾è±¡å•†å“"
    "raw.marketing" {
    }
    "raw.demographics" {
    }
    "raw.orders"{
    }
    "raw.order_items" {
    }
    "raw.items" {
    }
    waiter_name {
        id INT
        name TEXT
    }
    customers ||--|{ orders : "æ³¨æ–‡ã™ã‚‹"
    customers ||--|| "raw.demographics" : "å±æ€§"
    customers ||--o| "raw.marketing" : "å±æ€§"
    customers {
        customer_id INT
        status TEXT
        zip TEXT
    }
    items ||--|| "raw.items" : "æ—¥ã€…ã‚³ãƒ”ãƒ¼ã™ã‚‹"
    items {
      id INT
      name TEXT
      price DOUBLE
      ds TEXT
    }
    orders ||--|| "raw.orders" : "æ—¥ã€…ã‚³ãƒ”ãƒ¼ã™ã‚‹"
    orders ||--|{ order_items : "æ§‹æˆã™ã‚‹"
    orders {
      id INT
      customer_id INT
      waiter_id INT
      start_ts INT
      end_ts INT
      ds TEXT
    }
    order_items ||--|| "raw.order_items" : "æ—¥ã€…ã‚³ãƒ”ãƒ¼ã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    order_items {
      id INT
      order_id INT
      item_id INT
      quantity INT
      ds TEXT
    }
    customer_revenue_by_day |o--|| customers : "å¯¾è±¡é¡§å®¢"
    customer_revenue_by_day ||--|{ orders: "é›†è¨ˆå¯¾è±¡"
    customer_revenue_by_day {
        customer_id INT
        revenue DOUBLE
        ds TEXT
    }
    customer_revenue_lifetime |o--|| customers : "å¯¾è±¡é¡§å®¢"
    customer_revenue_lifetime ||--|{ orders: "é›†è¨ˆå¯¾è±¡"
    customer_revenue_lifetime {
        customer_id INT
        revenue DOUBLE
        ds TEXT
    }
    waiter_revenue_by_day |o--|| waiter_name : "å¯¾è±¡ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼"
    waiter_revenue_by_day ||--|{ orders: "é›†è¨ˆå¯¾è±¡"
    waiter_revenue_by_day {
        waiter_id INT
        revenue DOUBLE
        ds TEXT
    }
    top_waiters |o--|| waiter_name : "å¯¾è±¡ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼"
    top_waiters |o--|| waiter_revenue_by_day : "æŠ½å‡ºå…ƒ"
    top_waiters {
        waiter_id INT
        waiter_name TEXT
        revenue DOUBLE
    }
```


## ãƒ†ã‚¹ãƒˆã®è¿½åŠ 
- [`tests/test_customer_revenue_by_day.yaml`](https://github.com/TobikoData/sqlmesh-examples/blob/main/001_sushi/2_moderate/tests/test_customer_revenue_by_day.yaml) ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦æ–°è¦è¿½åŠ ã—ã¾ã™ã€‚

# ãŠã‚ã‚Šã«


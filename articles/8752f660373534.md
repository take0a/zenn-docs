---
title: "SQLMeshでSushi"
emoji: "🕸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["sqlmesh", "dbt", "python", "duckdb", "uv"]
published: false
publication_name: "robon"
---

# はじめに
少し前の「[SQLMesh入門](https://zenn.dev/robon/articles/c8928f88f62218)」の「おわりに」でこんなことを書きました。
> 公式サイトを含めて、サンプルやトレーニング用の教材が少なく、作者の意図がわかりにくいように思います。

いろいろ探した結果、公式のリポジトリの「これ↓」が、いいんじゃないかな？ということで紹介してみます。

https://github.com/TobikoData/sqlmesh-examples

# やってみた
## 背景
まず、このサンプルの背景ですが、寿司レストランのデータを分析するというユースケースです。
業務システムから以下の５つのテーブルが「raw」スキーマにロードされているところからスタートします。

```mermaid
erDiagram
    marketing |o--o| demographics : "同一顧客"
    demographics ||--o{ order : "注文する"
    order ||--|{ order_items : "構成する"
    order_items }o--|| items : "注文対象商品"
    marketing {
        id INT "一意のID"
        customer_id INT "顧客ID"
        status TEXT "顧客のアクティビティ・ステータス"
    }
    demographics {
        id INT "一意のID"
        customer_id INT "顧客ID"
        zip TEXT "顧客の郵便番号"
    }
    order {
        id INT "固有のID"
        customer_id INT "顧客ID"
        waiter_id INT "ウェイターID"
        start_ts INT "注文開始時刻"
        end_ts INT "注文終了時刻"
        ds TEXT "日付"
    }
    order_items {
        id INT "固有ID"
        order_id INT "注文ID"
        item_id INT "商品ID"
        quantity INT "商品数量"
        ds TEXT "日付"
    }
    items {
        id INT "固有ID"
        name TEXT "商品名"
        price DOUBLE "商品価格"
        ds TEXT "日付"
    }
```

顧客は２つに分かれてますけど、来店したら status が ACTIVE になったり、引っ越したら zip が変わったりするので管理しているシステムが違うのかもしれません。
order と order_item は、トランザクションなので、日々追加されていきます。
お寿司のネタなので、items は、時価ということで、これも日々追加されていくというシナリオなのでしょう。

## モデル
### waiter_names
order.waiter_id ですが、こちらは SEED のサンプルになってます。

```sql: models/waiter_names.sql
-- Seed data containing water names.
MODEL (
  name sushisimple.waiter_names,
  kind SEED (
    path '../seeds/waiter_names.csv'
  ),
  columns (
    id INT,
    name TEXT
  ),
  grain id
)
```
```csv: seeds/waiter_names.csv
id,name
0,Toby
1,Tyson
2,Ryan
3,George
4,Chris
5,Max
6,Vincent
7,Iaroslav
8,Emma
9,Maia
```



# おわりに


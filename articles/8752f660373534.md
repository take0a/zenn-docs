---
title: "SQLMeshã§Sushi"
emoji: "ğŸ•¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["sqlmesh", "dbt", "python", "duckdb", "uv"]
published: false
publication_name: "robon"
---

# ã¯ã˜ã‚ã«
å°‘ã—å‰ã®ã€Œ[SQLMeshå…¥é–€](https://zenn.dev/robon/articles/c8928f88f62218)ã€ã®ã€ŒãŠã‚ã‚Šã«ã€ã§ã“ã‚“ãªã“ã¨ã‚’æ›¸ãã¾ã—ãŸã€‚
> å…¬å¼ã‚µã‚¤ãƒˆã‚’å«ã‚ã¦ã€ã‚µãƒ³ãƒ—ãƒ«ã‚„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç”¨ã®æ•™æãŒå°‘ãªãã€ä½œè€…ã®æ„å›³ãŒã‚ã‹ã‚Šã«ãã„ã‚ˆã†ã«æ€ã„ã¾ã™ã€‚

ã„ã‚ã„ã‚æ¢ã—ãŸçµæœã€å…¬å¼ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã€Œã“ã‚Œâ†“ã€ãŒã€ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ãªï¼Ÿã¨ã„ã†ã“ã¨ã§ç´¹ä»‹ã—ã¦ã¿ã¾ã™ã€‚

https://github.com/TobikoData/sqlmesh-examples

# ã‚„ã£ã¦ã¿ãŸ
ã¾ãšã€ã“ã®ã‚µãƒ³ãƒ—ãƒ«ã®èƒŒæ™¯ã§ã™ãŒã€å¯¿å¸ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã™ã‚‹ã¨ã„ã†ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã™ã€‚Tobiko ç¤¾ã®åå‰ã¯å¯¿å¸ãƒã‚¿ã®ãƒˆãƒ“ã‚³ã¨ã®ã“ã¨ã§ã™ã€‚

## å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«
æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ä»¥ä¸‹ã®ï¼•ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã€Œrawã€ã‚¹ã‚­ãƒ¼ãƒã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã¨ã“ã‚ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã™ã€‚

```mermaid
erDiagram
    marketing |o--o| demographics : "åŒä¸€é¡§å®¢"
    demographics ||--o{ order : "æ³¨æ–‡ã™ã‚‹"
    order ||--|{ order_items : "æ§‹æˆã™ã‚‹"
    order_items }o--|| items : "æ³¨æ–‡å¯¾è±¡å•†å“"
    marketing {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        status TEXT "é¡§å®¢ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
    }
    demographics {
        id INT "ä¸€æ„ã®ID"
        customer_id INT "é¡§å®¢ID"
        zip TEXT "é¡§å®¢ã®éƒµä¾¿ç•ªå·"
    }
    order {
        id INT "å›ºæœ‰ã®ID"
        customer_id INT "é¡§å®¢ID"
        waiter_id INT "ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ID"
        start_ts INT "æ³¨æ–‡é–‹å§‹æ™‚åˆ»"
        end_ts INT "æ³¨æ–‡çµ‚äº†æ™‚åˆ»"
        ds TEXT "æ—¥ä»˜"
    }
    order_items {
        id INT "å›ºæœ‰ID"
        order_id INT "æ³¨æ–‡ID"
        item_id INT "å•†å“ID"
        quantity INT "å•†å“æ•°é‡"
        ds TEXT "æ—¥ä»˜"
    }
    items {
        id INT "å›ºæœ‰ID"
        name TEXT "å•†å“å"
        price DOUBLE "å•†å“ä¾¡æ ¼"
        ds TEXT "æ—¥ä»˜"
    }
```

é¡§å®¢ã¯ï¼’ã¤ã«åˆ†ã‹ã‚Œã¦ã¾ã™ã‘ã©ã€æ¥åº—ã—ãŸã‚‰ status ãŒ ACTIVE ã«ãªã£ãŸã‚Šã€å¼•ã£è¶Šã—ãŸã‚‰ zip ãŒå¤‰ã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ç®¡ç†ã—ã¦ã„ã‚‹ã‚·ã‚¹ãƒ†ãƒ ãŒé•ã†ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚
order ã¨ order_item ã¯ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã®ã§ã€æ—¥ã€…è¿½åŠ ã•ã‚Œã¦ã„ãã¾ã™ã€‚
ãŠå¯¿å¸ã®ãƒã‚¿ãªã®ã§ã€items ã¯ã€æ™‚ä¾¡ã¨ã„ã†ã“ã¨ã§ã€ã“ã‚Œã‚‚æ—¥ã€…è¿½åŠ ã•ã‚Œã¦ã„ãã¨ã„ã†ã‚·ãƒŠãƒªã‚ªãªã®ã§ã—ã‚‡ã†ã€‚

ã“ã‚Œã‚‰ã¯å¤–éƒ¨ãƒ¢ãƒ‡ãƒ«ãªã®ã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«åã€ã‚«ãƒ©ãƒ åã€ãƒ‡ãƒ¼ã‚¿å‹ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

```yaml: external_models.yaml
- name: raw.demographics
  columns:
    id: INT
    customer_id: INT
    zip: TEXT
- name: raw.items
  columns:
    id: INT
    name: TEXT
    price: DOUBLE
    ds: TEXT
- name: raw.marketing
  columns:
    id: INT
    customer_id: INT
    status: TEXT
- name: raw.order_items
  columns:
    id: INT
    order_id: INT
    item_id: INT
    quantity: INT
    ds: TEXT
- name: raw.orders
  columns:
    id: INT
    customer_id: INT
    waiter_id: INT
    start_ts: INT
    end_ts: INT
    ds: TEXT
```

## ãƒ¢ãƒ‡ãƒ«
### waiter_names
order.waiter_id ã§ã™ãŒã€ã“ã¡ã‚‰ã¯ SEED ã®ã‚µãƒ³ãƒ—ãƒ«ã«ãªã£ã¦ã¾ã™ã€‚

```sql: models/waiter_names.sql
-- Seed data containing water names.
MODEL (
  name sushisimple.waiter_names,
  kind SEED (
    path '../seeds/waiter_names.csv'
  ),
  columns (
    id INT,
    name TEXT
  ),
  grain id
)
```
```csv: seeds/waiter_names.csv
id,name
0,Toby
1,Tyson
2,Ryan
3,George
4,Chris
5,Max
6,Vincent
7,Iaroslav
8,Emma
9,Maia
```




# ãŠã‚ã‚Šã«


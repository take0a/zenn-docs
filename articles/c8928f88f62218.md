---
title: "SQLMesh入門"
emoji: "🕸"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["sqlmesh", "dbt", "python", "duckdb", "postgresql"]
published: false
publication_name: "robon"
---

# はじめに
> 周回遅れではありますが、モダンデータスタックを始めたいと思います。
モダンデータスタックの中でも、ELT の T の部分は dbt 一択のようなので、dbt 入門してみます。

ということで、4月に「[dbt入門](https://zenn.dev/robon/articles/f1bd403b3a3d95)」という記事を書きました。

そして、5/29 の dbt-fusion の発表を聞いて、Rust で書き直すみたいだから、外部仕様からにしようと「[dbt Artifactsから見たdbt](https://zenn.dev/robon/articles/0bfe8aed582698)」という記事も書きながら、dbt-fusion を待っていました。
もう、4ヶ月になるから、そろそろ [dbt-fusion のソースコード](https://github.com/dbt-labs/dbt-fusion) でも読んでみるかと、（Rust を一夜漬けで勉強して）読んでみましたが…。（本当は、その Rust の勉強も dbt-fusion のソースコード解析でも記事を書こうと思っていたのですが）

https://github.com/dbt-labs/dbt-fusion/blob/main/crates/dbt-sa-cli/src/dbt_sa_clap.rs#L68-L90

あれれれ、`build` とか `run` とか無いの？
とはいえ、冒頭でも書いたように「T の部分は dbt 一択」なので、（記事）どうしようかなと（心が）フラフラしていたところ、見つけちゃいました。

https://www.tobikodata.com/sqlmesh

> [It is more than just a dbt alternative.](https://sqlmesh.readthedocs.io/en/stable/)

やるしかない。

# 用語と概念
dbt との違いについては、（よく知らないのに勝手なことを書くと信者のみなさまに叱られるので）公式の [FAQ](https://sqlmesh.readthedocs.io/en/stable/faq/faq/#how-is-this-different-from-dbt) などを見てもらえればと思います。

## プロジェクト（リポジトリ？）
プロジェクトについては、[Concepts](https://sqlmesh.readthedocs.io/en/stable/concepts/overview/) にないので、わかりにくかったのですが、[Guide](https://sqlmesh.readthedocs.io/en/stable/guides/projects/) は、あります。
要するに、`sqlmesh init` で作られるような SQLMesh 用の資材を置く単位のようです。`config.yaml` または `config.py` の単位と考える方が良いのかもしれません。そう考えると、この構成ファイルで定義される構成の範囲がプロジェクトと言えるかもしれません。

1. [プロジェクト](https://sqlmesh.readthedocs.io/en/stable/reference/configuration/#projects) - SQLMesh プロジェクト ディレクトリの構成オプション。
1. [環境](https://sqlmesh.readthedocs.io/en/stable/reference/configuration/#environments) - SQLMesh 環境の作成/昇格、物理テーブル スキーマ、およびビュー スキーマの構成オプション。
1. [ゲートウェイ](https://sqlmesh.readthedocs.io/en/stable/reference/configuration/#gateways) - SQLMesh がデータ ウェアハウス、状態バックエンド、およびスケジューラに接続する方法の構成オプション。
1. [ゲートウェイ/接続のデフォルト](https://sqlmesh.readthedocs.io/en/stable/reference/configuration/#gatewayconnection-defaults) - ゲートウェイまたは接続がすべて明示的に指定されていない場合の動作に関する構成オプション。
1. [モデルのデフォルト](https://sqlmesh.readthedocs.io/en/stable/reference/model_configuration/) - モデル固有の構成がモデルのファイルで明示的に指定されていない場合の動作に関する構成オプション。
1. [デバッグモード](https://sqlmesh.readthedocs.io/en/stable/reference/configuration/#debug-mode) - SQLMesh がアクションと完全なバックトレースを出力およびログに記録するための構成オプション。

リポジトリ？と書いたのは、[Multi-Repo guide](https://sqlmesh.readthedocs.io/en/stable/guides/multi_repo/)では、`-p` 指定する `プロジェクト` を `リポジトリ` と呼んでいるので、そういう用語の使われ方をしている場合もあるかも？という感じです。

## プラン
> プランとは、プロジェクトのローカル状態とターゲットの環境の状態の差異をまとめた変更セットです。モデルの変更をターゲット環境に反映させるには、プランを作成して適用する必要があります。

ということなので、SQLMesh で作成・変更した定義をデータウェアハウスに反映させるには、`sqlmesh plan` をすることになります。

## 環境
> 環境は、変更内容をテストおよびプレビューできる独立した名前空間です。

環境が変われば、名前空間が変わるので、同じ名前のまま、本番環境と開発環境が作れるということになります。

また、`sqlmesh plan` は、本番環境 `prod` 以外の環境では、コマンド引数で環境名を指定しますが、上記の[プラン](#プラン)の定義から、対象となるローカルのプロジェクトの[状態](#状態)を対象の環境が指す[状態](#状態)とデータウェアハウスに反映させるという関係になります。

## 状態
> SQLMesh は、プロジェクトに関する情報を状態データベースに保存します。このデータベースは通常、メインのウェアハウスとは別のものです。

SQLMesh 状態データベースには、以下の情報が含まれる[そう](https://sqlmesh.readthedocs.io/en/stable/concepts/state/)です。

- プロジェクト内のすべての モデルバージョン に関する情報 (クエリ、読み込み間隔、依存関係)
- プロジェクト内のすべての 仮想データ環境 のリスト
- 各 仮想データ環境 に 昇格 されているモデルバージョン
- プロジェクト内に存在する 自動再ステートメント に関する情報
- 現在の SQLMesh / SQLGlot バージョンなど、プロジェクトに関するその他のメタデータ

ここで、モデルではなく、モデルバージョンと言っているのは、[スナップショット](#スナップショット)だからだと思います。

## モデル
> モデルは、テーブルとビューを作成するメタデータとクエリで構成され、他のモデルやSQLMeshの外部でも使用できます。モデルはSQLMeshプロジェクトのmodels/ディレクトリに定義され、.sqlファイルに格納されます。

モデルには、以下の種類がある[よう](https://sqlmesh.readthedocs.io/en/stable/concepts/models/model_kinds/)です。

- INCREMENTAL_BY_TIME_RANGE
    INCREMENTAL_BY_TIME_RANGE タイプのモデルは、時間範囲に基づいて増分的に計算されます。これは、レコードが時間の経過とともにキャプチャされ、イベント、ログ、トランザクションなどの不変のファクトを表すデータセットに最適な選択肢です。適切なデータセットにこのタイプを使用すると、通常、コストと時間を大幅に節約できます。
- INCREMENTAL_BY_UNIQUE_KEY
    INCREMENTAL_BY_UNIQUE_KEY タイプのモデルは、キーに基づいて増分的に計算されます。
- FULL
    FULL 型のモデルでは、モデルに関連付けられたデータセットは、モデル評価のたびに完全に更新（書き換え）されます。
- VIEW
    VIEW 型のモデルは、モデルクエリの出力がマテリアライズされ、物理テーブルに保存されるのではなく、モデルのクエリに基づいて、非マテリアライズドビュー（または「仮想テーブル」）が作成または置換されます。
- EMBEDDED
    埋め込みモデルは、異なる種類のモデル間で共通のロジックを共有する方法です。
- SEED
    SEED モデルの種類は、SQLMesh プロジェクトで静的 CSV データセットを使用するための シード モデル を指定するために使用されます。
- SCD Type 2
    SCD Type 2 は、SQLMesh プロジェクトで 緩やかに変化するディメンション (SCD) をサポートするモデル種別です。SCD はデータウェアハウスでよく使用されるパターンで、レコードの変更を時間経過とともに追跡できます。
    SQLMesh は、モデルに valid_from 列と valid_to 列を追加することでこれを実現します。
- EXTERNAL
    EXTERNALモデル種別は、外部テーブルに関するメタデータを格納する外部モデルを指定するために使用されます。外部モデルは特別なモデルであり、他のモデル種別のように.sqlファイルで指定されません。オプションですが、SQLMeshプロジェクトでクエリされた外部テーブルの列と型情報を伝播するのに役立ちます。
- MANAGED（開発中）
    MANAGED モデルは、基盤となるデータベースエンジンがデータのライフサイクルを管理するモデルを作成するために使用されます。
    Snowflake の [Dynamic tables](https://docs.snowflake.com/user-guide/dynamic-tables-about) を想定しているようです（知らんけど）
- INCREMENTAL_BY_PARTITION
    INCREMENTAL_BY_PARTITION タイプのモデルは、パーティションに基づいて増分的に計算されます。列のセットはモデルのパーティションキーを定義し、パーティションは同じパーティションキー値を持つ行のグループです。
- INCREMENTAL_UNMANAGED
    INCREMENTAL_UNMANAGED モデルは、追加専用テーブルをサポートするために存在します。これは、SQLMesh がデータのロード方法を管理しないという意味で「非管理」です。SQLMesh は設定された頻度でクエリを実行し、取得したデータをテーブルに追加します。
    Data Vault などのデータ管理パターンでは、追加専用のテーブルが使用される場合があります（知らんけど）

## スナップショット
> スナップショットとは、特定の時点におけるモデルの記録です。スナップショットには、モデルのコピーに加えて、モデルを評価してクエリをレンダリングするために必要なすべての情報が含まれています。これにより、SQLMesh は、プロジェクトとそのモデルが進化・変化しても、プロジェクトの履歴とデータを一貫した方法で把握できます。モデルクエリにはマクロが含まれる場合があるため、各スナップショットには、スナップショット作成時点のすべてのマクロ定義とグローバル変数のコピーが保存されます。さらに、スナップショットにはデータが存在する期間も保存されます。

# やってみた
ま、やってみましょう。

## Get started


## SQLMesh CLI Crash Course
### 準備
```bash
git clone https://github.com/sungchun12/sqlmesh-cli-crash-course.git
```

## SQLMesh Full Workflow
### 準備
```bash
git clone https://github.com/sungchun12/sqlmesh-demos.git
```

# おわりに
---
title: "dltの仕組み"
emoji: "🔗"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "dlt", "uv", "duckdb"]
published: false
publication_name: "robon"
---

# はじめに
何か月か前に、[dlt入門](https://zenn.dev/robon/articles/b82a94295e8fae) と題して、dlt のチュートリアルをなぞるような記事を書きました。
dlt が、ELT の E と L をやってくれるのは、わかったのですが、あまりにも少ない行数でコピーできてしまったので「で、どうなってるの？」を調べてみようという記事です。

# やってみる
## 復習
まずは、前回の復習から。チュートリアルのとおりにやると、CLI が init でモリモリ書いてくれたコードもあるので、バッサリ削除してみます。

### REST API
以下のとおり、30行ちょいです。

```py: rest-api/rest_api_pipeline.py
import dlt
from dlt.sources.rest_api import rest_api_source


pokemon_source = rest_api_source(
    {
        "client": {
            "base_url": "https://pokeapi.co/api/v2/",
        },
        "resource_defaults": {
            "endpoint": {
                "params": {
                    "limit": 1000,
                },
            },
        },
        "resources": [
            "pokemon",
            "berry",
            "location",
        ],
    }
)

pipeline = dlt.pipeline(
    pipeline_name="rest_api_pokemon",
    destination="duckdb",
    dataset_name="rest_api_data",
)

load_info = pipeline.run(pokemon_source)
print(load_info)
```

### SQL DB
こっちは、10行ちょいです。

```py: sql-database/sql_database_pipeline.py
import dlt
from dlt.sources.sql_database import sql_database


source = sql_database().with_resources("family", "genome")

pipeline = dlt.pipeline(
    pipeline_name="sql_to_duckdb_pipeline",
    destination="duckdb",
    dataset_name="sql_to_duckdb_pipeline_data",
)

load_info = pipeline.run(source)
print(load_info)
```

あと、DB への接続情報が必要です。

```toml: sql-database/.dlt/secret.toml
[sources.sql_database.credentials]
drivername = "mysql+pymysql" # database+dialect
database = "Rfam"
password = ""
username = "rfamro"
host = "mysql-rfam-public.ebi.ac.uk"
port = 4497
```

### File System
これも 10行ちょい。

```py: file-system/filesystem_pipeline.py
import dlt
from dlt.sources.filesystem import filesystem, read_csv


files = filesystem(bucket_url="gs://filesystem-tutorial", file_glob="encounters*.csv")
reader = (files | read_csv()).with_name("encounters")

pipeline = dlt.pipeline(
    pipeline_name="hospital_data_pipeline",
    destination="duckdb",
    dataset_name="hospital_data",
)

info = pipeline.run(reader)
print(info)
```

設定情報は、以下の２つ

```toml: file-system/.dlt/config.toml
[sources.readers.filesystem]
bucket_url="gs://filesystem-tutorial"
```
```toml: file-system/.dlt/secret.toml
[sources.readers.filesystem.credentials]
client_email = "public-access@dlthub-sandbox.iam.gserviceaccount.com"
project_id = "dlthub-sandbox"
private_key = "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDGWsVHJRjliojx\nTo+j1qu+x8PzC5ZHZrMx6e8OD6tO8uxMyl65ByW/4FZkVXkS4SF/UYPigGN+rel4\nFmySTbP9orva4t3Pk1B9YSvQMB7V5IktmTIW9Wmdmn5Al8Owb1RehgIidm1EX/Z9\nLr09oLpO6+jUu9RIP2Lf2mVQ6tvkgl7UOdpdGACSNGzRiZgVZDOaDIgH0Tl4UWmK\n6iPxhwZy9YC2B1beLB/NU+F6DUykrEpBzCFQTqFoTUcuDAEvuvpU9JrU2iBMiOGw\nuP3TYSiudhBjmauEUWaMiqWAgFeX5ft1vc7/QWLdI//SAjaiTAu6pTer29Q0b6/5\niGh0jRXpAgMBAAECggEAL8G9C9MXunRvYkH6/YR7F1T7jbH1fb1xWYwsXWNSaJC+\nagKzabMZ2KfHxSJ7IxuHOCNFMKyex+pRcvNbMqJ4upGKzzmeFBMw5u8VYGulkPQU\nPyFKWRK/Wg3PZffkSr+TPargKrH+vt6n9x3gvEzNbqEIDugmRTrVsHXhvOi/BrYc\nWhppHSVQidWZi5KVwDEPJjDQiHEcYI/vfIy1WhZ8VuPAaE5nMZ1m7gTdeaWWKIAj\n/p2ZkLgRdCY8vNkfaNDAxDbvH+CMuTtOw55GydzsYYiofANS6xZ8CedGkYaGi82f\nqGdLghX61Sg3UAb5SI36T/9XbuCpTf3B/SMV20ew8QKBgQDm2yUxL71UqI/xK9LS\nHWnqfHpKmHZ+U9yLvp3v79tM8XueSRKBTJJ4H+UvVQrXlypT7cUEE+sGpTrCcDGL\nm8irtdUmMvdi7AnRBgmWdYKig/kgajLOUrjXqFt/BcFgqMyTfzqPt3xdp6F3rSEK\nHE6PQ8I3pJ0BJOSJRa6Iw2VH1QKBgQDb9WbVFjYwTIKJOV4J2plTK581H8PI9FSt\nUASXcoMTixybegk8beGdwfm2TkyF/UMzCvHfuaUhf+S0GS5Zk31Wkmh1YbmFU4Q9\nm9K/3eoaqF7CohpigB0wJw4HfqNh6Qt+nICOMCv++gw7+/UwfV72dCqr0lpzfX5F\nAsez8igTxQKBgDsq/axOnQr+rO3WGpGJwmS8BKfrzarxGXyjnV0qr51X4yQdfGWx\nV3T8T8RC2qWI8+tQ7IbwB/PLE3VURg6PHe6MixXgSDGNZ7KwBnMOqS23/3kEXwMs\nhn2Xg+PZeMeqW8yN9ldxYqmqViMTN32c5bGoXzXdtfPeHcjlGCerVOEFAoGADVPi\nRjkRUX3hTvVF6Gzxa2OyQuLI1y1O0C2QCakrngyI0Dblxl6WFBwDyHMYGepNnxMj\nsr2p7sy0C+GWuGDCcHNwluQz/Ish8SW28F8+5xyamUp/NMa0fg1vwS6AMdeQFbzf\n4T2z/MAj66KJqcV+8on5Z+3YAzVwaDgR56pdmU0CgYBo2KWcNWAhZ1Qa6sNrITLV\nGlxg6tWP3OredZrmKb1kj5Tk0V+EwVN+HnKzMalv6yyyK7SWq1Z6rvCye37vy27q\nD7xfuz0c0H+48uWJpdLcsxpTioopsRPayiVDKlHSe/Qa+MEjAG3ded5TJiC+5iSw\nxWJ51y0wpme0LWgzzoLbRw==\n-----END PRIVATE KEY-----\n"
```

要するに、pipeline.run に dlt 用語で言うところの [Source](https://dlthub.com/docs/devel/general-usage/source) を渡しておしまい。
まぁ、黒魔術的な何かです（笑

## どうなってるの？

[上記の REST API](#rest-api) を実行すると、ソースコードの最終行 `print(load_info)` によって、以下のような出力が得られます。

```sh
$ uv run rest_api_pipeline.py 
2025-07-08 02:20:03,926|[WARNING]|13043|139762141091648|dlt|client.py|detect_paginator:312|Fallback paginator used: SinglePagePaginator at 7f1cbfca83b0. Please provide right paginator manually.
Pipeline rest_api_pokemon load step completed in 0.19 seconds
1 load package(s) were loaded to destination duckdb and into dataset rest_api_data
The duckdb destination used duckdb:////home/ec2-user/work/mds/dlt-getting-started/rest-api/rest_api_pokemon.duckdb location to store data
Load package 1751941203.521931 is LOADED and contains no failed jobs
```

[Destination](https://dlthub.com/docs/devel/general-usage/destination) の `rest_api_pokemon.duckdb` を調べてみます。

```sh
$ ~/.duckdb/cli/latest/duckdb rest_api_pokemon.duckdb
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
D .tables
_dlt_loads           _dlt_version         location           
_dlt_pipeline_state  berry                pokemon            
D .schema pokemon
CREATE TABLE rest_api_data.pokemon("name" VARCHAR, url VARCHAR, _dlt_load_id VARCHAR NOT NULL, _dlt_id VARCHAR NOT NULL);
D .maxrows 10
D select * from rest_api_data.pokemon;
┌──────────────────────────┬──────────────────────────────────────────┬───────────────────┬────────────────┐
│           name           │                   url                    │   _dlt_load_id    │    _dlt_id     │
│         varchar          │                 varchar                  │      varchar      │    varchar     │
├──────────────────────────┼──────────────────────────────────────────┼───────────────────┼────────────────┤
│ bulbasaur                │ https://pokeapi.co/api/v2/pokemon/1/     │ 1751941203.521931 │ rRaJzqYDYOQKzw │
│ ivysaur                  │ https://pokeapi.co/api/v2/pokemon/2/     │ 1751941203.521931 │ f+4TykRTqpvGow │
│ venusaur                 │ https://pokeapi.co/api/v2/pokemon/3/     │ 1751941203.521931 │ jLaaVsbYDZ2RKg │
│ charmander               │ https://pokeapi.co/api/v2/pokemon/4/     │ 1751941203.521931 │ l63T6AFiyzV1Mw │
│ charmeleon               │ https://pokeapi.co/api/v2/pokemon/5/     │ 1751941203.521931 │ H6cElA2854FO/A │
│     ·                    │                  ·                       │         ·         │       ·        │
│     ·                    │                  ·                       │         ·         │       ·        │
│     ·                    │                  ·                       │         ·         │       ·        │
│ ogerpon-wellspring-mask  │ https://pokeapi.co/api/v2/pokemon/10273/ │ 1751941203.521931 │ 3ngMzqxa7i1/vA │
│ ogerpon-hearthflame-mask │ https://pokeapi.co/api/v2/pokemon/10274/ │ 1751941203.521931 │ wEsxg2ZxkTOgHg │
│ ogerpon-cornerstone-mask │ https://pokeapi.co/api/v2/pokemon/10275/ │ 1751941203.521931 │ GAB25+W8YF47cg │
│ terapagos-terastal       │ https://pokeapi.co/api/v2/pokemon/10276/ │ 1751941203.521931 │ 9Eu4tjzcesxQCQ │
│ terapagos-stellar        │ https://pokeapi.co/api/v2/pokemon/10277/ │ 1751941203.521931 │ v/g6/OOE1W5xLg │
├──────────────────────────┴──────────────────────────────────────────┴───────────────────┴────────────────┤
│ 1302 rows (10 shown)                                                                           4 columns │
└──────────────────────────────────────────────────────────────────────────────────────────────────────────┘
D .quit
```

### Pipeline 作業ディレクトリ

やっぱり、よくわかりません。別に隠しているわけではないのでしょうが、[Pipeline working directory](https://dlthub.com/docs/general-usage/pipeline#pipeline-working-directory) というのがあって、これとセットで考えないと、スキーマの推定だったり、進化だったりできちゃうのは、意味がわからないです。

ということで、見てみます。

```sh
$ tree -a ~/.dlt
/home/ec2-user/.dlt
├── .anonymous_id
└── pipelines
    └── rest_api_pokemon
        ├── load
        │   ├── .version
        │   ├── loaded
        │   │   └── 1751941203.521931
        │   │       ├── applied_schema_updates.json
        │   │       ├── completed_jobs
        │   │       │   ├── _dlt_pipeline_state.01049b38d0.0.insert_values
        │   │       │   ├── berry.fcc100835e.0.insert_values
        │   │       │   ├── location.c617abb58e.0.insert_values
        │   │       │   └── pokemon.4c44034d94.0.insert_values
        │   │       ├── failed_jobs
        │   │       ├── load_package_state.json
        │   │       ├── new_jobs
        │   │       ├── package_completed.json
        │   │       ├── schema.json
        │   │       └── started_jobs
        │   ├── new
        │   └── normalized
        ├── normalize
        │   ├── .version
        │   └── extracted
        ├── schemas
        │   └── rest_api.schema.json
        ├── state.json
        └── trace.pickle

14 directories, 14 files
```

ま、直感的に `normalize/extracted` -> `load/normalized` -> `load/loaded` なんでしょうね。

読めそうなヤツから、見ていきましょう。以下、`~/.dlt/pipeline/rest_api_pokemon/` 配下です。あと、人間用にフォーマットしてあります。

```json: state.json
{
    "_state_version": 1,
    "_state_engine_version": 4,
    "_local": {
        "first_run": false,
        "initial_cwd": "/home/ec2-user/work/mds/dlt-getting-started/rest-api",
        "_last_extracted_at": "2025-07-08T02:20:05.457912+00:00",
        "_last_extracted_hash": "+wss72MdiSWsH7g47UzNMXD/ImQwLpGyJGjr/Honm0k="
    },
    "default_schema_name": "rest_api",
    "pipeline_name": "rest_api_pokemon",
    "dataset_name": "rest_api_data",
    "schema_names": [
        "rest_api"
    ],
    "destination_type": "dlt.destinations.duckdb",
    "destination_name": null,
    "_version_hash": "+wss72MdiSWsH7g47UzNMXD/ImQwLpGyJGjr/Honm0k="
}
```

前回実行時のバージョン、名前、パス、時刻などがありますので、今回変わった部分は判定できそうです。

```json: schemas/rest_api.schema.json
{
  "version": 2,
  "version_hash": "bjSDsQVwCCxpVbi/s/7nk6E1Ezg9g65MV87tUMMvA8k=",
  "engine_version": 11,
  "name": "rest_api",
  "tables": {
    "_dlt_version": {
      "name": "_dlt_version",
      "columns": {
        "version": {
          "name": "version",
          "data_type": "bigint",
          "nullable": false
        },
        "engine_version": {
          "name": "engine_version",
          "data_type": "bigint",
          "nullable": false
        },
        "inserted_at": {
          "name": "inserted_at",
          "data_type": "timestamp",
          "nullable": false
        },
        "schema_name": {
          "name": "schema_name",
          "data_type": "text",
          "nullable": false
        },
        "version_hash": {
          "name": "version_hash",
          "data_type": "text",
          "nullable": false
        },
        "schema": {
          "name": "schema",
          "data_type": "text",
          "nullable": false
        }
      },
      "write_disposition": "skip",
      "resource": "_dlt_version",
      "description": "Created by DLT. Tracks schema updates"
    },
    "_dlt_loads": {
      "name": "_dlt_loads",
      "columns": {
        "load_id": {
          "name": "load_id",
          "data_type": "text",
          "nullable": false
        },
        "schema_name": {
          "name": "schema_name",
          "data_type": "text",
          "nullable": true
        },
        "status": {
          "name": "status",
          "data_type": "bigint",
          "nullable": false
        },
        "inserted_at": {
          "name": "inserted_at",
          "data_type": "timestamp",
          "nullable": false
        },
        "schema_version_hash": {
          "name": "schema_version_hash",
          "data_type": "text",
          "nullable": true
        }
      },
      "write_disposition": "skip",
      "resource": "_dlt_loads",
      "description": "Created by DLT. Tracks completed loads"
    },
    "pokemon": {
      "columns": {
        "name": {
          "name": "name",
          "data_type": "text",
          "nullable": true
        },
        "url": {
          "name": "url",
          "data_type": "text",
          "nullable": true
        },
        "_dlt_load_id": {
          "name": "_dlt_load_id",
          "data_type": "text",
          "nullable": false
        },
        "_dlt_id": {
          "name": "_dlt_id",
          "data_type": "text",
          "nullable": false,
          "unique": true,
          "row_key": true
        }
      },
      "write_disposition": "append",
      "name": "pokemon",
      "resource": "pokemon",
      "x-normalizer": {
        "seen-data": true
      }
    },
    "berry": {
      "columns": {
        "name": {
          "name": "name",
          "data_type": "text",
          "nullable": true
        },
        "url": {
          "name": "url",
          "data_type": "text",
          "nullable": true
        },
        "_dlt_load_id": {
          "name": "_dlt_load_id",
          "data_type": "text",
          "nullable": false
        },
        "_dlt_id": {
          "name": "_dlt_id",
          "data_type": "text",
          "nullable": false,
          "unique": true,
          "row_key": true
        }
      },
      "write_disposition": "append",
      "name": "berry",
      "resource": "berry",
      "x-normalizer": {
        "seen-data": true
      }
    },
    "location": {
      "columns": {
        "name": {
          "name": "name",
          "data_type": "text",
          "nullable": true
        },
        "url": {
          "name": "url",
          "data_type": "text",
          "nullable": true
        },
        "_dlt_load_id": {
          "name": "_dlt_load_id",
          "data_type": "text",
          "nullable": false
        },
        "_dlt_id": {
          "name": "_dlt_id",
          "data_type": "text",
          "nullable": false,
          "unique": true,
          "row_key": true
        }
      },
      "write_disposition": "append",
      "name": "location",
      "resource": "location",
      "x-normalizer": {
        "seen-data": true
      }
    },
    "_dlt_pipeline_state": {
      "columns": {
        "version": {
          "name": "version",
          "data_type": "bigint",
          "nullable": false
        },
        "engine_version": {
          "name": "engine_version",
          "data_type": "bigint",
          "nullable": false
        },
        "pipeline_name": {
          "name": "pipeline_name",
          "data_type": "text",
          "nullable": false
        },
        "state": {
          "name": "state",
          "data_type": "text",
          "nullable": false
        },
        "created_at": {
          "name": "created_at",
          "data_type": "timestamp",
          "nullable": false
        },
        "version_hash": {
          "name": "version_hash",
          "data_type": "text",
          "nullable": true
        },
        "_dlt_load_id": {
          "name": "_dlt_load_id",
          "data_type": "text",
          "nullable": false
        },
        "_dlt_id": {
          "name": "_dlt_id",
          "data_type": "text",
          "nullable": false,
          "unique": true,
          "row_key": true
        }
      },
      "write_disposition": "append",
      "file_format": "preferred",
      "name": "_dlt_pipeline_state",
      "resource": "_dlt_pipeline_state",
      "x-normalizer": {
        "seen-data": true
      }
    }
  },
  "settings": {
    "detections": [
      "iso_timestamp"
    ],
    "default_hints": {
      "not_null": [
        "_dlt_id",
        "_dlt_root_id",
        "_dlt_parent_id",
        "_dlt_list_idx",
        "_dlt_load_id"
      ],
      "parent_key": [
        "_dlt_parent_id"
      ],
      "root_key": [
        "_dlt_root_id"
      ],
      "unique": [
        "_dlt_id"
      ],
      "row_key": [
        "_dlt_id"
      ]
    }
  },
  "normalizers": {
    "names": "snake_case",
    "json": {
      "module": "dlt.common.normalizers.json.relational"
    }
  },
  "previous_hashes": [
    "Gdc4n1qRXwTiCnCfqycCWAxxyGDgn7jbj2mCE7FJefs=",
    "um3SJOIZvj59vzg3myb1oaPOCmc8F4VMRHh2hVBN694="
  ]
}
```

これらは、送信先の DuckDB に対応しているようです。（このファイルは、人間用なのか、上記のとおりフォーマットされています）

`pokemon`、`berry`、`location` の３つが [Resource](https://dlthub.com/docs/general-usage/resource) 指定したエンドポイントで、`_dlt_version`、`_dlt_loads`、`_dlt_pipeline_state` の３つが dlt の制御用のようです。

制御用のテーブルの中身も覗いてみます。hash 値で、その回の状態を保持しているようです。

```
D select * from rest_api_data._dlt_version;
┌─────────┬────────────────┬──────────────────────┬─────────────┬──────────────────────┬──────────────────────────────────────────────┐
│ version │ engine_version │     inserted_at      │ schema_name │     version_hash     │                    schema                    │
│  int64  │     int64      │ timestamp with tim…  │   varchar   │       varchar        │                   varchar                    │
├─────────┼────────────────┼──────────────────────┼─────────────┼──────────────────────┼──────────────────────────────────────────────┤
│    2    │       11       │ 2025-07-08 02:20:0…  │ rest_api    │ bjSDsQVwCCxpVbi/s/…  │ {"version":2,"version_hash":"bjSDsQVwCCxpV…  │
└─────────┴────────────────┴──────────────────────┴─────────────┴──────────────────────┴──────────────────────────────────────────────┘
D select * from rest_api_data._dlt_loads;
┌───────────────────┬─────────────┬────────┬───────────────────────────────┬──────────────────────────────────────────────┐
│      load_id      │ schema_name │ status │          inserted_at          │             schema_version_hash              │
│      varchar      │   varchar   │ int64  │   timestamp with time zone    │                   varchar                    │
├───────────────────┼─────────────┼────────┼───────────────────────────────┼──────────────────────────────────────────────┤
│ 1751941203.521931 │ rest_api    │   0    │ 2025-07-08 02:20:05.711779+00 │ bjSDsQVwCCxpVbi/s/7nk6E1Ezg9g65MV87tUMMvA8k= │
└───────────────────┴─────────────┴────────┴───────────────────────────────┴──────────────────────────────────────────────┘
D select * from rest_api_data._dlt_version;
┌─────────┬────────────────┬──────────────────────┬─────────────┬──────────────────────┬──────────────────────────────────────────────┐
│ version │ engine_version │     inserted_at      │ schema_name │     version_hash     │                    schema                    │
│  int64  │     int64      │ timestamp with tim…  │   varchar   │       varchar        │                   varchar                    │
├─────────┼────────────────┼──────────────────────┼─────────────┼──────────────────────┼──────────────────────────────────────────────┤
│    2    │       11       │ 2025-07-08 02:20:0…  │ rest_api    │ bjSDsQVwCCxpVbi/s/…  │ {"version":2,"version_hash":"bjSDsQVwCCxpV…  │
└─────────┴────────────────┴──────────────────────┴─────────────┴──────────────────────┴──────────────────────────────────────────────┘
```


# おわりに
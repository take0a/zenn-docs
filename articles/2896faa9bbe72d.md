---
title: "Envoyå…¥é–€ï¼ˆãã®ï¼’ï¼‰å¤–éƒ¨èªè¨¼"
emoji: "ðŸ›¡ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["envoy", "docker", "authorization", "webapi", "security"]
published: true
publication_name: "robon"
---

# ã¯ã˜ã‚ã«

ãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚„Web APIç•Œéšˆã§ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹é–“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®åˆ¶å¾¡ã‚’ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã¯ãªãã€ãƒ—ãƒ­ã‚­ã‚·ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ã¨ã—ã¦ä½¿ã†ã®ã ã¨ã‹ã€‚ãã®ãƒ‡ãƒ•ã‚¡ã‚¯ãƒˆã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰çš„ãªç«‹ã¡ä½ç½®ãªã®ãŒ Envoy ã•ã‚“ã€‚

ã§ã™ãŒã€æ—¥æœ¬èªžã®æ–°ã—ã„æƒ…å ±ãŒå°‘ãªã„ã®ã§ã€ã ã£ãŸã‚‰[æœ¬å®¶ã®ã‚µã‚¤ãƒˆ](https://www.envoyproxy.io/)ã‚’è¦‹ãªãŒã‚‰ã€è‡ªåŠ›ã§ãªã‚“ã¨ã‹ã™ã‚‹ã—ã‹ãªã„ã­ã€‚ã¨ã„ã†è¨˜äº‹ã§ã™ã€‚

ç¬¬ä¸€å›žç›®ã¯ã€[Transport layer security (TLS)](https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/tls) ã§ã—ãŸã€‚

https://zenn.dev/robon/articles/fc7feab5e77d59

ç¬¬äºŒå›žç›®ã¯ã€[External authorization (ext_authz) filter](https://www.envoyproxy.io/docs/envoy/latest/start/sandboxes/ext_authz) ã§ã™ã€‚

# ã‚„ã£ã¦ã¿ãŸ
## ç’°å¢ƒæ§‹ç¯‰

ä»Šå›žã¯çœç•¥ã—ã¾ã™ã€‚å¿…è¦ãªæ–¹ã¯ã€[ï¼ˆãã®ï¼‘ï¼‰](https://zenn.dev/robon/articles/fc7feab5e77d59) ã‚’ã”è¦§ãã ã•ã„ã€‚

## External authorization (ext_authz) filter

[External Authorization](https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_filters/ext_authz_filter) è‡ªä½“ã®èª¬æ˜Žã¨ãã“ã‹ã‚‰ã•ã‚‰ã«[Architecture overview](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/security/ext_authz_filter)ã®ãƒªãƒ³ã‚¯ã‚‚ã‚ã‚Šã¾ã™ãŒã€ä»Šå›žã‚‚ã€ã¾ã€ã‚„ã£ã¦ã¿ã‚ˆã†ï¼ã¨ã„ã†ã“ã¨ã§ã€‚

ã“ã®ã‚µãƒ³ãƒ—ãƒ«ãŒç›®æŒ‡ã—ã¦ã„ã‚‹ã®ã¯ã€`x-current-useer` ãƒ˜ãƒƒãƒ€ãƒ¼ã«èªè¨¼ã‚µãƒ¼ãƒã‹ã‚‰å¾—ã‚‰ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’ä»˜ã‘ã¦ã€å†…å´ã®ã‚µãƒ¼ãƒãƒ¼ã‚’å‘¼ã³å‡ºã™ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

### Step 1

ã¨ã„ã†ã“ã¨ã§ã€ä»Šå›žã‚‚ Step 1 ã§ã¯ã€å¿…è¦ãªã‚‚ã®ã‚’å…¨éƒ¨ä½œã£ã¦ã€å‹•ã‹ã—ã¾ã™ã€‚æ›¸ã„ã¦ã‚ã‚‹ã¨ãŠã‚Šã«ã‚„ã‚‹ã¨ï¼ˆè‹¥å¹²å‡ºåŠ›ãŒç•°ãªã‚Šã¾ã™ãŒï¼‰å‹•ãã¾ã™ã€‚

```bash
$ docker-compose pull
Pulling ext_authz-http-service ... done
Pulling ext_authz-grpc-service ... done
Pulling ext_authz-opa-service  ... done
Pulling upstream-service       ... done
Pulling front-envoy            ... done

$ docker-compose up --build -d
Creating network "ext_authz_default" with the default driver
Creating ext_authz_ext_authz-http-service_1 ... done
Creating ext_authz_ext_authz-opa-service_1  ... done
Creating ext_authz_upstream-service_1       ... done
Creating ext_authz_ext_authz-grpc-service_1 ... done
Creating ext_authz_front-envoy_1            ... done

$ docker-compose ps
Name                             Command                  State                     Ports               
-----------------------------------------------------------------------------------------------------------------------
ext_authz_ext_authz-grpc-service_1   /app/server -users /etc/us ...   Up
ext_authz_ext_authz-http-service_1   docker-entrypoint.sh /bin/ ...   Up
ext_authz_ext_authz-opa-service_1    ./opa_envoy_linux_amd64 ru ...   Up
ext_authz_front-envoy_1              /docker-entrypoint.sh /bin ...   Up             10000/tcp, 0.0.0.0:8000->8000/tcp, :::8000->8000/tcp                 
ext_authz_upstream-service_1         python3 /code/service.py         Up (healthy)
```

ä»Šå›žã‚‚ `docker-compose.yaml` ã§ç™»å ´äººç‰©ã‚’è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/docker-compose.yaml

ä»Šå›žã€Envoy ã¯ä¸€ã¤ã§ `ext_authz_front-envoy_1`ã€‚å†…å´ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚‚ä¸€ã¤ã§ `ext_authz_upstream-service_1`ã€‚èªè¨¼ã‚µãƒ¼ãƒãŒä¸‰ã¤ã§ã€ç’°å¢ƒå¤‰æ•° `FRONT_ENVOY_YAML` ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ã€‚

### Step 4 ï¼Ÿï¼Ÿ

ãªãœã‹ Step 1 ã®æ¬¡ã¯ Step 4 ã§ã™ã€‚ã¾ãã€2ã€3ã€4 ã§ã€ä¸‰ã¤ã®èªè¨¼ã‚µãƒ¼ãƒã‚’è©¦ãã†ã­â™¡ã€‚ã¨ã„ã†äºˆå®šã ã£ãŸã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã¨ã„ã†ã“ã¨ã§ã€ãã‚Œãžã‚Œè¦‹ã¦ã„ãã¾ã™ã€‚

#### ext_authz-http-service

æœ€åˆã¯ã€docker-compose.yaml ã«ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã‚ã‚‹ `config/http-service.yaml` ã‹ã‚‰ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/config/http-service.yaml

`listener` ã¯ã€8000 ç•ªãƒãƒ¼ãƒˆã§å¾…ã£ã¦ã„ã¦ã€`filter_chains` ã®æœ€åˆã® `filter` ã®ç›®çš„åœ°ã¯ã€`upstream-service` cluster ã§ã€ã“ã‚Œã¯ `upstream-service` ã® 8080 ç•ªãƒãƒ¼ãƒˆã§ã™ã€‚

ãŸã ã€`http_filters` ã¯ã€ã„ã¤ã‚‚ã® `Router` ã®å‰ã« `ExtAuthz` ãŒåˆºã•ã£ã¦ã„ã¦ã€ã“ã‚ŒãŒ `ext_authz-http-service` cluster ã¨é€šä¿¡ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® `x-current-user` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™ã€‚

ã§ã™ã‹ã‚‰ã€æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¨ãŠã‚Šã€å˜ç´”ã« GET ã™ã‚‹ã¨å¤±æ•—ã—ã¾ã™ã€‚

```bash
$ curl -v localhost:8000/service
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> 
< HTTP/1.1 403 Forbidden
< date: Wed, 30 Oct 2024 10:26:09 GMT
< server: envoy
< content-length: 0
< 
* Connection #0 to host localhost left intact
```

ãªã‚“ã§ `localhost:8000/service` ãªã®ã‹ï¼Ÿã¯ã€`upstream-service` ãŒå¾…ã£ã¦ã„ã‚‹ã‹ã‚‰ã§ã™ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/upstream/service/service.py

èªè¨¼ã‚µãƒ¼ãƒã‚‚ç¢ºèªã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/auth/http-service/server.js

`authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã® `Bearer` ã®æ¬¡ã® token ãŒ `users.json` ã«ã‚ã‚Œã°ã€`user` ã‚’ `x-current-useer` ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã€200 OK ã‚’è¿”ã—ã€ç„¡ã‘ã‚Œã°ã€403 Forbidden ã‚’è¿”ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã™ã€‚ï¼ˆrequire ã£ã¦ JSON ã‚‚é£Ÿã¹ã‚‰ã‚Œã‚‹ã‚“ã§ã™ã­ã€‚ï¼‰

ã§ã€`users.json` ã¯ã€ã“ã‚“ãªæ„Ÿã˜

https://github.com/envoyproxy/examples/blob/main/ext_authz/auth/users.json

ãªã®ã§ã€æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```bash
$ curl -v -H "Authorization: Bearer token1" localhost:8000/service
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> Authorization: Bearer token1
> 
< HTTP/1.1 200 OK
< content-type: text/plain; charset=utf-8
< content-length: 30
< date: Wed, 30 Oct 2024 10:43:16 GMT
< server: envoy
< x-envoy-upstream-service-time: 0
< 
* Connection #0 to host localhost left intact
Hello user1 from behind Envoy!
```

#### ext_authz-grpc-service

ã“ã¡ã‚‰ã‚‚ã€ã¾ãšã¯ã€Envoy ã® Yaml ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰

https://github.com/envoyproxy/examples/blob/main/ext_authz/config/grpc-service/v3.yaml

`ExtAuthz` ã§ã€`envoy_grpc` ã¨ã—ã¦å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã®ã§ã€ãƒã‚§ãƒƒã‚¯ãªã©ã¯ `ext_authz-grpc-service` å´ã¸è¡Œã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã“ã“ã‚’ä½œã‚‹ã®ã¯ã€Envoyå…¥é–€ï¼ˆç¬‘ï¼‰ã®ç¯„å›²ã‚’è¶…ãˆã¦ã„ã¾ã™ãŒã€è»½ãè¦‹ã¦ãŠãã¨

https://github.com/envoyproxy/examples/blob/main/ext_authz/auth/grpc-service/pkg/auth/v3/auth.go

ã®ã‚ˆã†ã«ã€ã‚¬ãƒƒãƒ„ãƒª Envoy ã•ã‚“ã® API ã‚’ä½¿ã£ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ãŒã€`authorization` ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚§ãƒƒã‚¯ã¨æˆåŠŸæ™‚ã® `x-current-user` ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä»˜ä¸Žãªã© `ext_authz-http-service` ã¨åŒã˜å®Ÿè£…ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

ã¨ã„ã†ã“ã¨ã§ã€è½ã¨ã—ã¦ã€è¨­å®šã‚’å¤‰ãˆã¦ç«‹ã¡ä¸Šã’ã¾ã™ã€‚ï¼ˆå‡ºåŠ›ã¯çœç•¥ã—ã¾ã™ã€‚ï¼‰

```bash
$ docker-compose down
$ FRONT_ENVOY_YAML=config/grpc-service/v3.yaml docker-compose up --build -d
```

ä»¥ä¸‹ã¯ã€å¤±æ•—ã—

```bash
$ curl -v localhost:8000/service
```

ä»¥ä¸‹ã¯ã€æˆåŠŸã—ã¾ã™ã€‚

```bash
$ curl -v -H "Authorization: Bearer token1" localhost:8000/service
```

#### ext_authz-opa-service

ï¼“ã¤ç›®ã®æœ€å¾Œã¯ã€[Open Policy Agent](https://www.openpolicyagent.org/) ã® OPA ã§ã™ã€‚æœ€åˆã«è¦‹ãŸ `docker-compose.yaml` ã®ã“ã®éƒ¨åˆ†ã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/docker-compose.yaml#L36-L46

ã“ã“ã§ä½¿ç”¨ã—ã¦ã„ã‚‹ Dockerfile ã¯ã€ä»¥ä¸‹ã®ã‚‚ã®ã§

https://github.com/envoyproxy/examples/blob/main/ext_authz/Dockerfile-opa

ã“ã® policy.rego ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/config/opa-service/policy.rego

è©³ç´°ã¯ã€OPA ã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.openpolicyagent.org/docs/latest/)ã‚’èª­ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€rego ã¨ã„ã†ã®ã¯ã€prolog ç³»ã®å®£è¨€åž‹ã®è¨€èªžã¨ã„ã†ã“ã¨ãªã®ã§ã€ä¸Šã‹ã‚‰é †ã«å®Ÿè¡Œã•ã‚Œã‚‹ã¨ã„ã†ã‚ˆã‚Šã‚‚ã€å…¥åŠ›ã¨å®£è¨€ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ãŒé©åˆã—ãŸã‚‚ã®ãŒå‡ºåŠ›ã«ãªã‚‹ã¿ãŸã„ãªæ„Ÿã˜ã®ã‚ˆã†ã§ã™ã€‚

ä¸Šã®ä¾‹ã§ã¯ã€HTTP ãƒ¡ã‚½ãƒƒãƒ‰ãŒ `GET` ãªã‚‰ã€è¨±å¯ã•ã‚Œã¦ã€`x-current-user` ãƒ˜ãƒƒãƒ€ã« `OPA` ãŒå…¥ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã‚’å—ã‘ãŸå‹•ãã‚’å®šç¾©ã™ã‚‹ã®ãŒã€ä»¥ä¸‹ã® Envoy ã® Yaml ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚

https://github.com/envoyproxy/examples/blob/main/ext_authz/config/opa-service/v3.yaml

ã¨è¨€ã£ã¦ã‚‚ã€æœŸå¾…ã—ã¦ã„ã‚‹ `x-current-user` ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®šãŒçµ‚ã‚ã£ã¦ã„ã‚‹ã®ã§ã€é€šã™ã ã‘ã§ã™ã€‚ãŸã ã—ã€HTTP ãƒ¡ã‚½ãƒƒãƒ‰ãŒ `GET` ã§ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚å½“ç„¶ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã® URL ã‚‚æŒ‡å®šã§ãã¾ã™ã®ã§ã€API å˜ä½ã§ã®èªå¯ãŒå®Ÿç¾ã§ãã‚‹ä»•çµ„ã¿ã«ãªã‚Šã¾ã™ã€‚

å‹•ã‹ã—ã¾ã™ã€‚ï¼ˆå‡ºåŠ›ã¯çœç•¥ã—ã¾ã™ã€‚ï¼‰

```bash
$ docker-compose down
$ FRONT_ENVOY_YAML=config/opa-service/v3.yaml docker-compose up --build -d
```

ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚`GET` ã§ã‚ã‚Œã°æˆåŠŸã—ã¾ã™ã€‚

```bash
$ curl localhost:8000/service --verbose 
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> GET /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< content-type: text/plain; charset=utf-8
< content-length: 28
< date: Sat, 02 Nov 2024 05:25:34 GMT
< server: envoy
< x-envoy-upstream-service-time: 0
< 
* Connection #0 to host localhost left intact
Hello OPA from behind Envoy!
```

`POST` ã¯å¤±æ•—ã—ã¾ã™ã€‚

```bash
$ curl -X POST localhost:8000/service --verbose
*   Trying [::1]:8000...
* Connected to localhost (::1) port 8000
> POST /service HTTP/1.1
> Host: localhost:8000
> User-Agent: curl/8.3.0
> Accept: */*
> 
< HTTP/1.1 403 Forbidden
< date: Sat, 02 Nov 2024 05:27:21 GMT
< server: envoy
< content-length: 0
< 
* Connection #0 to host localhost left intact
```

# ãŠã‚ã‚Šã«

å¤–éƒ¨èªè¨¼ã«ã¤ã„ã¦ã‚‚ã€ã‚µãƒ³ãƒ—ãƒ«ã¨ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’è¦‹ãªãŒã‚‰ã§ã‚ã‚Œã°ã€è¨­å®šã§ããã†ã§ã™ã­ã€‚
ãã‚Œã§ã¯ã€ç¬¬ï¼“å›žãŒã‚ã‚Œã°ï¼ˆç¬‘ï¼‰ã€ç¬¬ï¼“å›žã§ã€‚

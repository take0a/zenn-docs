---
title: "FastAPIã§RESTï¼ˆãã®ï¼’ï¼‰"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["fastapi", "rest", "postgresql", "python", "ã‚¹ã‚­ãƒ¼ãƒé§†å‹•"]
published: false
publication_name: "robon"
---

# å‰å›ã¾ã§

https://zenn.dev/robon/articles/aa7ba513b3bdb3

FastAPIã‚‚å°å…¥ã™ã‚Œã°ã€ã¨ã‚Šã‚ãˆãšå‹•ãã¨ã“ã‚ã¾ã§ã¯ç°¡å˜ã§ã—ãŸã€‚

# è¨­è¨ˆã¨å®Ÿè£…
## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ ã¯ã©ã†ã™ã‚‹ï¼Ÿ

NestJSã¯CLIã§ã²ãªå‹ã®è‡ªå‹•ç”Ÿæˆã‚’ã—ã¦ãã‚ŒãŸã®ã§ã€ãã‚Œã«ä¹—ã£ã‹ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ã‚¹ã‚­ãƒ¼ãƒå˜ä½ã®æ§‹é€ ã¯ã€ã‚¹ã‚­ãƒ¼ãƒé§†å‹•ã§ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ãªæ„Ÿã˜ã§ã€ã“ã‚Œã‹ã‚‰ã¯ã“ã†ã„ã†æ§‹é€ ã«ãªã£ã¦ã„ãã®ã‹ãªãã¨æ€ã„ã¾ã—ãŸã€‚

ã§ã€FastAPIã§ã™ã€‚å…¬å¼ã§ã¯ã€ã©ã†ã‚„ã‚‰ãƒ¬ã‚¤ãƒ¤æ§‹é€ ã‚’æ¨å¥¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://fastapi.tiangolo.com/tutorial/bigger-applications/

å¤šãã®è¨˜äº‹ã§ä¸Šè¨˜ã«è¿‘ã„æ§‹é€ ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ã“ã“ã¯NestJSã®ã‚ˆã†ã«ã‚¹ã‚­ãƒ¼ãƒå˜ä½ã®æ§‹é€ ã‚’æ¡ç”¨ã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚¹ã‚­ãƒ¼ãƒåã«ãªã‚Šã€æ©Ÿèƒ½åãŒãƒ•ã‚¡ã‚¤ãƒ«åã«ãªã‚‹ã ã‘ãªã®ã§ã€ç¸¦ã¨æ¨ªã‚’ã²ã£ãã‚Šè¿”ã—ãŸã‚ˆã†ã«ãªã‚‹ã ã‘ã§ã™ã€‚

```bash
$ tree src -I __pycache__
src
â”œâ”€â”€ config.py
â”œâ”€â”€ customers
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models.py
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ schemas.py
â”‚   â””â”€â”€ service.py
â”œâ”€â”€ database.py
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py
â”œâ”€â”€ orders
â””â”€â”€ products
```

æœ€åˆã«å®Ÿè£…ã™ã‚‹customersã¨åŒæ§˜ã«ordersã¨productsã«ã‚‚å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

## SQLAlchemy & Postgres

æŠ˜è§’ãªã®ã§ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚‚éåŒæœŸã«ã—ã¦ã¿ã¾ã™ã€‚

```bash
(venv) $ pip install sqlalchemy
(venv) $ pip install asyncpg
```

## å…±é€šéƒ¨

pydanticã®BeseSettingsã‚’ä½¿ã£ã¦.envã®è¨­å®šã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚

```py: src/config.py
from pydantic import BaseSettings


class Settings(BaseSettings):
    DB_HOST: str
    DB_USER: str
    DB_PASS: str

    class Config:
        env_file = ".env.dev"
```

ä¸Šè¨˜ã‚’ä½¿ç”¨ã—ã¦ã€SQLAlchemyã®å…±é€šè¨­å®šã‚’ã—ã¾ã™ã€‚

```py: src/database.py
from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from sqlalchemy.orm import DeclarativeBase

from . import config


settings = config.Settings()
DB_URL = "postgresql+asyncpg://" \
    f"{settings.DB_USER}:{settings.DB_PASS}@{settings.DB_HOST}:5432/postgres"

engine = create_async_engine(DB_URL, echo=True)
async_session = async_sessionmaker(engine, expire_on_commit=False)


class Base(DeclarativeBase):
    pass


async def get_session():
    async with async_session() as session:
        yield session
```

ã‚ã¨ã¯ã€main.pyã§ã™ãŒã€ã“ã‚Œã¯å€‹åˆ¥éƒ¨ã®å¾Œã«ã—ã¾ã™ã€‚

## customers

ã¾ãšã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¢ãƒ‡ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

```py: src/customers/models.py
from sqlalchemy.orm import Mapped, mapped_column

from src.database import Base


class Customer(Base):
    __tablename__ = "customer"

    customerId: Mapped[int] = mapped_column(
        name="customer_id", primary_key=True)
    name: Mapped[str]
    address: Mapped[str]

    def __repr__(self) -> str:
        return f"Customer(customerId={self.customerId!r}, " \
            f"name={self.name!r}, address={self.address!r})"
```

æ¬¡ã«ã€ãƒªã‚½ãƒ¼ã‚¹è¡¨ç¾ã¨ã—ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’pydanticã®BaseModelã§å®šç¾©ã—ã¾ã™ã€‚

```py: src/customers/schemas.py
from pydantic import BaseModel


class Customer(BaseModel):
    customerId: int
    name: str
    address: str

    class Config:
        orm_mode = True
```

orm_mode = True ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®æ„å‘³ã«ãªã‚Šã¾ã™ã€‚

> Pydantic's orm_mode will tell the Pydantic model to read the data even if it is not a dict, but an ORM model (or any other arbitrary object with attributes).

https://fastapi.tiangolo.com/ja/tutorial/sql-databases/

ãƒ¢ãƒ‡ãƒ«ã¨ã‚¹ã‚­ãƒ¼ãƒã®æº–å‚™ãŒã§ããŸã‚‰ã€ã“ã®ä¸¡è€…ã®å¤‰æ›ã¨SQLAlchemyã¸ã®å‘½ä»¤ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

```py: src/customers/service.py
from fastapi import HTTPException
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from . import models, schemas


async def get_customer(db: AsyncSession, customerId: int):
    result = await (db.execute(select(models.Customer).filter(
        models.Customer.customerId == customerId)))
    customer = result.first()
    if customer is None:
        raise HTTPException(status_code=404, detail="Customer not found")
    return customer[0]


async def create_customer(db: AsyncSession, customer: schemas.Customer):
    db_customer = models.Customer(
        customerId=customer.customerId,
        name=customer.name,
        address=customer.address)
    db.add(db_customer)
    await db.commit()
    await db.refresh(db_customer)
    return db_customer


async def update_customer(
        db: AsyncSession, customerId: int, customer: schemas.Customer
):
    original = await get_customer(db, customerId)
    original.name = customer.name
    original.address = customer.address
    db.add(original)
    await db.commit()
    await db.refresh(original)
    return original


async def delete_customer(db: AsyncSession, customerId: int):
    original = await get_customer(db, customerId)
    await db.delete(original)
    await db.commit()
```

ãã—ã¦ã€æœ€å¾Œã«ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

```py: src/customers/router.py
from fastapi import APIRouter, Depends
from sqlalchemy.ext.asyncio import AsyncSession

from src.database import get_session
from . import schemas, service


router = APIRouter()


@router.post("/customers", response_model=schemas.Customer)
async def create_customer(
    customer: schemas.Customer, db: AsyncSession = Depends(get_session)
):
    return await service.create_customer(db, customer)


@router.get("/customers/{customerId}", response_model=schemas.Customer)
async def get_customer(
    customerId: int, db: AsyncSession = Depends(get_session)
):
    return await service.get_customer(db, customerId)


@router.put("/customers/{customerId}", response_model=schemas.Customer)
async def update_customer(
    customerId: int,
    customer: schemas.Customer,
    db: AsyncSession = Depends(get_session)
):
    return await service.update_customer(db, customerId, customer)


@router.delete("/customers/{customerId}", response_model=None)
async def delete_customer(
    customerId: int, db: AsyncSession = Depends(get_session)
):
    await service.delete_customer(db, customerId)
```

## ã‚‚ã†ä¸€åº¦ã€å…±é€šéƒ¨

ãƒªã‚½ãƒ¼ã‚¹æ¯ã«ã¾ã¨ã‚ãŸãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«çµ„ã¿è¾¼ã¿ã¾ã™ã€‚

```py: src/main.py
from fastapi import FastAPI

from src.customers.router import router as customers_router

app = FastAPI()
app.include_router(customers_router)
```

# æ¬¡å›ã¯

æ®‹ã‚Šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ä½•ã‚‚ãªã‘ã‚Œã°ã€ã“ã“ã§çµ‚ã‚ã‚Šã«ã™ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

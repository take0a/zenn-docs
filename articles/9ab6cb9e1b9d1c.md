---
title: "Golang„ÅßOracleÔºà„Åù„ÅÆÔºëÔºâ"
emoji: "üêï"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: ["golang", "sqlx", "sql", "database", "oracle"]
published: true
publication_name: "robon"
---
# „ÅØ„Åò„ÇÅ„Å´

ÂâçÂõû„ÅØ„ÄÅGolang „Åß MySQL/MariaDB „ÅÆÂêÑÁ®Æ„Éá„Éº„ÇøÂûã„ÅÆÂÖ•Âá∫Âäõ„ÇíÊ§úË®º„Åó„Åæ„Åó„Åü„ÄÇ

https://zenn.dev/robon/articles/9c53c6905f2ffb

‰ªäÂõû„ÅØ„ÄÅOracle „ÇíË©ï‰æ°„Åó„Åæ„Åô„ÄÇ

# Oracle
## „Éá„Éº„Çø„Éô„Éº„Çπ

Amazon RDS ‰∏ä„Å´ÊßãÁØâ„Åó„Åü MySQL „Çµ„Éº„Éê„Éº„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ

| Ë®≠ÂÆö | ÂÄ§ |
|---|---|
| „Ç®„É≥„Ç∏„É≥„Éê„Éº„Ç∏„Éß„É≥ | 19.0.0.0.ru-2023-01.rur-2023-01.r1 |
| ÊñáÂ≠ó„Çª„ÉÉ„Éà | AL32UTF8 |
| „Ç§„É≥„Çπ„Çø„É≥„Çπ„ÇØ„É©„Çπ | db.m5.large |
| vCPU | 2 |
| RAM | 8GB |
| „Çπ„Éà„É¨„Éº„Ç∏ | 20GiB |

## „ÇØ„É©„Ç§„Ç¢„É≥„Éà

Amazon EC2 „ÅÆ Amazon Linux 2 „Åã„ÇâÊé•Á∂ö„Åó„Åæ„Åô„ÄÇ

### „ÉÑ„Éº„É´

sqlplus „Çí‰ΩøÁî®„Åó„Åæ„Åô„ÅÆ„Åß„ÄÅ[OracleÁ§æ„ÅÆ„Çµ„Ç§„Éà](https://www.oracle.com/jp/database/technologies/instant-client/linux-x86-64-downloads.html) „Åã„Çâ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÄÇÔºàOracle„Ç¢„Ç´„Ç¶„É≥„Éà„ÅåÂøÖË¶Å„Å´„Å™„Çä„Åæ„ÅôÔºâ

Amazon Linux 2 „ÅÆÂ†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Åæ„Åô„ÄÇ

```bash
$ sudo yum install oracle-instantclient19.19-basic-19.19.0.0.0-1.x86_64.rpm 
$ sudo yum install oracle-instantclient19.19-sqlplus-19.19.0.0.0-1.x86_64.rpm 
```

## „ÉÜ„Çπ„ÉàÁî®„ÅÆ„ÉÜ„Éº„Éñ„É´
### „Éá„Éº„ÇøÂûã„ÅÆ‰∏ÄË¶ß

[„Éû„Éã„É•„Ç¢„É´](https://docs.oracle.com/cd/E57425_01/121/SQLRF/sql_elements001.htm#i54330) „Åã„ÇâÊäúÁ≤ã„Åó„Åæ„Åô„ÄÇ

| „Ç≥„Éº„Éâ | „Éá„Éº„ÇøÂûã | Ë™¨ÊòéÔºàÊäúÁ≤ãÔºâ |
|---|---|---|
| 1 | VARCHAR2(size [BYTE \| CHAR]) | ÊúÄÂ§ßÈï∑„Ååsize„Éê„Ç§„Éà„Åæ„Åü„ÅØÊñáÂ≠ó„ÅÆÂèØÂ§âÈï∑ÊñáÂ≠óÂàó„ÄÇ | 
| 1 | NVARCHAR2(size) | ÊúÄÂ§ßÈï∑„ÅåsizeÊñáÂ≠ó„ÅÆÂèØÂ§âÈï∑UnicodeÊñáÂ≠óÂàó„ÄÇ | 
| 2 | NUMBER [ (p [, s]) ] | Á≤æÂ∫¶p„ÄÅ‰ΩçÂèñ„Çäs„ÇíÊåÅ„Å§Êï∞„ÄÇ | 
| 2 | FLOAT [(p)] | Á≤æÂ∫¶p„ÇíÊåÅ„Å§NUMBER„Éá„Éº„ÇøÂûã„ÅÆ„Çµ„Éñ„Çø„Ç§„Éó„ÄÇ | 
| 8 | LONG | ÊúÄÂ§ß2GB(231„Åã„Çâ1„ÇíÂºï„ÅÑ„Åü„Éê„Ç§„ÉàÊï∞)„ÅÆÂèØÂ§âÈï∑ÊñáÂ≠ó„Éá„Éº„Çø„ÄÇ |
| 12 | DATE | Á¥ÄÂÖÉÂâç4712Âπ¥1Êúà1Êó•„Åã„ÇâÁ¥ÄÂÖÉ9999Âπ¥12Êúà31Êó•„Åæ„Åß„ÅÆÊó•‰ªò„ÇíÊåáÂÆö„Åó„Åæ„Åô„ÄÇ | 
| 100 | BINARY_FLOAT | 32„Éì„ÉÉ„Éà„ÅÆÊµÆÂãïÂ∞èÊï∞ÁÇπÊï∞„ÄÇ |
| 101 | BINARY_DOUBLE | 64„Éì„ÉÉ„Éà„ÅÆÊµÆÂãïÂ∞èÊï∞ÁÇπÊï∞„ÄÇ |
| 180 | TIMESTAMP [(fractional_seconds_precision)] | Êó•‰ªò„ÅÆÂπ¥„ÄÅÊúà„ÄÅÊó•„Åä„Çà„Å≥ÊôÇÂàª„ÅÆÊôÇ„ÄÅÂàÜ„ÄÅÁßí„ÅÆÂÄ§„ÄÇ |
| 181 | TIMESTAMP [(fractional_seconds_precision)] WITH TIME ZONE | „Çø„Ç§„É†„Çæ„Éº„É≥„Å´„Çà„ÇãÊôÇÂ∑Æ„Å™„Å©„ÅÆ„Åô„Åπ„Å¶„ÅÆTIMESTAMP„ÅÆÂÄ§„ÄÇ |
| 231 | TIMESTAMP [(fractional_seconds_precision)] WITH LOCAL TIME ZONE | TIMESTAMP WITH TIME ZONE„ÅÆ„Åô„Åπ„Å¶„ÅÆÂÄ§„ÄÇ |
| 182 | INTERVAL YEAR [(year_precision)] TO MONTH | Âπ¥„Åä„Çà„Å≥Êúà„ÅßÊúüÈñì„ÇíÊ†ºÁ¥ç„ÄÇ |
| 183 | INTERVAL DAY [(day_precision)] TO SECOND [(fractional_seconds_precision)] | Êó•„ÄÅÊôÇ„ÄÅÂàÜ„Åä„Çà„Å≥Áßí„ÅßÊúüÈñì„ÇíÊ†ºÁ¥ç„ÄÇ |
| 23 | RAW(size) | Èï∑„Åïsize„Éê„Ç§„Éà„ÅÆ„Éê„Ç§„Éä„É™„Éª„Éá„Éº„Çø„ÄÇ | 
| 24 | LONG RAW | ÊúÄÂ§ß2GB„ÅÆÂèØÂ§âÈï∑„Éê„Ç§„Éä„É™„Éª„Éá„Éº„Çø„ÄÇ |
| 69 | ROWID | Ë°®„ÅÆË°å„ÅÆ„Ç¢„Éâ„É¨„Çπ„Çí‰∏ÄÊÑè„Å´Ë°®„ÅôBASE64ÊñáÂ≠óÂàó„ÄÇ |
| 208 | UROWID [(size)] | Á¥¢ÂºïÊßãÊàêË°®„ÅÆË°å„ÅÆË´ñÁêÜ„Ç¢„Éâ„É¨„Çπ„ÇíË°®„ÅôBASE64ÊñáÂ≠óÂàó„ÄÇ |
| 96 | CHAR [(size [BYTE \| CHAR])] | Èï∑„Åïsize„Éê„Ç§„Éà„Åæ„Åü„ÅØÊñáÂ≠ó„ÅÆÂõ∫ÂÆöÈï∑ÊñáÂ≠ó„Éá„Éº„Çø„ÄÇ |
| 96 | NCHAR[(size)] | Èï∑„ÅïsizeÊñáÂ≠ó„ÅÆÂõ∫ÂÆöÈï∑ÊñáÂ≠ó„Éá„Éº„Çø„ÄÇ |
| 112 | CLOB | „Ç∑„É≥„Ç∞„É´„Éê„Ç§„ÉàÊñáÂ≠ó„Åæ„Åü„ÅØ„Éû„É´„ÉÅ„Éê„Ç§„Éà„Éª„Ç≠„É£„É©„ÇØ„Çø„ÇíÂê´„ÇÄ„Ç≠„É£„É©„ÇØ„Çø„Éª„É©„Éº„Ç∏„Éª„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÄÇ |
| 112 | NCLOB | Unicode„Ç≠„É£„É©„ÇØ„Çø„ÇíÂê´„ÇÄ„Ç≠„É£„É©„ÇØ„Çø„Éª„É©„Éº„Ç∏„Éª„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÄÇ |
| 113 | BLOB | „Éê„Ç§„Éä„É™„Éª„É©„Éº„Ç∏„Éª„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÄÇ | 
| 114 | BFILE | „Éá„Éº„Çø„Éô„Éº„ÇπÂ§ñ„Å´‰øùÂ≠ò„Åï„Çå„ÅüÂ§ß„Åç„Å™„Éê„Ç§„Éä„É™„Éª„Éï„Ç°„Ç§„É´„Å∏„É≠„Ç±„Éº„Çø„ÇíÊ†ºÁ¥ç„ÄÇ |

### „ÉÜ„Çπ„ÉàÁî®„ÅÆ„ÉÜ„Éº„Éñ„É´

„Åù„ÅÆ„Åæ„Åæ CREATE TABLEÊñá„Å´„Åó„Åæ„Åô„ÄÇ

```sql
CREATE TABLE DATATYPES (
    COL01 VARCHAR2(10 CHAR),
    COL02 NVARCHAR2(10),
    COL03 NUMBER(10),
    COL04 NUMBER(10,4),
    COL05 FLOAT(10),
    COL06 LONG,
    COL07 DATE,
    COL08 BINARY_FLOAT,
    COL09 BINARY_DOUBLE,
    COL10 TIMESTAMP,
    COL11 TIMESTAMP WITH TIME ZONE,
    COL12 TIMESTAMP WITH LOCAL TIME ZONE,
    COL13 INTERVAL YEAR TO MONTH,
    COL14 INTERVAL DAY TO SECOND,
    COL15 RAW(10),
    -- COL16 LONG RAW, ORA-01754: a table may contain only one column of type LONG
    COL17 ROWID,
    COL18 UROWID,
    COL19 CHAR(10 CHAR),
    COL20 NCHAR(10),
    COL21 CLOB,
    COL22 NCLOB,
    COL23 BLOB,
    COL24 BFILE,
    CONSTRAINT PK_CUSTOMER PRIMARY KEY(COL01)
);
```

# Golang
## Âá¶ÁêÜÁ≥ª
```bash
$ go version
go version go1.18.6 linux/amd64
```

## „É©„Ç§„Éñ„É©„É™

github.com/sijms/go-ora/v2 „ÅÆ v2.7.6 „Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ„Éá„Éº„ÇøÂûã„Å´„Å§„ÅÑ„Å¶„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆ‰ªïÊßò„Åß„Å§„Åè„Çâ„Çå„Å¶„ÅÑ„Çã„Çà„ÅÜ„Åß„Åô„ÄÇ

https://github.com/sijms/go-ora/blob/v2.7.6/v2/data_set.go#L378-L442

## „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥

„ÉÜ„Çπ„ÉàÁî®„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´ÂØæ„Åó„Å¶ÂÖ•Âá∫Âäõ„ÇíË°å„ÅÜ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂÆüË£Ö„Åó„Åæ„Åô„ÄÇÊ≠ØÊäú„Åë„ÅÆÁä∂ÊÖã„Åã„ÇâÂæê„ÄÖ„Å´Âüã„ÇÅ„Å¶„ÅÑ„Åë„Çã„Çà„ÅÜ„Å´„ÄÅNullable Âûã„ÅßÂÖ•Âá∫Âäõ„Åó„Åæ„Åô„ÄÇ

```go: main.go
package main

import (
	"database/sql"
	"database/sql/driver"
	"log"
	"os"
	"reflect"
	"time"

	"github.com/google/go-cmp/cmp"
	"github.com/jmoiron/sqlx"
	ora "github.com/sijms/go-ora/v2"
)

// Datatypes „ÅØ„ÄÅ„Éá„Éº„ÇøÂûã„ÉÜ„Çπ„Éà„ÉÜ„Éº„Éñ„É´
type Datatypes struct {
	Col01 sql.NullString  `db:"COL01"` // varchar2
	Col02 sql.NullString  `db:"COL02"` // nvarchar2
	Col03 sql.NullInt64   `db:"COL03"` // number(10)
	Col04 sql.NullString  `db:"COL04"` // number(10,4)
	Col05 sql.NullFloat64 `db:"COL05"` // float(10)
	Col06 sql.NullString  `db:"COL06"` // long
	Col07 sql.NullTime    `db:"COL07"` // date
	Col08 sql.NullFloat64 `db:"COL08"` // binary_float
	Col09 sql.NullFloat64 `db:"COL09"` // binary_double
	Col10 OraTimeStamp    `db:"COL10"` // timestamp
	Col11 OraTimeStamp    `db:"COL11"` // timestamp with tz
	Col12 OraTimeStamp    `db:"COL12"` // timestamp with local tz
	Col13 sql.NullString  `db:"COL13"` // interval year to month
	Col14 sql.NullString  `db:"COL14"` // interval day to second
	Col15 []byte          `db:"COL15"` // raw
	// Col16 []byte          `db:"COL16"` // long raw
	Col17 sql.NullString `db:"COL17"` // rowid
	Col18 sql.NullString `db:"COL18"` // urowid
	Col19 sql.NullString `db:"COL19"` // char(10)
	Col20 sql.NullString `db:"COL20"` // nchar(10)
	Col21 sql.NullString `db:"COL21"` // clob
	Col22 sql.NullString `db:"COL22"` // nclob
	Col23 []byte         `db:"COL23"` // blob
	// Col24 []byte          `db:"COL24"` // bfile
}

// Key „ÅØ„ÄÅ„Éá„Éº„ÇøÂûã„ÉÜ„Çπ„Éà„ÉÜ„Éº„Éñ„É´„ÅÆ„Ç≠„Éº
type Key struct {
	Col01 string `db:"COL01"`
}

func main() {
	sqlx.BindDriver("oracle", sqlx.NAMED)

	dsn := os.Getenv("DSN")
	db, err := sqlx.Open("oracle", dsn)
	if err != nil {
		log.Printf("sql.Open error %s", err)
	}

	JST, _ := time.LoadLocation("Asia/Tokyo")
	key := Key{"1"}
	src := Datatypes{
		Col01: sql.NullString{String: "1", Valid: true},
		Col02: sql.NullString{String: "123456789", Valid: true},
		Col03: sql.NullInt64{Int64: 123, Valid: true},
		Col04: sql.NullString{String: "123456.1234", Valid: true},
		Col05: sql.NullFloat64{Float64: 1.25, Valid: true},
		Col06: sql.NullString{String: "abc", Valid: true},
		Col07: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 0, time.UTC), Valid: true}, // ÊôÇÂàª„ÇÇÊåÅ„Å§Ôºà‰ªïÊßòÈÄö„ÇäÔºâ
		Col08: sql.NullFloat64{Float64: 2.5, Valid: true},
		Col09: sql.NullFloat64{Float64: 3.125, Valid: true},
		Col10: OraTimeStamp{sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000, time.UTC), Valid: true}}, // „Éû„Ç§„ÇØ„É≠ÁßíÊåÅ„Å¶„Å™„ÅÑ
		Col11: OraTimeStamp{sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000, JST), Valid: true}},      // „Éû„Ç§„ÇØ„É≠Áßí„ÇÇTZ„ÇÇÊåÅ„Å¶„Å™„ÅÑ
		Col12: OraTimeStamp{sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000, JST), Valid: true}},      // „Éû„Ç§„ÇØ„É≠Áßí„ÇÇTZ„ÇÇÊåÅ„Å¶„Å™„ÅÑ
		Col13: sql.NullString{String: "+01-11", Valid: true},
		Col14: sql.NullString{String: "+09 23:59:59.000001", Valid: true},
		Col15: []byte{1, 2, 3},

		Col17: sql.NullString{String: "AAARXwAAEAAAAKbAAE", Valid: true},
		Col18: sql.NullString{String: "AAARXwAAEAAAAKbAAE", Valid: true},
		Col19: sql.NullString{String: "12345678  ", Valid: true}, // Êú´Â∞æ„ÅØ„Çπ„Éö„Éº„Çπ
		Col20: sql.NullString{String: "12345678  ", Valid: true}, // Êú´Â∞æ„ÅØ„Çπ„Éö„Éº„Çπ
		Col21: sql.NullString{String: "CLOB", Valid: true},
		Col22: sql.NullString{String: "NCLOB", Valid: true},
		Col23: []byte{1, 2, 3, 4},
	}

	_, err = db.NamedExec(`
		INSERT INTO DATATYPES (
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15,        col17, col18, col19, col20,
			col21, col22, col23
		) VALUES (
			:COL01, :COL02, :COL03, :COL04, :COL05, :COL06, :COL07, :COL08, :COL09, :COL10,
			:COL11, :COL12, :COL13, :COL14, :COL15,         :COL17, :COL18, :COL19, :COL20,
			:COL21, :COL22, :COL23
		)`,
		src,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}

	dst := Datatypes{}
	query, args, err := db.BindNamed(`
		SELECT 
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15,        col17, col18, col19, col20,
			col21, col22, col23
		FROM DATATYPES 
		WHERE col01 = :COL01`,
		key,
	)
	if err != nil {
		log.Printf("db.BindNamed error %s", err)
	}
	err = db.QueryRowx(query,
		args...,
	).StructScan(
		&dst,
	)
	if err != nil {
		log.Printf("db.QueryRow error %s", err)
	}
	if !reflect.DeepEqual(src, dst) {
		// log.Printf("\nsrc = %#v\ndst = %#v\n", src, dst)
		diff := cmp.Diff(src, dst)
		if len(diff) > 0 {
			log.Print(diff)
		}
	}

	_, err = db.NamedExec(`
		DELETE FROM datatypes
		WHERE col01 = :COL01`,
		key,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}
}

// OraTimeStamp „ÅØ„ÄÅNull „ÇíË®±ÂÆπ„Åô„Çã Time
type OraTimeStamp struct {
	sql.NullTime
}

// Scan implements the Scanner interface.
func (ot *OraTimeStamp) Scan(value any) error {
	if value == nil {
		ot.Time, ot.Valid = time.Time{}, false
		return nil
	}
	ot.Valid = true
	switch temp := value.(type) {
	case ora.TimeStamp:
		ot.NullTime.Time = time.Time(temp)
	case *ora.TimeStamp:
		ot.NullTime.Time = time.Time(*temp)
	case ora.TimeStampTZ:
		ot.NullTime.Time = time.Time(temp)
	case *ora.TimeStampTZ:
		ot.NullTime.Time = time.Time(*temp)
	default:
		return ot.NullTime.Scan(value)
	}
	return nil
}

// Value implements the driver Valuer interface.
func (ot OraTimeStamp) Value() (driver.Value, error) {
	if !ot.Valid {
		return nil, nil
	}
	return ora.TimeStampTZ(ot.Time), nil
}
```

# „Åä„Çè„Çä„Å´

Oracle „ÅÆÂêÑÁ®Æ TimeStamp „ÅØ„ÄÅtime.Time „ÇÑ sql.NullTime „Åß„ÅØÔºëÁßíÊú™Ê∫Ä„ÅÆÂ∞èÊï∞ÈÉ®„ÇÑ„Çø„Ç§„É†„Çæ„Éº„É≥„ÅåÈÄ£Êê∫„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü„ÅÆ„Åß„ÄÅsql.Scanner „Åß driver.Valuer „Å™ OraTimeStamp „ÇíÁî®ÊÑè„Åó„Å¶„ÄÅ„Éâ„É©„Ç§„Éê„Åß TimeStamp Áî®„Å´ÂÆöÁæ©„Åó„Å¶„ÅÑ„ÇãÁã¨Ëá™Âûã„Åß„ÅÆÂÖ•Âá∫Âäõ„Å´ÂØæÂøú„Åó„Åæ„Åó„Åü„ÄÇ

Êó•Êú¨Ë™û„Å´„Å§„ÅÑ„Å¶„ÅØ„ÄÅÂà•ÈÄî„ÄÅ„ÉÜ„Çπ„Éà„Åó„Åü„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇ

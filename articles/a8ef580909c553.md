---
title: "VSCode拡張開発メモ"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["vscode", "typescript"]
published: false
publication_name: "robon"
---
# はじめに
「[VSCodeでSQLMesh](https://zenn.dev/robon/articles/2cca1898b60468)」で、SQLMesh の VSCode 拡張を確認して、ソースコードもあるし、拡張を拡張しちゃうぞ。と思ったのですが、ソースコードの気持ちが全くわからず…。ということで、ネットにたくさんある VSCode 拡張の作り方の Yet Another なんとかですが、できるだけ最新の公式から。

# [概要](https://code.visualstudio.com/api)
## 拡張機能でできること(の例)
- VS Code の外観を色やファイルアイコンのテーマで変更する - [Theming](https://code.visualstudio.com/api/extension-capabilities/theming)
- UI にカスタム コンポーネントとビューを追加する - [ワークベンチの拡張](https://code.visualstudio.com/api/extension-capabilities/extending-workbench)
- HTML/CSS/JS で構築されたカスタム Web ページを表示する Webview を作成する - [Webview ガイド](https://code.visualstudio.com/api/extension-guides/webview)
- 新しいプログラミング言語のサポート - [言語拡張の概要](https://code.visualstudio.com/api/language-extensions/overview)
- 特定のランタイムのデバッグをサポートする - [デバッガー拡張ガイド](https://code.visualstudio.com/api/extension-guides/debugger-extension)

# [拡張機能の概要](https://code.visualstudio.com/api/extension-capabilities/overview)
## [共通機能](https://code.visualstudio.com/api/extension-capabilities/common-capabilities)（の例）
- コマンド、構成、キーバインド、またはコンテキスト メニュー項目を登録します。
    - `vscode.commands` APIを使用してコマンドを登録および実行します。
    - `contributes.commands` コントリビューション ポイントを使用して、コマンド パレットでコマンドを使用できるようにします。
    - `contributes.configuration` コントリビューション ポイント を使用して拡張機能固有の設定を提供します。
    - `workspace.getConfiguration` API を使用してそれらを読み取ることができます。
    - カスタムキーバインドを追加できます。詳しくは、`contributes.keybindings` と[キーバインド](https://code.visualstudio.com/docs/getstarted/keybindings)のトピックをご覧ください。
    - 右クリックすると表示されるカスタムコンテキストメニュー項目を登録できます。詳しくは、`contributes.menus` コントリビューション ポイント をご覧ください。
- ワークスペースまたはグローバル データの保存。
    - `ExtensionContext.workspaceState`: キーと値のペアを書き込むことができるワークスペースストレージ。VS Code がこのストレージを管理し、同じワークスペースを再度開いたときに復元します。
    - `ExtensionContext.globalState`: キー/値のペアを書き込めるグローバルストレージです。VS Code はこのストレージを管理し、拡張機能のアクティベーションごとに復元します。`globalState` の `setKeysForSync` メソッド のを使って同期対象のキーを設定することで、グローバルストレージ内のキー/値のペアを選択的に同期できます。
    - `ExtensionContext.storageUri`: 拡張機能が読み取り/書き込み権限を持つローカルディレクトリを指す、ワークスペース固有のストレージURI。現在のワークスペースからのみアクセス可能な大きなファイルを保存する必要がある場合に適しています。
    - `ExtensionContext.globalStorageUri`: 拡張機能が読み取り/書き込み権限を持つローカルディレクトリを指すグローバルストレージURI。これは、すべてのワークスペースからアクセスできる大きなファイルを保存する必要がある場合に適したオプションです。
    - `ExtensionContext.secrets`: シークレット（または機密情報）を暗号化して保存するグローバルストレージ。これらの情報はマシン間で同期されません。VS Codeデスクトップ版では、Electron の [safeStorage API](https://www.electronjs.org/docs/latest/api/safe-storage) を活用します。VS Code for the Webでは、Double Key Encryption（DKE）実装を使用します。
- 通知メッセージを表示します。
    - [`window.showInformationMessage`](https://code.visualstudio.com/api/references/vscode-api#window.showInformationMessage)
    - [`window.showWarningMessage`](https://code.visualstudio.com/api/references/vscode-api#window.showWarningMessage)
    - [`window.showErrorMessage`](https://code.visualstudio.com/api/references/vscode-api#window.showErrorMessage)
- クイックピックを使用してユーザー入力を収集します。
    - `vscode.QuickPick` APIを使用すると、ユーザー入力を簡単に収集したり、複数のオプションから選択させたりすることができます。
- システム ファイル ピッカーを開いて、ユーザーがファイルまたはフォルダーを選択できるようにします。
    - `window.showOpenDialog` API を使用してシステム ファイル ピッカーを開き、ファイルまたはフォルダーを選択できます。
- 長時間実行される操作を示すには、Progress API を使用します。
    - `vscode.Progress` APIを使用して、ユーザーに進捗状況の更新を報告できます。

## [テーマ設定](https://code.visualstudio.com/api/extension-capabilities/theming)（の例）
- ソースコードの色を変更します。
    - `tokenColors` は、エディタ内でのハイライト表示の色とスタイルを定義します。このトピックに関する詳細は、[構文ハイライトガイド](https://code.visualstudio.com/api/language-extensions/syntax-highlight-guide)をご覧ください。
    - `semanticTokenColors` マッピングと `semanticHighlighting` 設定により、エディターでのハイライト表示を強化できます。[セマンティックハイライトガイド](https://code.visualstudio.com/api/language-extensions/semantic-highlight-guide)では、関連するAPIについて説明しています。
- VS Code UI の色を変更します。
    - UI コンポーネントの色を制御する `colors` マッピング。
- 既存の TextMate テーマを VS Code に移植します。
- カスタム ファイル アイコンを追加します。
    - 一意のファイル アイコン識別子から画像またはフォント アイコンへのマッピングを作成します。
    - ファイル名またはファイル言語の種類によって、ファイルをこれらの一意のファイル アイコン識別子に関連付けます。

## 宣言型言語機能（の例）
- 一般的な JavaScript スニペットを拡張機能にバンドルします。
- VS Code に新しいプログラミング言語について伝えます。
- プログラミング言語の文法を追加または置き換えます。
- 文法注入を使用して既存の文法を拡張します。
- 既存の TextMate 文法を VS Code に移植します。

## プログラム言語機能（の例）
- API の使用例を表示するホバーを追加します。
- 診断を使用して、ソース コード内のスペルまたはリンター エラーを報告します。
- HTML 用の新しいコード フォーマッタを登録します。
- 豊富でコンテキストに応じた IntelliSense を提供します。
- 言語に折りたたみ、パンくずリスト、アウトラインのサポートを追加します。

## [ワークベンチ拡張機能](https://code.visualstudio.com/api/extension-capabilities/extending-workbench)（の例）
- ファイル エクスプローラーにカスタム コンテキスト メニュー アクションを追加します。
- サイド バーに新しいインタラクティブな TreeView を作成します。
    - [`contributes.views`](https://code.visualstudio.com/api/references/contribution-points#contributes.views) コントリビューションポイントを使用すると、任意のビューコンテナに表示される新しいビューを追加できます。
- 新しいアクティビティ バー ビューを定義します。
- ステータス バーに新しい情報を表示します。
    - [StatusBarItem](https://code.visualstudio.com/api/references/vscode-api#StatusBarItem) 拡張機能は、ステータスバーに表示されるカスタム項目を作成できます。
- WebView APIを使用してカスタム コンテンツをレンダリングします。
    - Webview は、HTML/CSS/JavaScript で構築された高度にカスタマイズ可能なビューです。エディターグループ領域では、テキストエディターの横に表示されます。Webview の詳細については、[Webview ガイド](https://code.visualstudio.com/api/extension-guides/webview)をご覧ください。
- ソース管理プロバイダーに貢献します。

## デバッグ（の例）
- デバッグ アダプターの実装を提供することで、VS Code のデバッグ UI をデバッガーまたはランタイムに接続します。
- デバッガー拡張機能でサポートされる言語を指定します。
- デバッガーによって使用されるデバッグ構成属性に関する豊富な IntelliSense とホバー情報を提供します。
- デバッグ構成スニペットを提供します。

- 動的に作成されたデバッグ構成に基づいてデバッグ セッションを開始します。
- デバッグ セッションのライフサイクルを追跡します。
- プログラムでブレークポイントを作成および管理します。

## 制限
- 拡張機能はVS Code UIのDOMにアクセスできません。
- ユーザーまたは拡張機能によって提供されるカスタム スタイル シートは、DOM 構造とクラス名に対して機能します。

# Get Started（もしくは Hello world）
## [Your First Extension](https://code.visualstudio.com/api/get-started/your-first-extension)
### 事前準備
git と node をインストールします。今回は Windows でやるので、[git for Windows](https://gitforwindows.org/) と [nvm-windows](https://github.com/coreybutler/nvm-windows) を入れます。

nvm は、git bash で以下のようにして、node や npm や npx が使えるようにします。
```
$ nvm install lts
Downloading node.js version 22.20.0 (64-bit)... 
Extracting node and npm...
Complete
Installation complete.
If you want to use this version, type:

nvm use 22.20.0

$ nvm use 22.20.0
Now using node v22.20.0 (64-bit)
```

### VSCode拡張プロジェクト構築
サイトに書いてあるとおりですが、
```
$ npx --package yo --package generator-code -- yo code

     _-----_     ╭──────────────────────────╮
    |       |    │   Welcome to the Visual  │
    |--(o)--|    │   Studio Code Extension  │
   `---------´   │        generator!        │
    ( _´U`_ )    ╰──────────────────────────╯
    /___A___\   /
     |  ~  |
   __'.___.'__
 ´   `  |° ´ Y `

? What type of extension do you want to create? (Use arrow keys)
❯ New Extension (TypeScript)
  New Extension (JavaScript)
  New Color Theme
  New Language Support
  New Code Snippets
  New Keymap
  New Extension Pack
  New Language Pack (Localization)
  New Web Extension (TypeScript)
  New Notebook Renderer (TypeScript) 
```
こんな感じで止まるので、選択肢や入力候補の出てるやつは、以下のようになるように `Enter` していきます。
```
? What type of extension do you want to create? New Extension (TypeScript)
? What's the name of your extension? HelloWorld
? What's the identifier of your extension? helloworld
? What's the description of your extension? 
? Initialize a git repository? Yes
? Which bundler to use? unbundled
? Which package manager to use? npm

Writing in C:\Users\araki\workspace\vscode-ext\helloworld...
   create helloworld\.vscode\extensions.json
   create helloworld\.vscode\launch.json
   create helloworld\.vscode\settings.json
   create helloworld\.vscode\tasks.json
   create helloworld\package.json
   create helloworld\tsconfig.json
   create helloworld\.vscodeignore
   create helloworld\vsc-extension-quickstart.md
   create helloworld\.gitignore
   create helloworld\README.md
   create helloworld\CHANGELOG.md
   create helloworld\src\extension.ts
   create helloworld\src\test\extension.test.ts
   create helloworld\.vscode-test.mjs
   create helloworld\eslint.config.mjs

Changes to package.json were detected.

Running npm install for you to install the required dependencies.
npm warn deprecated inflight@1.0.6: This module is not supported, and leaks memory. Do not use it. Check out lru-cache if you want a good and tested way to coalesce async requests by a key value, which is much more comprehensive and powerful.
npm warn deprecated glob@7.2.3: Glob versions prior to v9 are no longer supported

added 259 packages, and audited 260 packages in 35s

74 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities

Your extension helloworld has been created!

To start editing with Visual Studio Code, use the following commands:

     code helloworld

Open vsc-extension-quickstart.md inside the new extension for further instructions
on how to modify, test and publish your extension.

For more information, also visit http://code.visualstudio.com and follow us @code.


? Do you want to open the new folder with Visual Studio Code? Open with `code`
```
最後で `Opwn with code` と VSCode が helloworld フォルダを開いて起動します。起動した VSCode で `src/extension.ts` を開いて、デバックパネルでデバック実行 `Run Extension` します。そうすると、もう一つ VSCode が Hello World 拡張入りで起動しますので、`Shift + Ctrl + P` から `Hello World` を選びます。

![](/images/a8ef580909c553/hello.png)

サイトの記載は、そうすると、こうなりますよ。という意味です。

![](/images/a8ef580909c553/hello2.png)

メッセージの変更はコピペすれば OK。`Developer: Reload Window` は、現時点では、`Developer: Reload Webview`（開発者：Webビューの再読み込み）になっていました。

## [Extension Anatomy](https://code.visualstudio.com/api/get-started/extension-anatomy)

## [Wrapping Up](https://code.visualstudio.com/api/get-started/wrapping-up)

# [拡張ガイド](https://code.visualstudio.com/api/extension-guides/overview)

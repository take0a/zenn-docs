---
title: "Golangã§PostgreSQLï¼ˆãã®ï¼‘ï¼‰"
emoji: "ğŸ˜"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["golang", "sqlx", "sql", "database", "postgresql"]
published: true
publication_name: "robon"
---

# ã¯ã˜ã‚ã«

å…ˆæ—¥ã€Golangã§sqlxã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã®è¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸã€‚

https://zenn.dev/robon/articles/ff2419b7f5a76c

ä»Šå›ã‹ã‚‰ã¯ã€å„ç¨®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚
ã¾ãšã¯ã€å‰å›ã®è¨˜äº‹ã§ã‚‚ä½¿ç”¨ã—ãŸ PostgreSQL ã‹ã‚‰è©•ä¾¡ã—ã¾ã—ãŸã€‚

# PostgreSQL
## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

Amazon RDS ä¸Šã«æ§‹ç¯‰ã—ãŸ PostgreSQL ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

| è¨­å®š | å€¤ |
|---|---|
| ã‚¨ãƒ³ã‚¸ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 13.7 |
| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒ©ã‚¹ | db.t3.micro |
| vCPU | 2 |
| RAM | 1GB |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | 20GiB |

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

Amazon EC2 ã® Amazon Linux 2 ã‹ã‚‰æ¥ç¶šã—ã¾ã™ã€‚

### ãƒ„ãƒ¼ãƒ«

psql ã‚’ä½¿ç”¨ã—ã¾ã™ã®ã§ã€Amazon Linux 2 ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ sudo yum install postgresql
```

## ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«
### ãƒ‡ãƒ¼ã‚¿å‹ã®ä¸€è¦§

ã—ã°ã‚‰ããƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è§¦ã£ã¦ã„ãªã‹ã£ãŸã®ã§ã™ãŒã€ä½•åå¹´ã‚‚å‰ã‹ã‚‰æ¨™æº–åŒ–ã™ã‚‹ã¨è¨€ã„ã¤ã¤ã€ç›¸å¤‰ã‚ã‚‰ãšæ–¹è¨€ãŒã„ã£ã±ã„ğŸ˜…ã§ã™ã€‚[ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://www.postgresql.jp/document/9.3/html/datatype.html) ã‹ã‚‰æŠœç²‹ã—ã¾ã™ã€‚

| åç§° | åˆ¥å | èª¬æ˜ |
|------|-----|------|
| bigint | int8 | 8ãƒã‚¤ãƒˆç¬¦å·ä»˜ãæ•´æ•° |
| bigserial | serial8 | è‡ªå‹•å¢—åˆ†8ãƒã‚¤ãƒˆæ•´æ•° |
| bit [ (n) ] |   | å›ºå®šé•·ãƒ“ãƒƒãƒˆåˆ— |
| bit varying [ (n) ] | varbit | å¯å¤‰é•·ãƒ“ãƒƒãƒˆåˆ— |
| boolean | bool | è«–ç†å€¤ï¼ˆçœŸ/å½ï¼‰ |
| box |   | å¹³é¢ä¸Šã®çŸ©å½¢ |
| bytea |   | ãƒã‚¤ãƒŠãƒªãƒ‡ãƒ¼ã‚¿ï¼ˆ"ãƒã‚¤ãƒˆã®é…åˆ—ï¼ˆbyte arrayï¼‰"ï¼‰ |
| character varying [ (n) ] | varchar [ (n) ] | å¯å¤‰é•·æ–‡å­—åˆ— |
| character [ (n) ] | char [ (n) ] | å›ºå®šé•·æ–‡å­—åˆ— |
| cidr |   | IPv4ã‚‚ã—ãã¯IPv6ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| circle |   | å¹³é¢ä¸Šã®å†† |
| date |   | æš¦ã®æ—¥ä»˜ï¼ˆå¹´æœˆæ—¥ï¼‰ |
| double precision | float8 | å€ç²¾åº¦æµ®å‹•å°æ•°ç‚¹ï¼ˆ8ãƒã‚¤ãƒˆï¼‰ |
| inet |   | IPv4ã‚‚ã—ãã¯IPv6ãƒ›ã‚¹ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ |
| integer | int, int4 | 4ãƒã‚¤ãƒˆç¬¦å·ä»˜ãæ•´æ•° |
| interval [ fields ] [ (p) ] |   | æ™‚é–“é–“éš” |
| json |   | JSONãƒ‡ãƒ¼ã‚¿ |
| line |   | å¹³é¢ä¸Šã®ç„¡é™ç›´ç·š |
| lseg |   | å¹³é¢ä¸Šã®ç·šåˆ† |
| macaddr |   | MACï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| money |   | è²¨å¹£é‡‘é¡ |
| numeric [ (p, s) ] | decimal [ (p, s) ] | ç²¾åº¦ã®é¸æŠå¯èƒ½ãªé«˜ç²¾åº¦æ•°å€¤ |
| path |   | å¹³é¢ä¸Šã®å¹¾ä½•å­¦çš„çµŒè·¯ |
| point |   | å¹³é¢ä¸Šã®å¹¾ä½•å­¦çš„ç‚¹ |
| polygon |   | å¹³é¢ä¸Šã®é–‰ã˜ãŸå¹¾ä½•å­¦çš„çµŒè·¯ |
| real | float4 | å˜ç²¾åº¦æµ®å‹•å°æ•°ç‚¹ï¼ˆ4ãƒã‚¤ãƒˆï¼‰ |
| smallint | int2 | 2ãƒã‚¤ãƒˆç¬¦å·ä»˜ãæ•´æ•° |
| smallserial | serial2 | è‡ªå‹•å¢—åˆ†2ãƒã‚¤ãƒˆæ•´æ•° |
| serial | serial4 | è‡ªå‹•å¢—åˆ†4ãƒã‚¤ãƒˆæ•´æ•° |
| text |   | å¯å¤‰é•·æ–‡å­—åˆ— |
| time [ (p) ] [ without time zone ] |   | æ™‚åˆ»ï¼ˆæ™‚é–“å¸¯ãªã—ï¼‰ |
| time [ (p) ] with time zone | timetz | æ™‚é–“å¸¯ä»˜ãæ™‚åˆ» |
| timestamp [ (p) ] [ without time zone ] |   | æ—¥ä»˜ã¨æ™‚åˆ»ï¼ˆæ™‚é–“å¸¯ãªã—ï¼‰ |
| timestamp [ (p) ] with time zone | timestamptz | æ™‚é–“å¸¯ä»˜ãæ—¥ä»˜ã¨æ™‚åˆ» |
| tsquery |   | ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢å•ã„åˆã‚ã› |
| tsvector |   | ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢æ–‡æ›¸ |
| txid_snapshot |   | ãƒ¦ãƒ¼ã‚¶ãƒ¬ãƒ™ãƒ«ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³IDã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ |
| uuid |   | æ±ç”¨ä¸€æ„è­˜åˆ¥å­ |
| xml |   | XMLãƒ‡ãƒ¼ã‚¿ |

### ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«

ãã®ã¾ã¾ CREATE TABLEæ–‡ã«ã—ã¾ã™ã€‚

```sql
CREATE TABLE datatypes (
    col01 bigint,
    col02 bigserial,
    col03 bit(1),
    col04 varbit(1),
    col05 boolean,
    col06 box,
    col07 bytea,
    col08 varchar(10),
    col09 character(10),
    col10 cidr,
    col11 circle,
    col12 date,
    col13 float8,
    col14 inet,
    col15 integer,
    col16 interval,
    col17 json,
    col18 line,
    col19 lseg,
    col20 macaddr,
    col21 money,
    col22 numeric(10,4),
    col23 path,
    col24 point,
    col25 polygon,
    col26 real,
    col27 smallint,
    col28 smallserial,
    col29 serial,
    col30 text,
    col31 time,
    col32 timetz,
    col33 timestamp,
    col34 timestamptz,
    col35 tsquery,
    col36 tsvector,
    col37 txid_snapshot,
    col38 uuid,
    col39 xml,
    CONSTRAINT pk_datatypes PRIMARY KEY(col01)
);
```

# Golang
## å‡¦ç†ç³»
```bash
$ go version
go version go1.18.6 linux/amd64
```

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

github.com/lib/pq ã® v1.10.9 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‹ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚ˆã†ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚

> Parameters pass through driver.DefaultParameterConverter before they are handled by this package. When the binary_parameters connection option is enabled, []byte values are sent directly to the backend as data in binary format.
>
> This package returns the following types for values from the PostgreSQL backend:
> 
> ãƒ»integer types smallint, integer, and bigint are returned as int64
> ãƒ»floating-point types real and double precision are returned as float64
> ãƒ»character types char, varchar, and text are returned as string
> ãƒ»temporal types date, time, timetz, timestamp, and timestamptz are returned as time.Time
> ãƒ»the boolean type is returned as bool
> ãƒ»the bytea type is returned as []byte
> 
> All other types are returned directly from the backend as []byte values in text format.

https://pkg.go.dev/github.com/lib/pq#hdr-Data_Types

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦å…¥å‡ºåŠ›ã‚’è¡Œã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚æ­¯æŠœã‘ã®çŠ¶æ…‹ã‹ã‚‰å¾ã€…ã«åŸ‹ã‚ã¦ã„ã‘ã‚‹ã‚ˆã†ã«ã€Nullable å‹ã§å…¥å‡ºåŠ›ã—ã¾ã™ã€‚

```go: main.go
package main

import (
	"database/sql"
	"log"
	"math"
	"os"
	"reflect"
	"time"

	"github.com/google/go-cmp/cmp"
	"github.com/jmoiron/sqlx"
	_ "github.com/lib/pq"
)

// Datatypes ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
type Datatypes struct {
	Col01 sql.NullInt64   `db:"col01"` // bigint
	Col02 sql.NullString  `db:"col02"` // bigserial
	Col03 sql.NullString  `db:"col03"` // bit(1)
	Col04 sql.NullString  `db:"col04"` // varbit(1)
	Col05 sql.NullBool    `db:"col05"` // boolean
	Col06 sql.NullString  `db:"col06"` // box
	Col07 []byte          `db:"col07"` // bytea
	Col08 sql.NullString  `db:"col08"` // varchar(10)
	Col09 sql.NullString  `db:"col09"` // character(10)
	Col10 sql.NullString  `db:"col10"` // cidr
	Col11 sql.NullString  `db:"col11"` // circle
	Col12 sql.NullTime    `db:"col12"` // date
	Col13 sql.NullFloat64 `db:"col13"` // float8
	Col14 sql.NullString  `db:"col14"` // inet
	Col15 sql.NullInt64   `db:"col15"` // integer
	Col16 sql.NullString  `db:"col16"` // interval
	Col17 sql.NullString  `db:"col17"` // json
	Col18 sql.NullString  `db:"col18"` // line
	Col19 sql.NullString  `db:"col19"` // lseg
	Col20 sql.NullString  `db:"col20"` // macaddr
	Col21 sql.NullString  `db:"col21"` // money
	Col22 sql.NullString  `db:"col22"` // numeric(10,4)
	Col23 sql.NullString  `db:"col23"` // path
	Col24 sql.NullString  `db:"col24"` // point
	Col25 sql.NullString  `db:"col25"` // polygon
	Col26 sql.NullFloat64 `db:"col26"` // real
	Col27 sql.NullInt64   `db:"col27"` // smallint
	Col28 sql.NullString  `db:"col28"` // smallserial
	Col29 sql.NullString  `db:"col29"` // serial
	Col30 sql.NullString  `db:"col30"` // text
	Col31 sql.NullTime    `db:"col31"` // time
	Col32 sql.NullTime    `db:"col32"` // timetz
	Col33 sql.NullTime    `db:"col33"` // timestamp
	Col34 sql.NullTime    `db:"col34"` // timestamptz
	Col35 sql.NullString  `db:"col35"` // tsquery
	Col36 sql.NullString  `db:"col36"` // tsvector
	Col37 sql.NullString  `db:"col37"` // txid_snapshot
	Col38 sql.NullString  `db:"col38"` // uuid
	Col39 sql.NullString  `db:"col39"` // xml
}

// Key ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚­ãƒ¼
type Key struct {
	Col01 int64 `db:"col01"`
}

func main() {
	dsn := os.Getenv("DSN")
	db, err := sqlx.Open("postgres", dsn)
	if err != nil {
		log.Printf("sql.Open error %s", err)
	}

	JST, _ := time.LoadLocation("Asia/Tokyo")
	key := Key{1}
	src := Datatypes{
		Col01: sql.NullInt64{Int64: 1, Valid: true},
		Col02: sql.NullString{String: "1", Valid: true}, // bigserial not null
		Col03: sql.NullString{String: "0", Valid: true},
		Col04: sql.NullString{String: "1", Valid: true},
		Col05: sql.NullBool{Bool: true, Valid: true},
		Col06: sql.NullString{String: "(1,1),(0,0)", Valid: true},
		Col07: []byte{1, 2, 3}, // select çµæœã¯ nil ã§ãªã empty
		Col08: sql.NullString{String: "varchar", Valid: true},
		Col09: sql.NullString{String: "character ", Valid: true}, // space padding
		Col10: sql.NullString{String: "192.168.1.0/24", Valid: true},
		Col11: sql.NullString{String: "<(0,0),1>", Valid: true},
		Col12: sql.NullTime{Time: time.Date(2001, 2, 3, 0, 0, 0, 0, time.UTC), Valid: true},
		Col13: sql.NullFloat64{Float64: 1.5, Valid: true},
		Col14: sql.NullString{String: "192.168.1.1", Valid: true},
		Col15: sql.NullInt64{Int64: math.MaxInt32, Valid: true},
		Col16: sql.NullString{String: "1 year", Valid: true},
		Col17: sql.NullString{String: `{"key":1}`, Valid: true},
		Col18: sql.NullString{String: "{1,2,3}", Valid: true},
		Col19: sql.NullString{String: "[(1,1),(0,0)]", Valid: true},
		Col20: sql.NullString{String: "08:00:2b:01:02:03", Valid: true},
		Col21: sql.NullString{String: "$123.45", Valid: true},
		Col22: sql.NullString{String: "123456.1234", Valid: true},
		Col23: sql.NullString{String: "[(1,1),(0,0)]", Valid: true},
		Col24: sql.NullString{String: "(1,2)", Valid: true},
		Col25: sql.NullString{String: "((1,2),(0,0))", Valid: true},
		Col26: sql.NullFloat64{Float64: 1.25, Valid: true},
		Col27: sql.NullInt64{Int64: math.MinInt16, Valid: true},
		Col28: sql.NullString{String: "2", Valid: true}, // smallserial not null
		Col29: sql.NullString{String: "3", Valid: true}, // serial not null
		Col30: sql.NullString{String: "text", Valid: true},
		Col31: sql.NullTime{Time: time.Date(0, 1, 1, 1, 2, 3, 4000000, time.UTC), Valid: true},
		Col32: sql.NullTime{Time: time.Date(0, 1, 1, 1, 2, 3, 4000000, JST), Valid: true},
		Col33: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000000, time.UTC), Valid: true},
		Col34: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000000, JST), Valid: true},
		Col35: sql.NullString{String: "'super':*", Valid: true},
		Col36: sql.NullString{String: "'Fat' 'Rats' 'The'", Valid: true},
		Col37: sql.NullString{String: "10:20:10,14,15", Valid: true},
		Col38: sql.NullString{String: "a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11", Valid: true},
		Col39: sql.NullString{String: "<xml /><root></root>", Valid: true},
	}

	_, err = db.NamedExec(`
		INSERT INTO datatypes (
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15, col16, col17, col18, col19, col20,
			col21, col22, col23, col24, col25, col26, col27, col28, col29, col30,
			col31, col32, col33, col34, col35, col36, col37, col38, col39
		) VALUES (
			:col01, :col02, :col03, :col04, :col05, :col06, :col07, :col08, :col09, :col10,
			:col11, :col12, :col13, :col14, :col15, :col16, :col17, :col18, :col19, :col20,
			:col21, :col22, :col23, :col24, :col25, :col26, :col27, :col28, :col29, :col30,
			:col31, :col32, :col33, :col34, :col35, :col36, :col37, :col38, :col39
		)`,
		src,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}

	dst := Datatypes{}
	query, args, err := db.BindNamed(`
		SELECT 
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15, col16, col17, col18, col19, col20,
			col21, col22, col23, col24, col25, col26, col27, col28, col29, col30,
			col31, col32, col33, col34, col35, col36, col37, col38, col39
		FROM datatypes 
		WHERE col01 = :col01`,
		key,
	)
	if err != nil {
		log.Printf("db.BindNamed error %s", err)
	}
	err = db.QueryRowx(query,
		args...,
	).StructScan(
		&dst,
	)
	if err != nil {
		log.Printf("db.QueryRow error %s", err)
	}
	if !reflect.DeepEqual(src, dst) {
		// log.Printf("\nsrc = %#v\ndst = %#v\n", src, dst)
		diff := cmp.Diff(src, dst)
		if len(diff) > 0 {
			log.Print(diff)
		}
	}

	_, err = db.NamedExec(`
		DELETE FROM datatypes
		WHERE col01 = :col01`,
		key,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}
}
```

# ãŠã‚ã‚Šã«

ãã‚Œãã‚Œã®ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚„ä»•æ§˜ã«å¾“ã£ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚ãŸã ã—ã€é€šè²¨å˜ä½ã‚„ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã«ã¤ã„ã¦ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šã«ã‚‚ä¾å­˜ã™ã‚‹ã‚ˆã†ãªã®ã§ã€å‡ºåŠ›ã®æœŸå¾…å€¤ã¯ä¸Šè¨˜ã¨ã¯ç•°ãªã‚‹å ´åˆãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ã€‚

æ—¥æœ¬èªã«ã¤ã„ã¦ã¯ã€åˆ¥é€”ã€ãƒ†ã‚¹ãƒˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

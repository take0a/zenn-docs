---
title: "Golangã§SQLServerï¼ˆãã®ï¼‘ï¼‰"
emoji: "ğŸ¦¡"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["golang", "sqlx", "sql", "database", "sqlserver"]
published: true
publication_name: "robon"
---
# ã¯ã˜ã‚ã«

å‰å›ã¯ã€Golang ã§ Oracle ã®å„ç¨®ãƒ‡ãƒ¼ã‚¿å‹ã®å…¥å‡ºåŠ›ã‚’æ¤œè¨¼ã—ã¾ã—ãŸã€‚

https://zenn.dev/robon/articles/9ab6cb9e1b9d1c

ä»Šå›ã¯ã€Microsoft ã® SQLServer ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

# SQLServer
## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

Amazon RDS ä¸Šã«æ§‹ç¯‰ã—ãŸ SQLServer ã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

| è¨­å®š | å€¤ |
|---|---|
| ã‚¨ãƒ³ã‚¸ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | 15.00.4236.7.v1 |
| æ—¥æœ¬èª | SQL_Latin1_General_CP1_CI_AS |
| ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¯ãƒ©ã‚¹ | db.t3.small |
| vCPU | 2 |
| RAM | 2GB |
| ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ | 20GiB |

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

Amazon EC2 ã® Amazon Linux 2 ã‹ã‚‰æ¥ç¶šã—ã¾ã™ã€‚

### ãƒ„ãƒ¼ãƒ«

sqlcmd ã‚’ä½¿ç”¨ã—ã¾ã™ã®ã§ã€[ãƒã‚¤ã‚¯ãƒ­ã‚½ãƒ•ãƒˆç¤¾ã®ã‚µã‚¤ãƒˆ](https://learn.microsoft.com/ja-jp/sql/linux/sql-server-linux-setup-tools) ã‚’å‚è€ƒã«ã—ã¦å°å…¥ã—ã¾ã™ã€‚

Amazon Linux 2 ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ sudo su
# curl https://packages.microsoft.com/config/rhel/8/prod.repo > /etc/yum.repos.d/msprod.repo
# exit
$ sudo yum install mssql-tools
```

## ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«
### ãƒ‡ãƒ¼ã‚¿å‹ã®ä¸€è¦§

[ãƒãƒ‹ãƒ¥ã‚¢ãƒ«](https://learn.microsoft.com/ja-jp/sql/t-sql/data-types/data-types-transact-sql?view=sql-server-ver16) ã‹ã‚‰æŠœç²‹ã—ã¾ã™ã€‚

| å‹å | ç¯„å›² | å®¹é‡ | èª¬æ˜ |
|---|---|---|---|
| bigint | -2^63ï½2^63-1 | 8byte ||
| int | -2^31ï½2^31-1 | 4byte ||
| smallint | -2^15ï½2^15-1 | 2byte ||
| tinyint | 2^0-1ï½2^8-1 | 1byte ||
| bit | 0, 1, null | 1ï½2byte | 0 ä»¥å¤–ã¯å…¨ã¦ 1 |
| decimal[(p[,s])] | -10^38+1ï½10^38-1 | 5ï½17byte | numericã‚‚åŒã˜ |
| money | -922,337,203,685,477.5808ï½922,337,203,685,477.5807 | 8byte ||
| smallmoney | -214,748.3648ï½214,748.3647 | 4byte ||
| float[(n)] | -1.79E+308ï½-2.23E-308ã€0ã€2.23E-308ï½1.79E+308 | 4 or 8byte ||
| real | -3.40E+38ï½-1.18E-38ã€0ã€1.18E-38ï½3.40E+38 | 4byte | float(24)ã®åˆ¥å |
| date | 0001-01-01ï½9999-12-31 | 3byte | 1900-01-01ãŒè¦å®šå€¤ |
| datetime | 1753-01-01 00:00:00ï½9999-12-31 23:59:59 | 8byte | 1900-01-01 00:00:00 ãŒè¦å®šå€¤ |
| datetime2 | 0001-01-01 00:00:00ï½9999-12-31 23:59:59.9999999 | 6ï½8byte | 1900-01-01 00:00:00 ãŒè¦å®šå€¤ |
| datetimeoffset | 0001-01-01 00:00:00+14:00ï½9999-12-31 23:59:59.9999999-14:00 | 10byte | 1900-01-01 00:00:00 00:00ãŒè¦å®šå€¤ |
| smalldatetime | 1900-01-01 00:00:00ï½2079-06-06 23:59:59 | 4byte | 29.999ç§’ã§åˆ†ã«ä¸¸ã‚ã€‚1900-01-01 00:00:00ãŒè¦å®šå€¤ |
| time | 00:00:00.0000000ï½23:59:59.9999999 | 5byte | 00:00:00ãŒè¦å®šå€¤ |
| char[(n)] | | 1ï½8000byte | å›ºå®šé•·æ–‡å­—åˆ— |
| varchar[(n)] | | 1ï½8000byte | å¯å¤‰é•·æ–‡å­—åˆ— |
| text | | 2^31-1byte | å¯å¤‰é•·æ–‡å­—åˆ— |
| nchar[(n)] | | 1ï½8000byte | n ã¯ 1ï½4000æ–‡å­—ã€‚å›ºå®šé•·æ–‡å­—åˆ— |
| nvarchar[(n\|max)] |  | 1ï½8000byte ã¾ãŸã¯ 2GB | n ã¯ 1ï½4000æ–‡å­—ã€‚å¯å¤‰é•·æ–‡å­—åˆ— |
| ntext | | ï½ 2^30-1byte | å¯å¤‰é•·Unicodeãƒ‡ãƒ¼ã‚¿ |
| binary[(n)] | | 1ï½8000byte | å›ºå®šé•·ãƒã‚¤ãƒŠãƒª |
| varbinary[(n\|max)] || 1ï½8000byte ã¾ãŸã¯ 2^31-1byte | å¯å¤‰é•·ãƒã‚¤ãƒŠãƒª |
| image | | 0ï½2^31-1byte | å¯å¤‰é•·ãƒã‚¤ãƒŠãƒª |
| uniqueidentifier | | 16byte | GUIDã€‚ä¾‹ï¼š6F9619FF-8B86-D011-B42D-00C04FC964FF |
| sql_variant |  | ï½8016byte | ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ä»–ã®å‹ã‚’å…¥ã‚Œã‚‰ã‚Œã‚‹ |
| xml [([CONTENT\|DOCUMENT]xml_schema_collection)] |  | ï½2GB | XMLãƒ‡ãƒ¼ã‚¿ |

### ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«

ãã®ã¾ã¾ CREATE TABLEæ–‡ã«ã—ã¾ã™ã€‚

```sql
CREATE TABLE datatypes (
    col01 bigint,
    col02 int,
    col03 smallint,
    col04 tinyint,
    col05 bit,
    col06 decimal(10,4),
    col07 money,
    col08 smallmoney,
    col09 float(53),
    col10 real,
    col11 date,
    col12 datetime,
    col13 datetime2,
    col14 datetimeoffset,
    col15 smalldatetime,
    col16 time,
    col17 char(10),
    col18 varchar(10),
    col19 text,
    col20 nchar(10),
    col21 nvarchar(10),
    col22 ntext,
    col23 binary(10),
    col24 varbinary(10),
    col25 image,
    col26 uniqueidentifier,
    col27 sql_variant,
    col28 xml,
    CONSTRAINT pk_datatypes PRIMARY KEY(col01)
);
go
```

# Golang
## å‡¦ç†ç³»
```bash
$ go version
go version go1.18.6 linux/amd64
```

## ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

github.com/microsoft/go-mssqldb ã® v0.21.0 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‹ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã®ä»•æ§˜ã§ã¤ãã‚‰ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

https://github.com/microsoft/go-mssqldb/blob/v0.21.0/types.go#L1022-L1590

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«å¯¾ã—ã¦å…¥å‡ºåŠ›ã‚’è¡Œã†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚æ­¯æŠœã‘ã®çŠ¶æ…‹ã‹ã‚‰å¾ã€…ã«åŸ‹ã‚ã¦ã„ã‘ã‚‹ã‚ˆã†ã«ã€Nullable å‹ã§å…¥å‡ºåŠ›ã—ã¾ã™ã€‚

```go: main.go
package main

import (
	"database/sql"
	"log"
	"os"
	"reflect"
	"time"

	"github.com/google/go-cmp/cmp"
	"github.com/jmoiron/sqlx"
	_ "github.com/microsoft/go-mssqldb"
)

// Datatypes ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«
type Datatypes struct {
	Col01 sql.NullInt64   `db:"col01"` // bigint
	Col02 sql.NullInt64   `db:"col02"` // int
	Col03 sql.NullInt64   `db:"col03"` // smallint
	Col04 sql.NullInt64   `db:"col04"` // tinyint
	Col05 sql.NullBool    `db:"col05"` // bit
	Col06 sql.NullString  `db:"col06"` // decimal(10,4)
	Col07 sql.NullString  `db:"col07"` // money
	Col08 sql.NullString  `db:"col08"` // smallmoney
	Col09 sql.NullFloat64 `db:"col09"` // float(53)
	Col10 sql.NullFloat64 `db:"col10"` // real
	Col11 sql.NullTime    `db:"col11"` // date
	Col12 sql.NullTime    `db:"col12"` // datetime
	Col13 sql.NullTime    `db:"col13"` // datetime2
	Col14 sql.NullTime    `db:"col14"` // datetimeoffset
	Col15 sql.NullTime    `db:"col15"` // smalldatetime
	Col16 sql.NullTime    `db:"col16"` // time
	Col17 sql.NullString  `db:"col17"` // char(10)
	Col18 sql.NullString  `db:"col18"` // varchar(10)
	Col19 sql.NullString  `db:"col19"` // text
	Col20 sql.NullString  `db:"col20"` // nchar(10)
	Col21 sql.NullString  `db:"col21"` // nvarchar(10)
	Col22 sql.NullString  `db:"col22"` // ntext
	Col23 []byte          `db:"col23"` // binary(10)
	Col24 []byte          `db:"col24"` // varbinary(10)
	Col25 []byte          `db:"col25"` // image
	Col26 []byte          `db:"col26"` // uniqueidentifier
	// Col27 []byte          `db:"col27"` // sql_variant mssql: Operand type clash: varbinary(max) is incompatible with sql_variant
	Col28 sql.NullString `db:"col28"` // xml
}

// Key ã¯ã€ãƒ‡ãƒ¼ã‚¿å‹ãƒ†ã‚¹ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚­ãƒ¼
type Key struct {
	Col01 int64 `db:"col01"`
}

func main() {
	dsn := os.Getenv("DSN")
	db, err := sqlx.Open("sqlserver", dsn)
	if err != nil {
		log.Printf("sql.Open error %s", err)
	}

	JST, _ := time.LoadLocation("Asia/Tokyo")
	key := Key{1}
	src := Datatypes{
		Col01: sql.NullInt64{Int64: 1, Valid: true},
		Col02: sql.NullInt64{Int64: 2, Valid: true},
		Col03: sql.NullInt64{Int64: 3, Valid: true},
		Col04: sql.NullInt64{Int64: 4, Valid: true},
		Col05: sql.NullBool{Bool: true, Valid: true},
		Col06: sql.NullString{String: "123456.1234", Valid: true},
		Col07: sql.NullString{String: "123456.1234", Valid: true},
		Col08: sql.NullString{String: "123456.1234", Valid: true},
		Col09: sql.NullFloat64{Float64: 1.5, Valid: true},
		Col10: sql.NullFloat64{Float64: 2.125, Valid: true},
		Col11: sql.NullTime{Time: time.Date(2001, 2, 3, 0, 0, 0, 0, time.UTC), Valid: true},
		Col12: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7000000, time.UTC), Valid: true},      // ãƒŸãƒªç§’ã‚ã‚Š
		Col13: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7008000, time.UTC), Valid: true},      // ãƒã‚¤ã‚¯ãƒ­ç§’ã‚ã‚Š
		Col14: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 6, 7008000, JST), Valid: true},           // TZã‚ã‚Š
		Col15: sql.NullTime{Time: time.Date(2001, 2, 3, 4, 5, 0, 0, time.UTC), Valid: true},            // ç§’ä¸¸ã‚
		Col16: sql.NullTime{Time: time.Date(0001, 1, 1, 12, 34, 56, 123456700, time.UTC), Valid: true}, // 0001-01-01å›ºå®šï¼ˆstring ã¯ NGï¼‰
		Col17: sql.NullString{String: "char(10)  ", Valid: true},
		Col18: sql.NullString{String: "varchar", Valid: true},
		Col19: sql.NullString{String: "text", Valid: true},
		Col20: sql.NullString{String: "nchar(10) ", Valid: true},
		Col21: sql.NullString{String: "nvarchar", Valid: true},
		Col22: sql.NullString{String: "ntext", Valid: true},
		Col23: []byte{1, 2, 3, 0, 0, 0, 0, 0, 0, 0}, // æœ«å°¾ã‚¼ãƒ­åŸ‹ã‚
		Col24: []byte{1, 2, 3, 4},
		Col25: []byte{1, 2, 3, 4, 5},
		Col26: []byte{
			0x6F, 0x96, 0x19, 0xFF, 0x8B, 0x86, 0xD0, 0x11, 0xB4, 0x2D,
			0x00, 0xC0, 0x4F, 0xC9, 0x64, 0xFF,
		},
		Col28: sql.NullString{String: "<xml/><root>a</root>", Valid: true},
	}

	_, err = db.NamedExec(`
		INSERT INTO datatypes (
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15, col16, col17, col18, col19, col20,
			col21, col22, col23, col24, col25, col26,        col28
		) VALUES (
			:col01, :col02, :col03, :col04, :col05, :col06, :col07, :col08, :col09, :col10,
			:col11, :col12, :col13, :col14, :col15, :col16, :col17, :col18, :col19, :col20,
			:col21, :col22, :col23, :col24, :col25, :col26,         :col28
		)`,
		src,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}

	dst := Datatypes{}
	query, args, err := db.BindNamed(`
		SELECT 
			col01, col02, col03, col04, col05, col06, col07, col08, col09, col10,
			col11, col12, col13, col14, col15, col16, col17, col18, col19, col20,
			col21, col22, col23, col24, col25, col26,        col28
		FROM datatypes 
		WHERE col01 = :col01`,
		key,
	)
	if err != nil {
		log.Printf("db.BindNamed error %s", err)
	}
	err = db.QueryRowx(query,
		args...,
	).StructScan(
		&dst,
	)
	if err != nil {
		log.Printf("db.QueryRow error %s", err)
	}
	if !reflect.DeepEqual(src, dst) {
		// log.Printf("\nsrc = %#v\ndst = %#v\n", src, dst)
		diff := cmp.Diff(src, dst)
		if len(diff) > 0 {
			log.Print(diff)
		}
	}

	_, err = db.NamedExec(`
		DELETE FROM datatypes
		WHERE col01 = :col01`,
		key,
	)
	if err != nil {
		log.Printf("db.Exec error %s", err)
	}
}
```

# ãŠã‚ã‚Šã«

ã“ã®ãƒ‰ãƒ©ã‚¤ãƒã§ã¯ã€SQLServer ã® time ãŒ time.Time ã«å‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€0001-01-01 ãŒæ—¥ä»˜éƒ¨ã®è¦å®šå€¤ã¨ã—ã¦å…¥ã‚Šã¾ã™ã€‚ãŸã¨ãˆã°ã€JSON Schema ã® time ã¯ã€æ™‚åˆ»éƒ¨ã ã‘ãªã®ã§ã€SQLServer ã® time å‹ã®å…¥å‡ºåŠ›ã«å¯¾å¿œã§ãã‚‹ãƒ‡ãƒ¼ã‚¿å‹ã‚’ç”¨æ„ã™ã‚‹ã¨ä½¿ã„ã‚„ã™ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

æ—¥æœ¬èªã«ã¤ã„ã¦ã¯ã€åˆ¥é€”ã€ãƒ†ã‚¹ãƒˆã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

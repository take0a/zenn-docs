---
title: "Golangã§RESTï¼ˆãã®ï¼’ï¼‰"
emoji: "ğŸƒâ€â™€ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["golang", "rest", "postgresql", "gochi"]
published: false
publication_name: "robon"
---

# å‰å›ã¯

https://zenn.dev/robon/articles/af7b1b18427e50

å…¨ä½“ã®è¨­è¨ˆæ–¹é‡ã¨Dtoã€Entityã¨ã„ã£ãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã€Daoã«ã‚ˆã‚‹SQLã®å®Ÿè¡Œéƒ¨åˆ†ã¾ã§èª¬æ˜ã—ã¾ã—ãŸã€‚

# å®Ÿè£…ã®ç¶šã
## Service

Serviceã¯ã€ControllerãŒæ‰±ã†Dtoã¨DaoãŒæ‰±ã†Entityé–“ã®å¯¾å¿œã‚’è¡Œã„ã¾ã™ã€‚ã¾ãŸã€Dtoã‚’æ§‹æˆã™ã‚‹EntityãŒè¤‡æ•°ç¨®é¡ã‚ã‚‹å ´åˆã¯ã€ãã‚Œãã‚Œã®Entityã«å¯¾å¿œã™ã‚‹Daoã‚’ãã‚Œãã‚Œå‘¼ã³å‡ºã—ã¾ã™ã€‚

```go: module/customers/service.go
package customers

import (
	"context"
	"database/sql"
)

// Service ã¯ã€Contorller ã‹ã‚‰ã®è¦æ±‚ã‚’ Dao ã‚’ä½¿ç”¨ã—ã¦è§£æ±ºã™ã‚‹ã€‚
type Service struct {
	dao *Dao
}

// NewService ã¯ã€Service ã‚’ç”Ÿæˆã™ã‚‹ã€‚
func NewService() *Service {
	return &Service{
		dao: &Dao{},
	}
}

// Create ã¯ã€æŒ‡å®šã•ã‚ŒãŸ Dto ã‚’ç™»éŒ²ã™ã‚‹ã€‚
func (s *Service) Create(ctx context.Context, tx *sql.Tx, dto *Dto) (*Dto, error) {
	entity := NewEntity(dto)
	entity, err := s.dao.Insert(ctx, tx, entity)
	if err != nil {
		return nil, err
	}
	return NewDto(entity), nil
}

// Read ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã® Dto ã‚’è¿”ã™ã€‚
func (s *Service) Read(ctx context.Context, tx *sql.Tx, key *Key) (*Dto, error) {
	entity, err := s.dao.Select(ctx, tx, key)
	if err != nil {
		return nil, err
	}
	return NewDto(entity), nil
}

// Update ã¯ã€æŒ‡å®šã•ã‚ŒãŸ Dto ã‚’æ›´æ–°ã™ã‚‹ã€‚
func (s *Service) Update(ctx context.Context, tx *sql.Tx, dto *Dto) (*Dto, error) {
	entity := NewEntity(dto)
	entity, err := s.dao.Update(ctx, tx, entity)
	if err != nil {
		return nil, err
	}
	return NewDto(entity), nil
}

// Delete ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã® Dto ã‚’å‰Šé™¤ã™ã‚‹ã€‚
func (s *Service) Delete(ctx context.Context, tx *sql.Tx, key *Key) error {
	return s.dao.Delete(ctx, tx, key)
}
```

ä¸Šä½ã§ä½œã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆcontext.Contextï¼‰ã¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆsql.Txï¼‰ã‚’Daoã«æ¸¡ã™ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## Contoroller

Controllerã¯ã€HTTPã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å…¥å‡ºåŠ›ã¨ã—ã¦ã€ã“ã‚Œã‚’Golangã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚ã‚‹Dtoã«å¯¾å¿œä»˜ã‘ã¾ã™ã€‚Controllerã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã¨ãªã‚‹ã‚ˆã†ã«ã€ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹ã¨çµ‚äº†ã‚’è¡Œã„ã¾ã™ã€‚

```go: module/customers/controller.go
package customers

import (
	"database/sql"
	"fmt"
	"net/http"
	"strconv"

	"github.com/go-chi/chi/v5"
	"github.com/go-chi/render"
	"github.com/take0a/go-rest-sample/utils"
)

// Controller ã¯ã€RESTå‘¼ã³å‡ºã—ã‚’å‡¦ç†ã™ã‚‹ã€‚
type Controller struct {
	db      *sql.DB
	service *Service
}

// NewController ã¯ã€Controller ã‚’ç”Ÿæˆã™ã‚‹ã€‚
func NewController(db *sql.DB) *Controller {
	return &Controller{
		db:      db,
		service: NewService(),
	}
}

// Get ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’è¿”ã™ã€‚
func (c *Controller) Get(w http.ResponseWriter, r *http.Request) {
	param := chi.URLParam(r, "customerId")
	id, err := strconv.Atoi(param)
	if err != nil {
		utils.BadRequest(w, err, fmt.Sprintf("Invalid URL Parameter %s", param))
		return
	}

	ctx := r.Context()
	tx, err := c.db.BeginTx(ctx, nil)
	if err != nil {
		utils.ServerError(w, err, "BeginTx")
		return
	}
	defer tx.Rollback()

	dto, err := c.service.Read(ctx, tx, &Key{CustomerID: id})
	if err != nil {
		if err == sql.ErrNoRows {
			utils.NotFound(w, err, fmt.Sprintf("Invalid URL Parameter %s", param))
		} else {
			utils.ServerError(w, err, "service.Find")
		}
		return
	}

	render.JSON(w, r, dto)
	tx.Commit()
}

// Post ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’ä¿å­˜ã™ã‚‹ã€‚
func (c *Controller) Post(w http.ResponseWriter, r *http.Request) {
	var dto Dto
	err := render.DecodeJSON(r.Body, &dto)
	if err != nil {
		utils.BadRequest(w, err, "render.DecodeJSON")
		return
	}

	ctx := r.Context()
	tx, err := c.db.BeginTx(ctx, nil)
	if err != nil {
		utils.ServerError(w, err, "BeginTx")
		return
	}
	defer tx.Rollback()

	res, err := c.service.Create(ctx, tx, &dto)
	if err != nil {
		if err == utils.ErrConflict {
			utils.Conflict(w, err, "serice.Insert")
		} else {
			utils.ServerError(w, err, "service.Insert")
		}
		return
	}

	render.JSON(w, r, res)
	tx.Commit()
}

// Put ã¯ã€æŒ‡å®šã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°ã™ã‚‹ã€‚
func (c *Controller) Put(w http.ResponseWriter, r *http.Request) {
	param := chi.URLParam(r, "customerId")
	id, err := strconv.Atoi(param)
	if err != nil {
		utils.BadRequest(w, err, fmt.Sprintf("Invalid URL Parameter %s", param))
		return
	}

	var dto Dto
	err = render.DecodeJSON(r.Body, &dto)
	if err != nil {
		utils.BadRequest(w, err, "render.DecodeJSON")
		return
	}
	if id != dto.Key().CustomerID {
		utils.BadRequest(w, err, fmt.Sprintf("Unmatch URL Parameter %s", param))
		return
	}

	ctx := r.Context()
	tx, err := c.db.BeginTx(ctx, nil)
	if err != nil {
		utils.ServerError(w, err, "BeginTx")
		return
	}
	defer tx.Rollback()

	res, err := c.service.Update(ctx, tx, &dto)
	if err != nil {
		utils.ServerError(w, err, "service.Insert")
		return
	}

	render.JSON(w, r, res)
	tx.Commit()
}

// Delete ã¯ã€æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã€‚
func (c *Controller) Delete(w http.ResponseWriter, r *http.Request) {
	param := chi.URLParam(r, "customerId")
	id, err := strconv.Atoi(param)
	if err != nil {
		utils.BadRequest(w, err, fmt.Sprintf("Invalid URL Parameter %s", param))
		return
	}

	ctx := r.Context()
	tx, err := c.db.BeginTx(ctx, nil)
	if err != nil {
		utils.ServerError(w, err, "BeginTx")
		return
	}
	defer tx.Rollback()

	err = c.service.Delete(ctx, tx, &Key{CustomerID: id})
	if err == sql.ErrNoRows {
		utils.NotFound(w, err, fmt.Sprintf("Invalid URL Parameter %s", param))
		return
	}
	if err != nil {
		utils.ServerError(w, err, "service.Delete")
		return
	}
	w.WriteHeader(http.StatusOK)
	tx.Commit()
}
```

utilsã¯ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®ãƒ­ã‚°å‡ºåŠ›ã¨ã‚¨ãƒ©ãƒ¼ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚æœ€å¾Œã«å…¨ä½“ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’å…¬é–‹ã—ã¾ã™ã®ã§ã€æ°—ã«ãªã‚‹æ–¹ã¯ãã¡ã‚‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## Router

Routerã¯ã€RESTãƒªã‚½ãƒ¼ã‚¹æ¯ã®å®Ÿè£…ã®é ‚ç‚¹ã«ãªã‚Šã¾ã™ã€‚ã¨ã„ã£ã¦ã‚‚ã€go-chiã®Routerã«Contorollerã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ç´ã¥ã‘ã¦ã„ã‚‹ã ã‘ã§ã™ã€‚

```go: module/customers/router.go
package customers

import (
	"database/sql"

	"github.com/go-chi/chi/v5"
)

// NewRouter ã¯ã€ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ãƒ«ãƒ¼ã‚¿ãƒ¼ã‚’ç”Ÿæˆã™ã‚‹ã€‚
func NewRouter(db *sql.DB) chi.Router {
	r := chi.NewRouter()
	c := NewController(db)

	r.Get("/{customerId}", c.Get)
	r.Post("/", c.Post)
	r.Put("/{customerId}", c.Put)
	r.Delete("/{customerId}", c.Delete)

	return r
}
```

# æ¬¡å›ã¯

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

https://zenn.dev/robon/articles/af0dd9608ff4e7

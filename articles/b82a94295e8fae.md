---
title: "dlt入門"
emoji: "🔗"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["python", "dlt", "uv", "duckdb"]
published: false
publication_name: "robon"
---

# はじめに

# やってみる

## [インストール](https://dlthub.com/docs/reference/installation)

uv でプロジェクトを作って、インストールします。

```
$ uv init
Initialized project `dlt-getting-started`
$ uv venv
Using CPython 3.12.9
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ uv add dlt[duckdb]
Resolved 50 packages in 566ms
Prepared 30 packages in 164ms
Installed 43 packages in 46ms
:
 + urllib3==2.3.0
$ uv run dlt --version
dlt 1.9.0
```

## [REST API](https://dlthub.com/docs/tutorial/rest-api)

uv のワークスペースのメンバーとしてプロジェクトを作成します。

```
$ uv init rest-api
Adding `rest-api` as member of workspace `/home/ec2-user/work/mds/dlt-getting-started`
Initialized project `rest-api` at `/home/ec2-user/work/mds/dlt-getting-started/rest-api`
$ cd rest-api
$ uv venv
Using CPython 3.12.9
Creating virtual environment at: .venv
Activate with: source .venv/bin/activate
$ uv run dlt --version
dlt 1.9.0
```

`dlt init` します。途中の質問は `Y` で続行します。

```
$ uv run dlt init rest_api duckdb
Creating a new pipeline with the dlt core source rest_api (Generic API Source)
NOTE: Beginning with dlt 1.0.0, the source rest_api will no longer be copied from the verified sources repo but imported from dlt.sources. You can provide the --eject flag to revert to the old behavior.
Do you want to proceed? [Y/n]: 

Your new pipeline rest_api is ready to be customized!
* Review and change how dlt loads your data in rest_api_pipeline.py
* Add credentials for duckdb and other secrets in ./.dlt/secrets.toml
* Add the required dependencies to pyproject.toml:
  dlt[duckdb]>=1.9.0
  If the dlt dependency is already added, make sure you install the extra for duckdb to it
  If you are using poetry you may issue the following command:
  poetry add dlt -E duckdb

* Read https://dlthub.com/docs/walkthroughs/create-a-pipeline for more information
$ tree
.
├── .dlt
│   ├── config.toml
│   └── secrets.toml
├── .gitignore
├── README.md
├── main.py
├── pyproject.toml
└── rest_api_pipeline.py
```

### [パイプラインの実行](https://dlthub.com/docs/tutorial/rest-api#running-the-pipeline)

ドキュメントと異なり、`requirements.txt` はできていないので、出力されたとおり、`pyproject.toml` に依存関係を追加します。

```diff toml:pyproject.toml
@@ -4,4 +4,6 @@
 description = "Add your description here"
 readme = "README.md"
 requires-python = ">=3.12"
-dependencies = []
+dependencies = [
+    dlt[duckdb]>=1.9.0
+]
```

このまま動かすと github の rate 制限でエラーになるため、github をコメントアウトして実行する。

```diff py:rest_api_pipeline.py
@@ -149,5 +149,5 @@
 if __name__ == "__main__":
-    load_github()
+    # load_github()
     load_pokemon()
```

```
$ uv run rest_api_pipeline.py 
2025-04-06 08:11:11,321|[ERROR]|34180|140455832667968|dlt|utils.py|check_connection:21|Error checking connection: The following resources could not be found in source rest_api: {'not_existing_endpoint'}. Available resources are: {'location', 'pokemon', 'berry'}
2025-04-06 08:11:11,538|[WARNING]|34180|140455832667968|dlt|client.py|detect_paginator:312|Fallback paginator used: SinglePagePaginator at 7fbe5bb2aa50. Please provide right paginator manually.
Pipeline rest_api_pokemon load step completed in 0.17 seconds
1 load package(s) were loaded to destination duckdb and into dataset rest_api_data
The duckdb destination used duckdb:////home/ec2-user/work/mds/dlt-getting-started/rest-api/rest_api_pokemon.duckdb location to store data
Load package 1743927071.383116 is LOADED and contains no failed jobs
```

エラーや警告が出ているが、以下のとおり、1302 行が DuckDB に格納された。

```
$ ~/.duckdb/cli/latest/duckdb 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
D .open rest_api_pokemon.duckdb
D .tables
_dlt_loads           _dlt_version         location           
_dlt_pipeline_state  berry                pokemon            
D select * from rest_api_data.pokemon;
┌─────────────────────────────┬──────────────────────────────────────────┬───────────────────┬────────────────┐
│            name             │                   url                    │   _dlt_load_id    │    _dlt_id     │
│           varchar           │                 varchar                  │      varchar      │    varchar     │
├─────────────────────────────┼──────────────────────────────────────────┼───────────────────┼────────────────┤
│ bulbasaur                   │ https://pokeapi.co/api/v2/pokemon/1/     │ 1743927071.383116 │ x5YRTG/PnZDqLA │
│ ivysaur                     │ https://pokeapi.co/api/v2/pokemon/2/     │ 1743927071.383116 │ aOkyEKUQqT5I+g │
│ venusaur                    │ https://pokeapi.co/api/v2/pokemon/3/     │ 1743927071.383116 │ LSFAjHFmu3nksw │
│ charmander                  │ https://pokeapi.co/api/v2/pokemon/4/     │ 1743927071.383116 │ 9LH0ak/5YqWQ/Q │
│ charmeleon                  │ https://pokeapi.co/api/v2/pokemon/5/     │ 1743927071.383116 │ KbgLYyCcZmWBZg │
│ charizard                   │ https://pokeapi.co/api/v2/pokemon/6/     │ 1743927071.383116 │ HC8UYN6tXMi4LQ │
│ squirtle                    │ https://pokeapi.co/api/v2/pokemon/7/     │ 1743927071.383116 │ Jp9dJ61hn5neEQ │
│ wartortle                   │ https://pokeapi.co/api/v2/pokemon/8/     │ 1743927071.383116 │ 0b15UoCBQMu20Q │
│ blastoise                   │ https://pokeapi.co/api/v2/pokemon/9/     │ 1743927071.383116 │ q3XR4Zx3UiWTPQ │
│ caterpie                    │ https://pokeapi.co/api/v2/pokemon/10/    │ 1743927071.383116 │ h7Hs47VCSQpGaQ │
│ metapod                     │ https://pokeapi.co/api/v2/pokemon/11/    │ 1743927071.383116 │ Xib1OanrtXydsw │
│ butterfree                  │ https://pokeapi.co/api/v2/pokemon/12/    │ 1743927071.383116 │ wk79bEDFV7pgQQ │
│ weedle                      │ https://pokeapi.co/api/v2/pokemon/13/    │ 1743927071.383116 │ u8HsCI6QhFUtrw │
│ kakuna                      │ https://pokeapi.co/api/v2/pokemon/14/    │ 1743927071.383116 │ +6rbvqAFsFDTvw │
│ beedrill                    │ https://pokeapi.co/api/v2/pokemon/15/    │ 1743927071.383116 │ /txiUsIf0Kd/vQ │
│ pidgey                      │ https://pokeapi.co/api/v2/pokemon/16/    │ 1743927071.383116 │ j5wfFIfo1ZCVFQ │
│ pidgeotto                   │ https://pokeapi.co/api/v2/pokemon/17/    │ 1743927071.383116 │ rwCzjLbfmGyHrw │
│ pidgeot                     │ https://pokeapi.co/api/v2/pokemon/18/    │ 1743927071.383116 │ Q25KkTxI0cKF/w │
│ rattata                     │ https://pokeapi.co/api/v2/pokemon/19/    │ 1743927071.383116 │ 37qoBEd+yA2azQ │
│ raticate                    │ https://pokeapi.co/api/v2/pokemon/20/    │ 1743927071.383116 │ 9JZo2lO/tw7zow │
│    ·                        │                   ·                      │         ·         │       ·        │
│    ·                        │                   ·                      │         ·         │       ·        │
│    ·                        │                   ·                      │         ·         │       ·        │
│ tatsugiri-droopy            │ https://pokeapi.co/api/v2/pokemon/10258/ │ 1743927071.383116 │ glDbU62GwBf+Xw │
│ tatsugiri-stretchy          │ https://pokeapi.co/api/v2/pokemon/10259/ │ 1743927071.383116 │ L6/XzsIRwmSYCQ │
│ squawkabilly-blue-plumage   │ https://pokeapi.co/api/v2/pokemon/10260/ │ 1743927071.383116 │ ci2F5LvfTJG+AA │
│ squawkabilly-yellow-plumage │ https://pokeapi.co/api/v2/pokemon/10261/ │ 1743927071.383116 │ t7nsdzb8iq2Yig │
│ squawkabilly-white-plumage  │ https://pokeapi.co/api/v2/pokemon/10262/ │ 1743927071.383116 │ dhQevhXet2Ivng │
│ gimmighoul-roaming          │ https://pokeapi.co/api/v2/pokemon/10263/ │ 1743927071.383116 │ kvk7X9K0cgAPyQ │
│ koraidon-limited-build      │ https://pokeapi.co/api/v2/pokemon/10264/ │ 1743927071.383116 │ syWzCkYGTmxW4w │
│ koraidon-sprinting-build    │ https://pokeapi.co/api/v2/pokemon/10265/ │ 1743927071.383116 │ QLRg03EXUlxBSQ │
│ koraidon-swimming-build     │ https://pokeapi.co/api/v2/pokemon/10266/ │ 1743927071.383116 │ KgMSLmMgVUEYng │
│ koraidon-gliding-build      │ https://pokeapi.co/api/v2/pokemon/10267/ │ 1743927071.383116 │ Gr2Q9K9iteTejw │
│ miraidon-low-power-mode     │ https://pokeapi.co/api/v2/pokemon/10268/ │ 1743927071.383116 │ bIkyu2abvRVECA │
│ miraidon-drive-mode         │ https://pokeapi.co/api/v2/pokemon/10269/ │ 1743927071.383116 │ UfBO+4Mfxw293w │
│ miraidon-aquatic-mode       │ https://pokeapi.co/api/v2/pokemon/10270/ │ 1743927071.383116 │ Mr5sNDwmjyv70g │
│ miraidon-glide-mode         │ https://pokeapi.co/api/v2/pokemon/10271/ │ 1743927071.383116 │ P7HIoBde+8ytgg │
│ ursaluna-bloodmoon          │ https://pokeapi.co/api/v2/pokemon/10272/ │ 1743927071.383116 │ w70EJa8XFs6Rgw │
│ ogerpon-wellspring-mask     │ https://pokeapi.co/api/v2/pokemon/10273/ │ 1743927071.383116 │ 2Z7lu3PHgNQPYw │
│ ogerpon-hearthflame-mask    │ https://pokeapi.co/api/v2/pokemon/10274/ │ 1743927071.383116 │ pZWubGPwSSsKxQ │
│ ogerpon-cornerstone-mask    │ https://pokeapi.co/api/v2/pokemon/10275/ │ 1743927071.383116 │ 6YNuuUZuJVz3Cg │
│ terapagos-terastal          │ https://pokeapi.co/api/v2/pokemon/10276/ │ 1743927071.383116 │ +5y8clVXDqV7eQ │
│ terapagos-stellar           │ https://pokeapi.co/api/v2/pokemon/10277/ │ 1743927071.383116 │ K9TmDZyyMsyynA │
├─────────────────────────────┴──────────────────────────────────────────┴───────────────────┴────────────────┤
│ 1302 rows (40 shown)                                                                              4 columns │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
D .exit
```

### [データの調査](https://dlthub.com/docs/tutorial/rest-api#exploring-the-data)

```
$ uv add streamlit
Resolved 72 packages in 388ms
Prepared 13 packages in 977ms
Installed 21 packages in 38ms
:
 + watchdog==6.0.0
$ uv run dlt pipeline rest_api_pokemon show
Found pipeline rest_api_pokemon in /home/ec2-user/.dlt/pipelines

Collecting usage statistics. To deactivate, set browser.gatherUsageStats to false.


  You can now view your Streamlit app in your browser.

  Local URL: http://localhost:8501
  Network URL: http://10.48.149.30:8501
  External URL: http://18.178.73.138:8501
```

### [データの置換](https://dlthub.com/docs/tutorial/rest-api#replacing-the-data)

```diff py:rest_api_pipeline.py
@@ -125,6 +125,7 @@
                         "limit": 1000,
                     },
                 },
+                "write_disposition": "replace", # Setting the write disposition to `replace
             },
             "resources": [
                 "pokemon",
```

### [データのマージ](https://dlthub.com/docs/tutorial/rest-api#merging-the-data)

```diff py:rest_api_pipeline.py
@@ -125,10 +125,20 @@ def load_pokemon() -> None:
                         "limit": 1000,
                     },
                 },
-                "write_disposition": "replace", # Setting the write disposition to `replace
+                # For the `berry` and `location` resources, we keep
+                # the `replace` write disposition
+                "write_disposition": "replace",
             },
             "resources": [
-                "pokemon",
+                # We create a specific configuration for the `pokemon` resource
+                # using a dictionary instead of a string to configure
+                # the primary key and write disposition
+                {
+                    "name": "pokemon",
+                    "primary_key": "name",
+                    "write_disposition": "merge",
+                },
+                # The `berry` and `location` resources will use the default
                 "berry",
                 "location",
             ],
```

```
$ uv run rest_api_pipeline.py 
2025-04-07 05:37:43,399|[ERROR]|31535|140519944869696|dlt|utils.py|check_connection:21|Error checking connection: The following resources could not be found in source rest_api: {'not_existing_endpoint'}. Available resources are: {'location', 'pokemon', 'berry'}
2025-04-07 05:37:43,602|[WARNING]|31535|140519944869696|dlt|client.py|detect_paginator:312|Fallback paginator used: SinglePagePaginator at 7fcd30ed1f10. Please provide right paginator manually.
Pipeline rest_api_pokemon load step completed in 0.24 seconds
1 load package(s) were loaded to destination duckdb and into dataset rest_api_data
The duckdb destination used duckdb:////home/ec2-user/work/mds/dlt-getting-started/rest-api/rest_api_pokemon.duckdb location to store data
Load package 1744004263.47209 is LOADED and contains no failed jobs
$ ~/.duckdb/cli/latest/duckdb 
v1.2.1 8e52ec4395
Enter ".help" for usage hints.
Connected to a transient in-memory database.
Use ".open FILENAME" to reopen on a persistent database.
D .open rest_api_pokemon.duckdb
D select database_name, schema_name, table_name from duckdb_tables;
┌──────────────────┬───────────────────────┬─────────────────────┐
│  database_name   │      schema_name      │     table_name      │
│     varchar      │        varchar        │       varchar       │
├──────────────────┼───────────────────────┼─────────────────────┤
│ rest_api_pokemon │ rest_api_data         │ berry               │
│ rest_api_pokemon │ rest_api_data         │ location            │
│ rest_api_pokemon │ rest_api_data         │ pokemon             │
│ rest_api_pokemon │ rest_api_data         │ _dlt_loads          │
│ rest_api_pokemon │ rest_api_data         │ _dlt_pipeline_state │
│ rest_api_pokemon │ rest_api_data         │ _dlt_version        │
│ rest_api_pokemon │ rest_api_data_staging │ pokemon             │
│ rest_api_pokemon │ rest_api_data_staging │ _dlt_version        │
└──────────────────┴───────────────────────┴─────────────────────┘
D .exit
```

### [データのインクリメンタルなロード](https://dlthub.com/docs/tutorial/rest-api#loading-data-incrementally)

github は rate 制限でエラーになるため、スキップ

## [SQL DB](https://dlthub.com/docs/tutorial/sql-database)

同様に、uv のワークスペースのメンバーとしてプロジェクトを作成します。



## [File System](https://dlthub.com/docs/tutorial/filesystem)


# おわりに
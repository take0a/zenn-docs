---
title: "NestJSã§RESTï¼ˆãã®ï¼”ï¼‰"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["nestjs", "rest", "postgresql", "nodejs", "typescript"]
published: true
publication_name: "robon"
---
# å‰å›ã¾ã§

https://zenn.dev/robon/articles/f5e5907aa871a5

ä¸€æ—¦ã€å‹•ãã¾ã—ãŸã€‚ğŸ‘

# ä»•ä¸Šã’
## è¨­å®šãŒä¸¸è¦‹ãˆ

Node.jsã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚ˆãã‚ã‚‹ã‚ˆã†ãª.envã«ã—ã¾ã™ã€‚

```.env.dev
DB_HOST=host
DB_USER=user
DB_PASS=pass
```

### @nestjs/configã®å°å…¥ã¨è¨­å®š

```bash
$ npm i --save @nestjs/config
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ããŸã‚‰ã€app.modules.tsã‚’å¤‰æ›´ã—ã¦ãŠè¦‹ã›ã§ãã‚‹çŠ¶æ…‹ã«ã—ã¾ã™ã€‚

```ts: app.modules.ts
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { CustomersModule } from './customers/customers.module';
import { Customer } from './customers/entities/customer.entity';

@Module({
  imports: [
    ConfigModule.forRoot({
      envFilePath: '.env.dev',
    }),
    TypeOrmModule.forRootAsync({
      imports: [ConfigModule],
      useFactory: (configService: ConfigService) => ({
        type: 'postgres',
        host: configService.get('DB_HOST'),
        port: 5432,
        username: configService.get('DB_USER'),
        password: configService.get('DB_PASS'),
        database: 'postgres',
        entities: [Customer],
        logging: true,
        synchronize: false,
      }),
      inject: [ConfigService],
    }),
    CustomersModule,
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«èª¬æ˜ãŒã‚ã‚Šã¾ã™ãŒã€forRootã‹ã‚‰forRootAsyncã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚

https://docs.nestjs.com/techniques/database


## æœ€åˆã«ã‚„ã‚ŠãŸã‹ã£ãŸã“ã¨

æœ€åˆã«ã‚„ã‚ŠãŸã‹ã£ãŸå…¨ä½“åƒã¯ã€ãã®ï¼‘ã‚’å‚ç…§ãã ã•ã„ã€‚

https://zenn.dev/robon/articles/76d4ec767b72ae

### productsã®è¿½åŠ 

ç‹¬ç«‹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£å˜ä½“ãªã®ã§ã€customersã¨åŒæ§˜ã«ä½œã‚‹ã ã‘ã§ã™ã€‚

### ordersã®è¿½åŠ 

ã¾ãšã€Entiryã§ã™ãŒã€OneToManyã¨ManyToOneã®é–¢é€£ã‚’ä½œæˆã—ã¾ã—ãŸã€‚ï¼ˆã‚ã¨ã§ã€ã„ã‚ã„ã‚ã†ã¾ãã„ã‹ãªãã¦å¤‰æ›´ã™ã‚‹ã®ã§ã™ãŒã€ã“ã®æŒ‡å®šã¯æ§˜ã€…ãªãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è©¦ã—ã¾ã—ãŸã€‚ï¼‰

```ts: orders/entities/order.entity.ts
import {
  Entity,
  Column,
  PrimaryColumn,
  OneToMany,
  ManyToOne,
  JoinColumn,
} from 'typeorm';

@Entity({ name: 'order_header' })
export class Order {
  @PrimaryColumn({ name: 'order_id' })
  orderId: number;

  @Column({ name: 'customer_id' })
  customerId: number;

  @Column({ name: 'order_date' })
  orderDate: string;

  @OneToMany(() => OrderDetail, (detail) => detail.header, {
    eager: true,
    cascade: true,
  })
  details: OrderDetail[];
}

@Entity({ name: 'order_detail' })
export class OrderDetail {
  @PrimaryColumn({ name: 'order_id' })
  orderId: number;

  @PrimaryColumn({ name: 'row_number' })
  rowNumber: number;

  @Column({ name: 'product_id' })
  productId: number;

  @Column()
  quantity: number;

  @Column({ name: 'price_per_unit' })
  pricePerUnit: number;

  @ManyToOne(() => Order, (header) => header.details)
  @JoinColumn({ name: 'order_id' })
  header?: Order;
}
```

ãã—ã¦ã€Serviceã¯ã€updateã‚’saveã«ã€deleteã‚’removeã«å¤‰æ›´ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ä¸€è¦‹ã™ã‚‹ã¨å‹•ãã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

```ts: orders/orders.service.ts
import {
  Injectable,
  NotFoundException,
  InternalServerErrorException,
} from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { CreateOrderDto } from './dto/create-order.dto';
import { UpdateOrderDto } from './dto/update-order.dto';
import { Order } from './entities/order.entity';

@Injectable()
export class OrdersService {
  constructor(
    @InjectRepository(Order)
    private ordersRepository: Repository<Order>,
  ) {}

  async create(createOrderDto: CreateOrderDto): Promise<Order> {
    return await this.ordersRepository.save(createOrderDto).catch((e) => {
      throw new InternalServerErrorException(e.message);
    });
  }

  async findAll(): Promise<Order[]> {
    return await this.ordersRepository.find({}).catch((e) => {
      throw new InternalServerErrorException(e.message);
    });
  }

  async findOne(id: number): Promise<Order> {
    const order = await this.ordersRepository.findOneBy({
      orderId: id,
    });
    if (!order) {
      throw new NotFoundException(`Order not found (${id})`);
    }
    return order;
  }

  async update(id: number, updateOrderDto: UpdateOrderDto): Promise<Order> {
    return await this.ordersRepository.save(updateOrderDto).catch((e) => {
      throw new InternalServerErrorException(e.message);
    });
  }

  async remove(id: number): Promise<void> {
    const order = await this.ordersRepository.findOneBy({
      orderId: id,
    });
    if (!order) {
      throw new NotFoundException(`Order not found (${id})`);
    }
    await this.ordersRepository.remove([order]);
    return;
  }
}
```

logging: trueã§å‹•ã‹ã—ã¦ã„ãŸã®ã§ã€removeã§order_detailãƒ†ãƒ¼ãƒ–ãƒ«ã®DELETEæ–‡ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ã“ã¨ã«æ°—ãŒã¤ãã¾ã—ãŸã€‚ã“ã®ãŸã‚ã€cascadeã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¸­å¿ƒã«æ§˜ã€…ãªãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è©¦ã—ãŸã®ã§ã™ãŒã€ã†ã¾ãè¡Œãã¾ã›ã‚“ã§ã—ãŸã€‚
ï¼ˆãªã«ã‹æ–¹æ³•ã‚’ã”å­˜çŸ¥ã®æ–¹ãŠã—ãˆã¦ãã ã•ã„ã€‚ãŸã ã—ã€onDelete: 'CASCADE'ã§DBã«ã‚„ã‚‰ã›ã‚‹ã®ã¯ãƒŠã‚·ã§ã™ï¼‰

ä»•æ–¹ãªã„ã®ã§ã€Transactionã‚’ä½¿ã£ã¦æ˜ç¤ºçš„ã«removeã—ã¦ã¿ã¾ã—ãŸã€‚

```diff ts: orders/orders.service.ts
@@ -51,7 +52,20 @@ export class OrdersService {
     if (!order) {
       throw new NotFoundException(`Order not found (${id})`);
     }
-    await this.ordersRepository.remove([order]);
+
+    const queryRunner = this.dataSource.createQueryRunner();
+    await queryRunner.connect();
+    await queryRunner.startTransaction();
+    try {
+      await queryRunner.manager.remove(order.details);
+      await queryRunner.manager.remove(order);
+      await queryRunner.commitTransaction();
+    } catch (e) {
+      await queryRunner.rollbackTransaction();
+      throw new InternalServerErrorException(e.message);
+    } finally {
+      await queryRunner.release();
+    }
     return;
   }
 }
```

ã“ã‚Œã§ã€æ¶ˆãˆã‚‹ã®ã§ã™ãŒã€ä»Šåº¦ã¯ç„¡é§„ãªSELECTæ–‡ãŒå‘¼ã³å‡ºã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ°—ã¥ãã¾ã™ã€‚ã“ã®ãŸã‚ã€removeã‚’deleteã«æˆ»ã—ã¦ã€ä»¥ä¸‹ã‚’æœ€çµ‚å½¢ã«ã—ã¾ã—ãŸã€‚

```diff ts: orders/orders.service.ts
@@ -45,20 +45,14 @@ export class OrdersService {
     });
   }
 
-  async remove(id: number): Promise<void> {
-    const order = await this.ordersRepository.findOneBy({
-      orderId: id,
-    });
-    if (!order) {
-      throw new NotFoundException(`Order not found (${id})`);
-    }
-
+  async remove(id: number): Promise<DeleteResult> {
     const queryRunner = this.dataSource.createQueryRunner();
     await queryRunner.connect();
     await queryRunner.startTransaction();
+    let result: DeleteResult;
     try {
-      await queryRunner.manager.remove(order.details);
-      await queryRunner.manager.remove(order);
+      await queryRunner.manager.delete(OrderDetail, { orderId: id });
+      result = await queryRunner.manager.delete(Order, { orderId: id });
       await queryRunner.commitTransaction();
     } catch (e) {
       await queryRunner.rollbackTransaction();
@@ -66,6 +60,9 @@ export class OrdersService {
     } finally {
       await queryRunner.release();
     }
-    return;
+    if (!result.affected) {
+      throw new NotFoundException(`Order not found (${id})`);
+    }
+    return result;
   }
 }
```

# æœ€å¾Œã«

ä»Šå›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã€ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚

https://github.com/take0a/nestjs-sample
